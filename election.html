<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>金門縣歷年選舉資料查詢</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; }
    select { margin: 5px; padding: 5px; }
  </style>
</head>
<body>
  <h1>金門縣歷年選舉資料查詢</h1>

  <div>
    <label>年份: </label>
    <select id="yearSelect"><option value="">請選擇</option></select>
    
    <label>選舉類別: </label>
    <select id="typeSelect"><option value="">請選擇</option></select>
  </div>
  
  <div>
    <label>鄉鎮: </label>
    <select id="townshipSelect"><option value="">全部</option></select>
    
    <label>村里: </label>
    <select id="villageSelect"><option value="">全部</option></select>
  </div>
  
  <button id="filterBtn">查詢</button>
  
  <table id="resultTable">
    <thead>
      <tr>
        <th>鄉鎮</th>
        <th>村里</th>
        <th>候選人</th>
        <th>號次</th>
        <th>得票數</th>
        <th>得票率</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  
  <canvas id="voteChart" style="max-width:600px;margin-top:20px;"></canvas>

  <script>
    const electionFiles = [
      {year: 1995, type: '立法委員', file: 'data/1995年立委選舉.xlsx'},
      {year: 2022, type: '縣議員', file: 'data/2022_縣議員.xlsx'},
      {year: 2018, type: '縣長', file: 'data/2018_縣長.xlsx'},
      {year: 2018, type: '縣議員', file: 'data/2018_縣議員.xlsx'}
    ];

    let rawData = [];
    let chartInstance = null;

    const yearSelect = document.getElementById('yearSelect');
    const typeSelect = document.getElementById('typeSelect');
    const townshipSelect = document.getElementById('townshipSelect');
    const villageSelect = document.getElementById('villageSelect');
    const resultTable = document.getElementById('resultTable').querySelector('tbody');
    const voteChart = document.getElementById('voteChart').getContext('2d');

    // 填充年份選單
    const years = [...new Set(electionFiles.map(f=>f.year))];
    yearSelect.innerHTML += years.map(y=>`<option value="${y}">${y}</option>`).join('');

    yearSelect.addEventListener('change', updateTypeSelect);
    typeSelect.addEventListener('change', loadElectionData);

    townshipSelect.addEventListener('change', updateVillageSelect);

    document.getElementById('filterBtn').addEventListener('click', filterAndDisplay);

    function updateTypeSelect(){
      const selectedYear = parseInt(yearSelect.value);
      const types = [...new Set(electionFiles.filter(f=>f.year===selectedYear).map(f=>f.type))];
      typeSelect.innerHTML = '<option value="">請選擇</option>' + types.map(t=>`<option value="${t}">${t}</option>`).join('');
      // 清空村里和鄉鎮
      townshipSelect.innerHTML = '<option value="">全部</option>';
      villageSelect.innerHTML = '<option value="">全部</option>';
      rawData = [];
      resultTable.innerHTML = '';
      if(chartInstance) chartInstance.destroy();
    }

    function loadElectionData(){
      const selectedYear = parseInt(yearSelect.value);
      const selectedType = typeSelect.value;
      if(!selectedYear || !selectedType) return;
      
      const fileObj = electionFiles.find(f=>f.year===selectedYear && f.type===selectedType);
      if(!fileObj) return;
      
      fetch(fileObj.file)
        .then(res => res.arrayBuffer())
        .then(data => {
          const workbook = XLSX.read(data, {type:'array'});
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          rawData = XLSX.utils.sheet_to_json(worksheet, {range:1}); // 從第2行開始
          
          // 填充鄉鎮選單
          const townships = [...new Set(rawData.map(r=>r['鄉鎮']))];
          townshipSelect.innerHTML = '<option value="">全部</option>' + townships.map(t=>`<option value="${t}">${t}</option>`).join('');
          villageSelect.innerHTML = '<option value="">全部</option>';
          
          resultTable.innerHTML = '';
          if(chartInstance) chartInstance.destroy();
        })
        .catch(err => console.error('讀取 XLSX 失敗:', err));
    }

    function updateVillageSelect(){
      const selectedTown = townshipSelect.value;
      const villages = [...new Set(rawData.filter(r=>!selectedTown || r['鄉鎮']===selectedTown).map(r=>r['村里']))];
      villageSelect.innerHTML = '<option value="">全部</option>' + villages.map(v=>`<option value="${v}">${v}</option>`).join('');
    }

    function filterAndDisplay(){
      const selectedTown = townshipSelect.value;
      const selectedVillage = villageSelect.value;
      
      const filtered = rawData.filter(r=>{
        return (!selectedTown || r['鄉鎮']===selectedTown) &&
               (!selectedVillage || r['村里']===selectedVillage);
      });
      
      // 更新表格
      resultTable.innerHTML = filtered.map(r=>`
        <tr>
          <td>${r['鄉鎮']}</td>
          <td>${r['村里']}</td>
          <td>${r['候選人']}</td>
          <td>${r['候選人號次']}</td>
          <td>${r['得票數']}</td>
          <td>${r['該村里得票率']}</td>
        </tr>
      `).join('');
      
      // 更新圖表
      if(chartInstance) chartInstance.destroy();
      chartInstance = new Chart(voteChart, {
        type: 'bar',
        data: {
          labels: filtered.map(r=>r['候選人']),
          datasets: [{
            label: '得票數',
            data: filtered.map(r=>r['得票數']),
            backgroundColor: 'rgba(54, 162, 235, 0.6)'
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } }
        }
      });
    }
  </script>
</body>
</html>
