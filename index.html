<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote for Kinmenï¸±é‡‘é–€é¸èˆ‰å„€è¡¨æ¿</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #3887B0;
            --secondary: #2c3e50; 
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --border: #e1e4e8;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        
        body { 
            font-family:'Noto Sans TC', sans-serif; 
            background:var(--bg); 
            color:var(--text-main); 
            line-height:1.6; 
            padding-bottom: 20px; 
            padding-top: 60px; 
        }
        
        /* --- å„ªåŒ–å¾Œçš„ Header --- */
        header { 
            background: linear-gradient(135deg, var(--secondary) 0%, #1a252f 100%);
            color: white; 
            padding: 12px 20px; 
            text-align: center; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            position: fixed; 
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000; 
        }
        
        h1 { font-size: 20px; font-weight: 700; margin: 0; letter-spacing: 0.5px; }
        h1 span { cursor: pointer; } 
        
        .container { max-width: 1200px; margin: 25px auto; padding: 0 15px; }
        
        /* --- ä¸»é¸å–®æ¨£å¼ --- */
        .main-menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); 
            gap: 16px; 
            margin-bottom: 50px;
        }

        .menu-button {
            background: var(--card-bg);
            border: 1px solid transparent; 
            border-radius: 12px; 
            padding: 18px 15px; 
            text-align: center;
            font-size: 16px; 
            font-weight: 600; 
            color: var(--secondary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); 
            box-shadow: 0 4px 6px rgba(0,0,0,0.04); 
            position: relative;
            overflow: hidden;
            line-height: 1.4;
        }
        
        .menu-button::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary);
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .menu-button:hover {
            border-color: rgba(56, 135, 176, 0.3);
            background: #fff;
            color: var(--primary);
            transform: translateY(-4px); 
            box-shadow: 0 12px 20px rgba(56, 135, 176, 0.15); 
        }
        
        .menu-button:hover::before { opacity: 1; }
        
        .menu-section-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        /* --- é¸èˆ‰åˆ—è¡¨ --- */
        .election-list-grid {
             display: grid;
             grid-template-columns: repeat(2, 1fr); 
             gap: 20px;
             margin-top: 20px;
        }
        
        /* --- å°è¦½åˆ— --- */
        .breadcrumb { margin-bottom: 20px; font-size: 16px; color: var(--text-sub); padding: 10px 0; }
        #breadcrumb-bottom { margin-top: 40px; border-top: 1px solid var(--border); padding-top: 20px; }
        .breadcrumb span { cursor: pointer; color: var(--primary); font-weight: 500; }
        .breadcrumb span:hover { text-decoration: underline; }
        .breadcrumb span.active { color: var(--text-main); cursor: default; text-decoration: none; }
        
        .main-section { margin-bottom: 40px; }
        .section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--border); }
        .section-title { font-size: 22px; font-weight: 700; color: var(--text-main); }
        .section-badge { background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 13px; }

        /* --- å¡ç‰‡ç¾åŒ– --- */
        .card { 
            background: var(--card-bg); 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.06); 
            padding: 20px; 
            overflow: hidden; 
            border: 1px solid rgba(0,0,0,0.02); 
            transition: all 0.3s ease; 
            margin-bottom: 0; 
        }
        .card.clickable { cursor: pointer; }
        .card.clickable:hover { transform: translateY(-3px); border-color: var(--primary); box-shadow: 0 8px 15px rgba(56, 135, 176, 0.15); }
        
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 15px; 
            overflow: hidden; 
        }
        .card-header-left { 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 1; 
            min-width: 0;
        }
        
        .card-title { font-size: 18px; font-weight: 700; color: var(--text-main); border-left: 4px solid var(--primary); padding-left: 10px; line-height: 1.2; }
        
        .card-stats { 
            font-size: 13px; 
            color: var(--text-main);
            margin-top: 5px; 
            margin-left: 14px; 
            font-weight: 500; 
            line-height: 1.8; 
        }
        
        .card-stats strong { font-weight: 500; color: var(--text-main); }
        .card-stats .rate { color: #d9534f; font-weight: 700; }
        
        .card.is-summary .card-stats {
            margin-top: 5px;
            margin-left: 14px;
            font-size: 14px; 
            line-height: 1.5;
            color: var(--text-main);
        }
        .card.is-summary .card-stats strong { color: var(--text-main); font-weight: 500; }
        .card.is-summary .card-stats .rate { color: #d9534f; }

        .card-action { 
            font-size: 14px; 
            color: var(--primary); 
            font-weight: 500; 
            white-space: nowrap; 
            margin-left: 10px; 
            flex-shrink: 0; 
            align-self: flex-start;
            padding-top: 2px;
        }

        .layout-full { display: grid; grid-template-columns: 300px 1fr; gap: 25px; align-items: start; }
        .layout-full .chart-area { height: 250px; width: 100%; position: relative; }

        .sub-area-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(480px, 1fr)); gap: 15px; }
        
        .layout-compact { display: flex; align-items: flex-start; gap: 20px; }
        .layout-compact .chart-area { 
            flex: 0 0 130px; 
            width: 130px; 
            height: 130px; 
            position: relative; 
            margin-top: 10px; 
        }
        .layout-compact .table-area { flex: 1; min-width: 0; }

        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; table-layout: auto; } 
        th { 
            background: #f8f9fa; 
            color: #666; 
            font-weight: 600; 
            text-align: left; 
            padding: 6px 8px; 
            border-bottom: 2px solid var(--border); 
            white-space: nowrap; 
            font-size: 13px; 
            cursor: pointer; 
            position: relative; 
        }
        th:hover { background: #e9ecef; }
        td { padding: 8px 8px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        
        .layout-compact table th:nth-child(1),
        .layout-compact table td:nth-child(1) { width: 40px; text-align: center; } 
        
        .layout-compact table th:nth-child(4),
        .layout-compact table td:nth-child(4) { 
            text-align: right; 
            min-width: 80px; 
        } 
        
        .layout-compact table th:nth-child(5),
        .layout-compact table td:nth-child(5) { 
            width: 60px; 
            min-width: 60px; 
            text-align: right; 
        }

        td.number-cell { text-align: center; }
        
        .sort-icon {
            display: inline-block; width: 0; height: 0; margin-left: 5px; vertical-align: middle; border-left: 4px solid transparent; border-right: 4px solid transparent; opacity: 0.3; 
        }
        .sort-icon.asc { border-bottom: 4px solid #333; opacity: 1; }
        .sort-icon.desc { border-top: 4px solid #333; opacity: 1; }
        
        .number-badge {
            display: inline-block; width: 24px; height: 24px; line-height: 24px; text-align: center; background: #eee; border-radius: 50%; font-weight: 700; font-size: 13px; color: #555; vertical-align: middle;
        }

        .party-badge { font-size: 11px; padding: 2px 6px; border-radius: 8px; color: white; background: #999; white-space: nowrap; }
        
        .party-cell .party-short { display: none; }

        table.large-table { font-size: 17px; table-layout: auto; }
        table.large-table th { padding: 10px 10px; font-size: 14px; }
        table.large-table td { padding: 10px 10px; }
        table.large-table .number-badge { width: 26px; height: 26px; line-height: 26px; font-size: 14px; }
        table.large-table .party-badge { font-size: 12px; }

        .vote-cell-content { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; }
        .bar-container { height: 5px; background: #f0f0f0; border-radius: 3px; overflow: hidden; width: 100%; max-width: 80px; }
        .bar-fill { height: 100%; border-radius: 3px; }
        
        .loading-state { text-align: center; padding: 60px; color: var(--text-sub); font-size: 18px; }

        /* --- æ‰‹æ©Ÿç‰ˆ RWD é‡å°æ€§èª¿æ•´ (ä¿®å¾©åˆ‡é‚Šå•é¡Œ) --- */
        @media (max-width: 768px) {
             /* 1. æ‰‹æ©Ÿç‰ˆé¸å–®æ”¹ç‚ºã€Œé›™æ¬„ã€ */
             .main-menu-grid {
                 grid-template-columns: repeat(2, 1fr); 
                 gap: 12px;
             }
             
             .menu-button {
                 padding: 15px 10px; 
                 font-size: 15px;
             }
             
             /* 2. å¡ç‰‡å·¦å³å…§è·æ¸›å°‘ï¼Œçˆ­å–ç©ºé–“ */
             .card { padding: 15px 10px; }

             .election-list-grid { grid-template-columns: 1fr; }
             
             .layout-compact { flex-direction: column; align-items: center; }
             .layout-compact .chart-area { width: 140px; height: 140px; flex: none; margin-bottom: 10px; }
             .layout-compact .table-area { width: 100%; }

             /* 3. è¡¨æ ¼ç˜¦èº«ï¼šå­—é«”èˆ‡å…§è·å¤§å¹…ç¸®å° */
             table, table.large-table { font-size: 13px; }
             
             /* å¼·åˆ¶ç¸®å°æ‰€æœ‰æ¬„ä½çš„å…§è· */
             th, td, 
             table.large-table th, table.large-table td { 
                 padding: 6px 2px !important; /* æ¥µé™ç¸®å°å…§è· */
             }
             
             /* æ”¿é»¨æ¬„ä½ç‰¹æ®Šè™•ç† */
             .party-cell .party-long { display: none; }
             .party-cell .party-short { display: inline-block; }
             .party-badge { font-size: 10px; padding: 2px 4px; }

             /* é‡å°ã€Œæ¨è–¦æ”¿é»¨ã€å››å€‹å­—é€²è¡Œå­—é«”å¾®èª¿ï¼Œé¿å…æ’å¤ªé–‹ */
             .layout-compact table th:nth-child(3) {
                 font-size: 12px;
                 letter-spacing: -1px; /* ç¨å¾®æ“ å£“å­—è· */
             }

             /* è™Ÿç¢¼æ¬„ */
             .layout-compact table th:nth-child(1),
             .layout-compact table td:nth-child(1) { width: 25px; padding-left: 0; }
             
             /* å¾—ç¥¨æ•¸æ¬„ */
             .layout-compact table th:nth-child(4),
             .layout-compact table td:nth-child(4) { 
                 min-width: 55px; /* ç¨å¾®ç¸®å° */
             }
             .bar-container { max-width: 40px; }
             
             /* ä¿®æ­£ï¼šå¾—ç¥¨ç‡æ¬„ä½å¼·åˆ¶ä¸åˆ‡é‚Š */
             .layout-compact table th:nth-child(5),
             .layout-compact table td:nth-child(5) { 
                 width: 45px; 
                 min-width: 45px; 
                 padding-right: 0 !important; /* è²¼é½Šæœ€å³é‚Š */
             }
             
             .section-title { font-size: 20px; }
             
             /* èª¿æ•´å¤§è¡¨æ ¼å…§æ•¸å­—çƒçš„å¤§å° */
             table.large-table .number-badge { width: 20px; height: 20px; line-height: 20px; font-size: 12px; }
             .number-badge { width: 20px; height: 20px; line-height: 20px; font-size: 12px; }
        }
        
        /* --- é å°¾ç¸½é«”æ¨£å¼ --- */
        footer {
            padding: 20px 15px;
            margin-top: 40px; 
            border-top: 1px solid var(--border); 
            background: #fafafa; 
            text-align: center; 
            font-size: 12px; 
            color: #999; 
            line-height: 1.6;
        }

        @media (min-width: 769px) {
            #footer-source { display: inline; }
        }
    </style>
</head>
<body>

<header>
    <h1><span onclick="renderMainMenu()">Vote for Kinmenï¸±é‡‘é–€é¸èˆ‰å„€è¡¨æ¿</span></h1>
</header>

<div class="container">
    <div id="breadcrumb" class="breadcrumb" style="display:none;"></div>
    
    <div id="content">
        <div class="loading-state">è³‡æ–™è¼‰å…¥ä¸­...</div>
    </div>

    <div id="breadcrumb-bottom" class="breadcrumb" style="display:none;"></div>
</div>

<footer>
    <span id="footer-source">v3.6 ï¸± è³‡æ–™ä¾†æºï¼šä¸­é¸æœƒé¸èˆ‰è³‡æ–™åº«</span>
</footer>

<script>
    // ================= æ•¸æ“šèˆ‡è¨­å®šå€ =================
    
    const availableElections = [
        { 
            file: "2024_ç¸½çµ±å‰¯ç¸½çµ±.csv", 
            year: "2024", 
            type: "ç¸½çµ±å‰¯ç¸½çµ±", 
            uiName: "2024å¹´ ç¸½çµ±å‰¯ç¸½çµ±é¸èˆ‰",
            summaryData: null 
        },
        { 
            file: "2024_ç«‹æ³•å§”å“¡.csv", 
            year: "2024", 
            type: "ç«‹æ³•å§”å“¡", 
            uiName: "2024å¹´ ç«‹æ³•å§”å“¡é¸èˆ‰",
            summaryData: null
        }
    ];
    
    const electionCategories = [
        { type: "ç¸½çµ±å‰¯ç¸½çµ±", icon: "" },
        { type: "ç«‹æ³•å§”å“¡", icon: "" },
        { type: "åœ‹å¤§ä»£è¡¨", icon: "" },
        { type: "ç¸£é•·", icon: "" },
        { type: "ç¸£è­°å“¡", icon: "" },
        { type: "é„‰é®é•·", icon: "" },
        { type: "é„‰é®æ°‘ä»£è¡¨", icon: "" },
        { type: "æ‘é‡Œé•·", icon: "" }
    ];

    const partyColors = {
        "ä¸­åœ‹åœ‹æ°‘é»¨": "#3887B0",
        "æ°‘ä¸»é€²æ­¥é»¨": "#67C167", 
        "å°ç£æ°‘çœ¾é»¨": "#28C8C8",
        "è¦ªæ°‘é»¨": "#F27C00",
        "æ–°é»¨": "#F0C800",
        "ç„¡é»¨ç±": "#777777", 
        "default": "#7f8c8d"
    };

    function getPartyColor(party) {
        return partyColors[party] || partyColors['default'];
    }

    function getShortPartyName(party) {
        const shortNames = {
            "ä¸­åœ‹åœ‹æ°‘é»¨": "åœ‹æ°‘é»¨",
            "æ°‘ä¸»é€²æ­¥é»¨": "æ°‘é€²é»¨",
            "å°ç£æ°‘çœ¾é»¨": "æ°‘çœ¾é»¨",
            "è¦ªæ°‘é»¨": "è¦ªæ°‘é»¨", 
            "æ–°é»¨": "æ–°é»¨", 
            "ç„¡é»¨ç±": "ç„¡é»¨ç±",
            "default": "ç„¡"
        };
        return shortNames[party] || party;
    }

    const dom = {
        content: document.getElementById("content"),
        breadcrumb: document.getElementById("breadcrumb"),
        breadcrumbBottom: document.getElementById("breadcrumb-bottom"),
        header: document.querySelector('header')
    };

    let appState = {
        data: {},
        countyMetadata: {}, 
        currentLevel: 'mainMenu', 
        currentTown: null,
        chartInstances: [], 
        sortConfig: { key: 'number', direction: 'asc' }, 
        globalTotalVotes: 0,
        electionName: "é¸èˆ‰è³‡æ–™" 
    };

    // ================= è³‡æ–™è¼‰å…¥èˆ‡è§£æ =================
    
    function parseCSV(text) {
        const rows = text.split('\n').map(r => r.trim()).filter(r => r).map(r => r.split(','));

        if (rows.length < 4) return;

        const headerRowIndices = []; 
        let currentIdx = 2;
        while(rows[0][currentIdx] && rows[1][currentIdx]) {
            headerRowIndices.push(currentIdx);
            currentIdx++;
        }
        
        const candInfo = [];
        
        headerRowIndices.forEach(colIndex => {
            const number = rows[0][colIndex] ? rows[0][colIndex].trim() : '';
            let name = rows[1][colIndex] ? rows[1][colIndex].trim() : '';
            let party = rows[2][colIndex] ? rows[2][colIndex].trim() : '';
            
            const isWinner = name.includes('*'); 
            name = name.replace('*', '').trim(); 
            
            party = party === 'ç„¡' ? 'ç„¡é»¨ç±' : party;

            if (name && number) {
                candInfo.push({ number: String(number), name, party, colIndex, isWinner }); 
            }
        });

        const candidates = {}; 
        const towns = {};
        const townOrder = [];
        let globalValidVotes = 0; 
        let globalInvalidVotes = 0; 
        let globalEligibleVoters = 0; 
        
        const VOTES_COL = 5;
        const INVALID_COL = 6;
        const ELIGIBLE_COL = 7;

        for (let i = 3; i < rows.length; i++) {
            const row = rows[i];
            
            if (row.length < 8 || !row[0] || row[0].includes("é„‰é®")) continue;

            const town = row[0].trim();
            const village = row[1].trim();
            
            const parseNum = (val) => parseInt(String(val).replace(/[^0-9]/g, '')) || 0;

            const validVotes = parseNum(row[VOTES_COL]); 
            const invalidVotes = parseNum(row[INVALID_COL]); 
            const eligibleVoters = parseNum(row[ELIGIBLE_COL]); 
            
            globalValidVotes += validVotes;
            globalInvalidVotes += invalidVotes;
            globalEligibleVoters += eligibleVoters;

            if (!towns[town]) {
                towns[town] = { 
                    villages: {}, 
                    validVotes: 0, 
                    invalidVotes: 0,
                    eligibleVoters: 0,
                    candidates: {} 
                };
                townOrder.push(town);
            }
            
            towns[town].validVotes += validVotes;
            towns[town].invalidVotes += invalidVotes;
            towns[town].eligibleVoters += eligibleVoters;
            
            if (!towns[town].villages[village]) {
                 towns[town].villages[village] = { 
                     validVotes: 0, 
                     invalidVotes: 0,
                     eligibleVoters: 0,
                     candidates: {} 
                 };
            }
            towns[town].villages[village].validVotes += validVotes;
            towns[town].villages[village].invalidVotes += invalidVotes;
            towns[town].villages[village].eligibleVoters += eligibleVoters;
            
            
            candInfo.forEach(c => {
                const votes = parseNum(row[c.colIndex]);
                
                if (!candidates[c.name]) candidates[c.name] = { number: c.number, party: c.party, votes: 0, isWinner: c.isWinner };
                candidates[c.name].votes += votes;
                
                if (!towns[town].candidates[c.name]) towns[town].candidates[c.name] = { number: c.number, party: c.party, votes: 0, isWinner: c.isWinner };
                towns[town].candidates[c.name].votes += votes;
                
                if (!towns[town].villages[village].candidates[c.name]) towns[town].villages[village].candidates[c.name] = { number: c.number, party: c.party, votes: 0, isWinner: c.isWinner };
                towns[town].villages[village].candidates[c.name].votes += votes;
            });
        }

        appState.data = { county: candidates, towns: towns, townOrder: [...new Set(townOrder)] };
        appState.countyMetadata = {
            validVotes: globalValidVotes,
            invalidVotes: globalInvalidVotes,
            eligibleVoters: globalEligibleVoters
        };
        appState.globalTotalVotes = globalValidVotes; 
    }

    function loadData(file, uiName) {
        dom.content.innerHTML = `<div class="loading-state">æ­£åœ¨è¼‰å…¥ ${uiName} å®Œæ•´æ•¸æ“š...</div>`;
        
        appState.electionName = uiName;
        
        fetch(file) 
            .then(r => { 
                if(!r.ok) throw new Error("æª”æ¡ˆè®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆåç¨±èˆ‡è·¯å¾‘ã€‚"); 
                return r.text(); 
            })
            .then(csvText => {
                parseCSV(csvText);
                appState.sortConfig = { key: 'number', direction: 'asc' }; 
                renderCounty(true); 
            })
            .catch(error => {
                console.error("è¼‰å…¥éŒ¯èª¤:", error);
                dom.content.innerHTML = `<div class="loading-state" style="color:red">è®€å– ${file} å¤±æ•—: ${error.message}<br>è«‹æª¢æŸ¥æª”æ¡ˆæ˜¯å¦ä¸Šå‚³æˆåŠŸã€‚</div>`;
            });
    }
    
    // ================= è³‡æ–™è¼‰å…¥èˆ‡è§£æ (æ‘˜è¦å¡ç‰‡å°ˆç”¨) =================
    
    function extractCountySummary(text) {
        const rows = text.split('\n').map(r => r.trim()).filter(r => r).map(r => r.split(','));

        if (rows.length < 4) return null;

        const headerRowIndices = []; 
        let currentIdx = 2;
        while(rows[0][currentIdx] && rows[1][currentIdx]) {
            headerRowIndices.push(currentIdx);
            currentIdx++;
        }
        
        const candInfo = [];
        headerRowIndices.forEach(colIndex => {
            const number = rows[0][colIndex] ? rows[0][colIndex].trim() : '';
            let name = rows[1][colIndex] ? rows[1][colIndex].trim() : '';
            let party = rows[2][colIndex] ? rows[2][colIndex].trim() : '';
            
            name = name.replace('*', '').trim(); 
            party = party === 'ç„¡' ? 'ç„¡é»¨ç±' : party;

            if (name && number) {
                candInfo.push({ number: String(number), name, party, colIndex }); 
            }
        });

        const candidates = {}; 
        let globalValidVotes = 0; 
        let globalInvalidVotes = 0; 
        let globalEligibleVoters = 0; 
        
        const VOTES_COL = 5;
        const INVALID_COL = 6;
        const ELIGIBLE_COL = 7;

        for (let i = 3; i < rows.length; i++) {
            const row = rows[i];
            
            if (row.length < 8 || !row[0] || row[0].includes("é„‰é®")) continue;

            const parseNum = (val) => parseInt(String(val).replace(/[^0-9]/g, '')) || 0;

            const validVotes = parseNum(row[VOTES_COL]); 
            const invalidVotes = parseNum(row[INVALID_COL]); 
            const eligibleVoters = parseNum(row[ELIGIBLE_COL]); 
            
            globalValidVotes += validVotes;
            globalInvalidVotes += invalidVotes;
            globalEligibleVoters += eligibleVoters;
            
            candInfo.forEach(c => {
                const votes = parseNum(row[c.colIndex]);
                
                if (!candidates[c.name]) candidates[c.name] = { number: c.number, party: c.party, votes: 0 };
                candidates[c.name].votes += votes;
            });
        }
        
        let allCandidatesList = Object.keys(candidates).map(key => ({ name: key, ...candidates[key] }));
        
        return {
            allCandidates: allCandidatesList,
            metadata: {
                validVotes: globalValidVotes,
                invalidVotes: globalInvalidVotes,
                eligibleVoters: globalEligibleVoters
            }
        };
    }
    
    async function loadAllElectionSummaries(elections) {
        const summaryPromises = elections.map(async e => {
            try {
                const response = await fetch(e.file);
                if (!response.ok) throw new Error("æª”æ¡ˆè®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆåç¨±èˆ‡è·¯å¾‘ã€‚");
                const csvText = await response.text();
                
                const summary = extractCountySummary(csvText);
                
                if (summary) {
                    const sortedAllCands = getSortedCandidatesFromList(summary.allCandidates, { key: 'votes', direction: 'desc' });
                    
                    e.summaryData = {
                        allCandidates: sortedAllCands,
                        metadata: summary.metadata,
                        topCandidates: sortedAllCands.slice(0, 3) 
                    };
                    
                } else {
                    e.summaryData = null;
                }
            } catch (error) {
                console.error(`è¼‰å…¥ ${e.file} æ‘˜è¦å¤±æ•—:`, error.message);
                e.summaryData = null; 
            }
            return e;
        });

        await Promise.all(summaryPromises);
    }

    // ================= æ’åºèˆ‡æ›´æ–°é‚è¼¯ =================
    
    window.sortTable = function(key) {
        
        const currentKey = appState.sortConfig.key;
        const currentDirection = appState.sortConfig.direction;
        
        let newDirection = 'desc'; 
        
        if (key === 'number' || key === 'name' || key === 'party') {
             newDirection = 'asc'; 
        }

        if (currentKey === key) {
            newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
        }

        appState.sortConfig = { key: key, direction: newDirection };

        if (appState.currentLevel === 'county') {
            renderCounty(false); 
        } else if (appState.currentLevel === 'town') {
            renderTown(appState.currentTown, false); 
        }
    };
    
    function getSortedCandidates(candObj) {
        let list = Object.keys(candObj).map(key => ({ name: key, ...candObj[key] }));
        const { key, direction } = appState.sortConfig;
        
        list.sort((a, b) => {
            let valA = a[key], valB = b[key];

            if (key === 'number' || key === 'votes') { 
                valA = parseInt(valA) || 0; 
                valB = parseInt(valB) || 0;
            } else if (typeof valA === 'string') {
                 valA = valA.toLowerCase();
                 valB = valB.toLowerCase();
            }

            let comparison = 0;
            if (valA < valB) {
                comparison = -1;
            } else if (valA > valB) {
                comparison = 1;
            }

            return direction === 'asc' ? comparison : comparison * -1;
        });
        
        return list;
    }
    
    function getSortedCandidatesFromList(list, sortConfig = { key: 'votes', direction: 'desc' }) {
        const { key, direction } = sortConfig;
        
        list.sort((a, b) => {
            let valA = a[key], valB = b[key];

            if (key === 'number' || key === 'votes') { 
                valA = parseInt(valA) || 0; 
                valB = parseInt(valB) || 0;
            } else if (typeof valA === 'string') {
                 valA = valA.toLowerCase();
                 valB = valB.toLowerCase();
            }

            let comparison = 0;
            if (valA < valB) {
                comparison = -1;
            } else if (valA > valB) {
                comparison = 1;
            }

            return direction === 'asc' ? comparison : comparison * -1;
        });
        
        return list;
    }
    
    function generateTableBodyHTML(candidates, validVotes, isSummaryCard = false) {
        return candidates.map(c => {
            const rate = validVotes > 0 ? (c.votes / validVotes * 100).toFixed(2) : 0;
            const color = getPartyColor(c.party);
            
            const badgeClass = 'number-badge'; 
            
            return `
                <tr>
                    <td class="number-cell col-number">
                        <span class="${badgeClass}">${c.number}</span>
                    </td>
                    <td style="font-weight:700">${c.name}</td>
                    <td class="party-cell col-party">
                        <span class="party-badge party-long" style="background:${color}">${c.party}</span>
                        <span class="party-badge party-short" style="background:${color}">${getShortPartyName(c.party)}</span>
                    </td>
                    <td style="text-align:right">
                        <div class="vote-cell-content">
                            <span>${c.votes.toLocaleString()}</span>
                            <div class="bar-container col-bar-fill"><div class="bar-fill" style="width:${rate}%; background:${color}"></div></div>
                        </div>
                    </td>
                    <td style="text-align:right; font-weight:bold; color:${color}">${rate}%</td>
                </tr>
            `;
        }).join('');
    }
    
    function updateChartData(canvasId, sortedCandidates, totalVotes) {
        const chartInstance = appState.chartInstances.find(c => c.canvas.id === canvasId);
        if (!chartInstance) return;

        chartInstance.data.labels = sortedCandidates.map(c => c.name);
        chartInstance.data.datasets[0].data = sortedCandidates.map(c => c.votes);
        chartInstance.data.datasets[0].backgroundColor = sortedCandidates.map(c => getPartyColor(c.party));
        
        chartInstance.update();
    }
    
    function updateSortIcons() {
        const { key, direction } = appState.sortConfig;
        document.querySelectorAll('th .sort-icon').forEach(icon => {
            const iconKey = icon.getAttribute('data-key');
            icon.className = 'sort-icon'; 
            if (iconKey === key) {
                icon.classList.add(direction); 
            }
        });
    }

    // ================= é é¢æ¸²æŸ“å‡½å¼ =================
    
    function generateSummaryCardHTML(election) {
        if (!election.summaryData) {
            return `<div class="card failed">
                <div class="card-title">${election.uiName}</div>
                <div class="card-stats" style="color:red; margin-left:0;">è³‡æ–™è¼‰å…¥å¤±æ•—æˆ–æª”æ¡ˆéºå¤±ã€‚</div>
            </div>`;
        }

        const { topCandidates, metadata } = election.summaryData;
        
        return generateCardHTML(
            `summary-${election.file.replace(/[^a-zA-Z0-9]/g, '-')}`, 
            election.uiName, 
            topCandidates, 
            metadata, 
            true, 
            `loadData('${election.file}', '${election.uiName}')`, 
            true, // isCompact
            true  // isSummary
        );
    }

    /**
     * æ¸²æŸ“ä¸»é¸å–®é é¢ (é¦–é )
     */
    window.renderMainMenu = function() {
        destroyAllCharts();
        appState.currentLevel = 'mainMenu';
        window.scrollTo(0, 0); 
        updateBreadcrumb(); 

        let html = '';

        // 1. ä¸»è¦æŒ‰éˆ•é¸å–®
        html += `<div class="main-section">
            <div class="menu-section-title">ä¾é¸èˆ‰é¡åˆ¥ç€è¦½</div>
            <div class="main-menu-grid">`;
        
        electionCategories.forEach(cat => {
            html += `<div class="menu-button" onclick="renderElectionList('${cat.type}')">
                ${cat.type}
            </div>`;
        });
        html += `</div></div>`;

        // 2. è¿‘æœŸé¸èˆ‰
        const recentElections = [...availableElections].sort((a, b) => {
            return parseInt(b.year) - parseInt(a.year); 
        }).slice(0, 8); 

        if (recentElections.length > 0) {
            html += `<div class="main-section">
                <div class="menu-section-title">ğŸ“° è¿‘æœŸé¸èˆ‰</div>
                <div class="election-list-grid">`;
            
            recentElections.forEach(e => {
                html += generateSummaryCardHTML(e);
            });
            html += `</div></div>`;
        }

        dom.content.innerHTML = html;
        drawSummaryCharts(); 
    };
    
    /**
     * æ¸²æŸ“é¸èˆ‰åˆ—è¡¨é é¢
     */
    window.renderElectionList = function(type) {
        destroyAllCharts();
        appState.currentLevel = 'electionList';
        appState.currentTown = type; 
        window.scrollTo(0, 0); 
        updateBreadcrumb(); 

        const matchingElections = availableElections.filter(e => e.type === type);
        matchingElections.sort((a, b) => b.year - a.year); 

        let html = `<div class="main-section">
            <div class="menu-section-title">ğŸ“ ${type} é¸èˆ‰åˆ—è¡¨</div>
        </div>`;
        
        if (matchingElections.length > 0) {
            html += `<div class="election-list-grid">`;
            matchingElections.forEach(e => {
                html += generateSummaryCardHTML(e); 
            });
            html += `</div>`;
        } else {
             html += `<div class="loading-state" style="padding:40px;">è©²é¡åˆ¥ç›®å‰ç„¡è³‡æ–™å¯ä¾›æŸ¥è©¢ã€‚</div>`;
        }

        dom.content.innerHTML = html;
        drawSummaryCharts(); 
    };


    // ================= å„€è¡¨æ¿æ ¸å¿ƒæ¸²æŸ“é‚è¼¯ =================

    window.renderCounty = function(shouldScroll = true) {
        const candidates = getSortedCandidates(appState.data.county);
        const metadata = appState.countyMetadata;
        
        if (!shouldScroll) {
            const mainTableBody = document.querySelector('#card-county-main table tbody'); 
            if (mainTableBody) {
                mainTableBody.innerHTML = generateTableBodyHTML(candidates, metadata.validVotes);
                updateChartData('chart-county-main', candidates, metadata.validVotes);
            }
            
            appState.data.townOrder.forEach(town => {
                const townData = appState.data.towns[town];
                const townCands = getSortedCandidates(townData.candidates);
                const townTableBody = document.querySelector(`#card-town-${town} table tbody`); 
                if (townTableBody) {
                     townTableBody.innerHTML = generateTableBodyHTML(townCands, townData.validVotes);
                     updateChartData(`chart-town-${town}`, townCands, townData.validVotes); 
                }
            });

            updateSortIcons(); 
            return; 
        }

        destroyAllCharts(); 
        appState.currentLevel = 'county';
        appState.currentTown = null;
        window.scrollTo(0,0); 
        updateBreadcrumb();

        let html = `<div class="main-section">
            <div class="section-header"><span class="section-title">${appState.electionName}</span></div>
            ${generateCardHTML('county-main', 'å…¨ç¸£é–‹ç¥¨çµæœ', candidates, metadata, false, false, false, false)}
        </div>`;

        html += `<div class="main-section">
            <div class="section-header"><span class="section-title">å„é„‰é®é–‹ç¥¨çµæœ</span><span class="section-badge">é»æ“Šå¡ç‰‡çœ‹ç´°ç¯€</span></div>
            <div class="sub-area-grid">`;
        
        appState.data.townOrder.forEach(town => {
            const townData = appState.data.towns[town];
            const townCands = getSortedCandidates(townData.candidates);
            
            const townMetadata = {
                validVotes: townData.validVotes,
                invalidVotes: townData.invalidVotes,
                eligibleVoters: townData.eligibleVoters
            };

            html += generateCardHTML(`town-${town}`, town, townCands, townMetadata, true, `renderTown('${town}')`, true, false);
        });
        html += `</div></div>`;

        dom.content.innerHTML = html;
        drawCharts(candidates, metadata.validVotes, appState.data.townOrder, 'towns');
    };

    window.renderTown = function(townName, shouldScroll = true) {
        const townData = appState.data.towns[townName];
        const candidates = getSortedCandidates(townData.candidates);
        const townMetadata = {
            validVotes: townData.validVotes,
            invalidVotes: townData.invalidVotes,
            eligibleVoters: townData.eligibleVoters
        };
        
        if (!shouldScroll) {
            const mainTableBody = document.querySelector('#card-town-main table tbody');
            if (mainTableBody) {
                mainTableBody.innerHTML = generateTableBodyHTML(candidates, townMetadata.validVotes);
                updateChartData('chart-town-main', candidates, townMetadata.validVotes);
            }
            
            const villageList = Object.keys(townData.villages);
            villageList.forEach(village => {
                const vData = townData.villages[village];
                const vCands = getSortedCandidates(vData.candidates);
                const villageTableBody = document.querySelector(`#card-village-${village} table tbody`); 
                if (villageTableBody) {
                     villageTableBody.innerHTML = generateTableBodyHTML(vCands, vData.validVotes);
                     updateChartData(`chart-village-${village}`, vCands, vData.validVotes);
                }
            });

            updateSortIcons(); 
            return; 
        }
        
        destroyAllCharts();
        appState.currentLevel = 'town';
        appState.currentTown = townName;
        window.scrollTo(0,0); 
        updateBreadcrumb();
        
        const villageList = Object.keys(townData.villages);

        let html = `<div class="main-section">
            <div class="section-header"><span class="section-title">${townName} ç¸½è¨ˆ</span></div>
            ${generateCardHTML('town-main', `${townName}é–‹ç¥¨çµæœ`, candidates, townMetadata, false, false, false, false)}
        </div>`;

        html += `<div class="main-section">
            <div class="section-header"><span class="section-title">å„æ‘é‡Œé–‹ç¥¨çµæœ</span></div>
            <div class="sub-area-grid">`;
        
        villageList.forEach(village => {
            const vData = townData.villages[village];
            const vCands = getSortedCandidates(vData.candidates);
            
            const villageMetadata = {
                validVotes: vData.validVotes,
                invalidVotes: vData.invalidVotes,
                eligibleVoters: vData.eligibleVoters
            };

            html += generateCardHTML(`village-${village}`, village, vCands, villageMetadata, false, null, true, false);
        });
        html += `</div></div>`;

        dom.content.innerHTML = html;
        drawCharts(candidates, townMetadata.validVotes, villageList, 'villages', townData);
    };

    // ================= é€šç”¨è¼”åŠ©å‡½å¼ =================

    function generateCardHTML(id, title, candidates, metadata, isClickable, onClickAction, isCompact = false, isSummary = false) {
        const clickClass = isClickable ? 'clickable' : '';
        const clickAttr = isClickable ? `onclick="${onClickAction}"` : '';
        
        const actionText = isClickable ? `<span class="card-action">æŸ¥çœ‹è©³æƒ… âœ</span>` : '';
        
        const layoutClass = isCompact ? 'layout-compact' : 'layout-full';
        const summaryClass = isSummary ? 'is-summary' : '';
        
        const tableSizeClass = isCompact ? '' : ' large-table';
        
        const { validVotes, invalidVotes, eligibleVoters } = metadata;
        
        const totalBallots = validVotes + invalidVotes;
        const turnoutRate = eligibleVoters > 0 ? (totalBallots / eligibleVoters * 100).toFixed(2) : "0.00";

        let cardStatsHTML;
        if (isSummary) {
             cardStatsHTML = `
                <div class="card-stats">
                    <span style="white-space: nowrap;">
                        æœ‰æ•ˆç¥¨: ${validVotes.toLocaleString()} ç¥¨ 
                        <span style="color:var(--text-sub); margin: 0 5px;">|</span>
                        æŠ•ç¥¨ç‡: <span class="rate">${turnoutRate}%</span>
                    </span>
                </div>
            `;
        } else {
             cardStatsHTML = `
                <div class="card-stats">
                    <span style="font-size:14px;">æœ‰æ•ˆç¥¨: ${validVotes.toLocaleString()} ç¥¨</span> 
                    | ç„¡æ•ˆç¥¨: ${invalidVotes.toLocaleString()} ç¥¨ 
                    <br>
                    <span style="white-space: nowrap;">
                        é¸èˆ‰äººæ•¸: ${eligibleVoters.toLocaleString()} äºº 
                        | æŠ•ç¥¨ç‡: <span class="rate">${turnoutRate}%</span>
                    </span>
                </div>
            `;
        }


        const { key: currentSortKey, direction: currentSortDirection } = appState.sortConfig;

        function renderTableHeader(title, sortKey, style = '', className = '') {
            if (isSummary) {
                 return `<th style="${style}" class="${className}">${title}</th>`;
            }
            
            const isCurrentKey = currentSortKey === sortKey;
            const iconClass = isCurrentKey ? currentSortDirection : '';
            const iconHtml = `<span data-key="${sortKey}" class="sort-icon ${iconClass}"></span>`;
            
            return `<th style="${style}" class="${className}" onclick="event.stopPropagation(); sortTable('${sortKey}')">${title} ${iconHtml}</th>`;
        }
        
        const tableBodyHTML = generateTableBodyHTML(candidates, validVotes, isSummary);
        
        // é€™è£¡ä¿ç•™ã€Œæ¨è–¦æ”¿é»¨ã€ï¼ŒCSS æœƒåœ¨æ‰‹æ©Ÿç‰ˆèª¿æ•´å­—é«”å¤§å°
        const partyTitle = "æ¨è–¦æ”¿é»¨";
        
        return `
        <div class="card ${clickClass} ${summaryClass}" ${clickAttr} id="card-${id}">
            <div class="card-header">
                <div class="card-header-left">
                    <div class="card-title">${title}</div>
                    ${cardStatsHTML}
                </div>
                ${actionText}
            </div>
            <div class="${layoutClass}">
                <div class="chart-area">
                    <canvas id="chart-${id}"></canvas>
                </div>
                <div class="table-area table-responsive">
                    <table class="${tableSizeClass}">
                        <thead>
                            <tr>
                                ${renderTableHeader('#', 'number', 'width:40px; text-align:center;', 'col-number')} 
                                ${renderTableHeader('å€™é¸äºº', 'name', '', '')}
                                ${renderTableHeader(partyTitle, 'party', '', 'col-party')}
                                ${renderTableHeader('å¾—ç¥¨', 'votes', 'text-align:right')}
                                ${renderTableHeader('%', 'votes', 'text-align:right; width:60px')}
                            </tr>
                        </thead>
                        <tbody>
                            ${tableBodyHTML}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>`;
    }

    function destroyAllCharts() {
        appState.chartInstances.forEach(c => c.destroy());
        appState.chartInstances = [];
    }
    
    function drawSummaryCharts() {
        destroyAllCharts(); 
        
        availableElections.forEach(e => {
            if (e.summaryData) {
                const chartId = `chart-summary-${e.file.replace(/[^a-zA-Z0-9]/g, '-')}`;
                const allCands = e.summaryData.allCandidates;
                const validVotes = e.summaryData.metadata.validVotes;
                const sortedCands = getSortedCandidatesFromList(allCands, { key: 'votes', direction: 'desc' });
                
                drawChart(chartId, sortedCands, validVotes, true, 'doughnut');
            }
        });
    }

    function updateBreadcrumb() {
        const { currentLevel, currentTown, electionName } = appState;
        let html = '';
        
        if (currentLevel === 'mainMenu') {
            dom.breadcrumb.style.display = 'none';
            dom.breadcrumbBottom.style.display = 'none';
            return;
        }

        html += `<span onclick="renderMainMenu()">ğŸ  ä¸»é¸å–®</span>`;

        if (currentLevel === 'electionList') {
             html += ` &gt; <span onclick="renderMainMenu()">é¸èˆ‰é¡åˆ¥</span>`;
             html += ` &gt; <span class="active">${currentTown}</span>`;
        } else if (currentLevel === 'county') {
             const electionType = availableElections.find(e => e.uiName === electionName)?.type;
             html += ` &gt; <span onclick="renderMainMenu()">é¸èˆ‰é¡åˆ¥</span>`;
             if (electionType) {
                 html += ` &gt; <span onclick="renderElectionList('${electionType}')">${electionType}</span>`;
             }
            html += ` &gt; <span class="active">${electionName}</span>`;
        } else if (currentLevel === 'town') {
             const electionType = availableElections.find(e => e.uiName === electionName)?.type;
             html += ` &gt; <span onclick="renderMainMenu()">é¸èˆ‰é¡åˆ¥</span>`;
             if (electionType) {
                 html += ` &gt; <span onclick="renderElectionList('${electionType}')">${electionType}</span>`;
             }
            html += ` &gt; <span onclick="renderCounty(true)">${electionName}</span>`;
            html += ` &gt; <span class="active">${currentTown}</span>`;
        }
        
        dom.breadcrumb.style.display = 'block';
        dom.breadcrumb.innerHTML = html;
        dom.breadcrumbBottom.style.display = 'block';
        dom.breadcrumbBottom.innerHTML = html;
    }

    function drawCharts(mainCands, mainTotal, subList, subType, townData = null) {
        const mainId = subType === 'towns' ? 'chart-county-main' : 'chart-town-main';
        drawChart(mainId, mainCands, mainTotal, false, 'doughnut');

        subList.forEach(key => {
            let data, id;
            if (subType === 'towns') {
                data = appState.data.towns[key];
                id = `chart-town-${key}`;
            } else {
                data = townData.villages[key];
                id = `chart-village-${key}`;
            }
            const cands = getSortedCandidates(data.candidates);
            drawChart(id, cands, data.validVotes, true, 'doughnut');
        });
    }

    function drawChart(canvasId, candidates, totalVotes, hideLegend = false, chartType = null) {
        const ctx = document.getElementById(canvasId);
        if(!ctx) return;
        
        const finalChartType = chartType || (candidates.length > 5 ? 'bar' : 'doughnut');

        const chart = new Chart(ctx.getContext('2d'), {
            type: finalChartType,
            data: {
                labels: candidates.map(c => c.name),
                datasets: [{
                    data: candidates.map(c => c.votes),
                    backgroundColor: candidates.map(c => getPartyColor(c.party)),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: !hideLegend, 
                        position: 'bottom',
                        labels: { boxWidth: 12, padding: 10, font: { size: 11 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const percentage = totalVotes > 0 ? (value / totalVotes * 100).toFixed(2) : 0;
                                return [
                                    `${context.label}: ${value.toLocaleString()} ç¥¨`,
                                    `å¾—ç¥¨ç‡: ${percentage}%`
                                ];
                            },
                            title: function(context) {
                                return context[0].label; 
                            }
                        }
                    }
                },
                layout: { padding: 0 }
            }
        });
        appState.chartInstances.push(chart);
    }

    (function init() {
        dom.content.innerHTML = `<div class="loading-state">æ­£åœ¨è¼‰å…¥æ‰€æœ‰é¸èˆ‰æ‘˜è¦æ•¸æ“š...è«‹ç¨å€™ã€‚</div>`;
        loadAllElectionSummaries(availableElections).then(() => {
            renderMainMenu(); 
        });
    })();
</script>
</body>
</html>
