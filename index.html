<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote for Kinmenï¸±é‡‘é–€é¸èˆ‰å„€è¡¨æ¿</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #3887B0;
            --secondary: #2c3e50; 
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --border: #e1e4e8;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        
        body { 
            font-family:'Noto Sans TC', sans-serif; 
            background:var(--bg); 
            color:var(--text-main); 
            line-height:1.6; 
            padding-bottom: 20px; 
            padding-top: 50px; 
        }
        
        /* ç½®é ‚æ¨™é¡Œåˆ—æ¨£å¼ */
        header { 
            background: var(--secondary); 
            color: white; 
            padding: 10px 20px; 
            text-align: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            position: fixed; 
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000; 
        }
        
        h1 { font-size: 20px; font-weight: 700; margin: 0; }
        h1 span { cursor: pointer; } 
        
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        
        /* --- ä¸»é¸å–®æ¨£å¼ --- */
        
        .main-menu-grid {
            display: grid;
            /* æ¡Œé¢ç‰ˆï¼šè‡ªé©æ‡‰ä½ˆå±€ï¼Œæœ€å° 180px */
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 15px; 
            margin-bottom: 50px;
        }

        .menu-button {
            background: var(--card-bg);
            border: 1px solid var(--border); 
            border-radius: 8px; 
            padding: 15px 20px; 
            text-align: center;
            font-size: 16px; 
            font-weight: 500; 
            color: var(--secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            line-height: 1.4;
        }
        
        .menu-button:hover {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
            transform: translateY(-2px); 
            box-shadow: 0 4px 10px rgba(56, 135, 176, 0.2);
        }
        
        /* ä¿®æ­£: è®“é¸å–®åœ–ç¤ºå¯è¦‹ä¸¦å‚ç›´å †ç–Š */
        .menu-icon { 
            display: block; 
            font-size: 32px; 
            margin-bottom: 8px; 
            line-height: 1;
        } 
        
        /* æ–°å¢ï¼šç¢ºä¿æŒ‰éˆ•æ–‡å­—æœ‰å€åˆ† */
        .menu-text {
            display: block; 
        }

        .menu-section-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        /* --- é¸èˆ‰åˆ—è¡¨ / æ‘˜è¦å¡ç‰‡æ¨£å¼ --- */
        .election-list-grid {
             display: grid;
             grid-template-columns: repeat(2, 1fr); 
             gap: 20px;
             margin-top: 20px;
        }
        
        /* --- å„€è¡¨æ¿èˆŠæœ‰æ¨£å¼ç¶­æŒ --- */
        
        .breadcrumb { margin-bottom: 20px; font-size: 16px; color: var(--text-sub); padding: 10px 0; }
        #breadcrumb-bottom { margin-top: 40px; border-top: 1px solid var(--border); padding-top: 20px; }
        .breadcrumb span { cursor: pointer; color: var(--primary); font-weight: 500; }
        .breadcrumb span:hover { text-decoration: underline; }
        .breadcrumb span.active { color: var(--text-main); cursor: default; text-decoration: none; }
        
        .main-section { margin-bottom: 40px; }
        .section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--border); }
        .section-title { font-size: 22px; font-weight: 700; color: var(--text-main); }
        .section-badge { background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 13px; }

        /* å¡ç‰‡ä¸»é«”ï¼Œpadding ç‚º 20pxï¼Œè®“å…§å®¹è²¼é½Šé‚Šç·£ */
        .card { background: var(--card-bg); border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 20px; overflow: hidden; border: 1px solid transparent; transition: all 0.2s; margin-bottom: 0; }
        .card.clickable { cursor: pointer; }
        .card.clickable:hover { transform: translateY(-3px); border-color: var(--primary); box-shadow: 0 8px 15px rgba(56, 135, 176, 0.15); }
        
        /* å¡ç‰‡æ¨™é ­ï¼šå·¦å³å°é½Šï¼Œä¸¦è®“å·¦é‚Šå¯æ”¶ç¸® */
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 15px; 
            overflow: hidden; 
        }
        .card-header-left { 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 1; 
            min-width: 0;
        }
        
        .card-title { font-size: 18px; font-weight: 700; color: var(--text-main); border-left: 4px solid var(--primary); padding-left: 10px; line-height: 1.2; }
        
        /* å„€è¡¨æ¿å…§é å¡ç‰‡çµ±è¨ˆæ•¸æ“šæ¨£å¼ (éæ‘˜è¦) */
        .card-stats { 
            font-size: 13px; 
            color: var(--text-main); 
            margin-top: 5px; 
            margin-left: 14px; 
            font-weight: 500; 
            line-height: 1.8; 
        }
        
        .card-stats strong { 
            font-weight: 500; 
            color: var(--text-main);
        }
        
        .card-stats .rate { color: #d9534f; font-weight: 700; }
        
        /* æ‘˜è¦å¡ç‰‡çµ±è¨ˆæ•¸æ“šæ¨£å¼ (é¦–é /åˆ—è¡¨é ) */
        .card.is-summary .card-stats {
            margin-top: 5px;
            margin-left: 14px;
            font-size: 14px; 
            line-height: 1.5;
            color: var(--text-main);
        }

        .card.is-summary .card-stats strong {
             color: var(--text-main); 
             font-weight: 500; 
        }
        .card.is-summary .card-stats .rate {
             color: #d9534f; 
        }

        /* è®“ action text ä¿æŒåœ¨æœ€å³é‚Šï¼Œä¸¦é˜²æ­¢è¢«æ“ å£“ */
        .card-action { 
            font-size: 14px; 
            color: var(--primary); 
            font-weight: 500; 
            white-space: nowrap; 
            margin-left: 10px; 
            flex-shrink: 0; 
            align-self: flex-start; 
            padding-top: 2px; 
        }

        /* å…§å®¹å€åŸŸä½ˆå±€èª¿æ•´ */
        .layout-full, .layout-compact { 
            display: block; 
        }

        .sub-area-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(480px, 1fr)); gap: 15px; }
        
        /* ç°¡æ½”å¡ç‰‡ä½ˆå±€ (ç”¨æ–¼é„‰é®/æ‘é‡Œæˆ–é¦–é æ‘˜è¦) */
        .layout-compact .table-area { flex: 1; min-width: 0; }

        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; table-layout: auto; } 
        
        /* è¡¨æ ¼åˆ—æ¨£å¼ */
        tr {
            transition: background-color 0.3s ease;
            /* è®“å…§å®¹å±¤ç–Šåœ¨èƒŒæ™¯ä¸Šï¼Œé˜²æ­¢èƒŒæ™¯èˆ‡é‚Šæ¡†å¹²æ“¾ */
            position: relative; 
            z-index: 1; 
        }
        /* hover æ•ˆæœï¼Œè®“è¦–è¦ºæ›´æ˜é¡¯ */
        tr:hover {
            background-color: rgba(0, 0, 0, 0.03); 
        }

        th { 
            background: #f8f9fa; 
            color: #666; 
            font-weight: 600; 
            text-align: left; 
            padding: 6px 8px; 
            border-bottom: 2px solid var(--border); 
            white-space: nowrap; 
            font-size: 13px; 
            cursor: pointer; 
            position: relative; 
        }
        th:hover { background: #e9ecef; }
        td { 
            padding: 8px 8px; 
            border-bottom: 1px solid var(--border); 
            vertical-align: middle; 
            /* ç¢ºä¿ td å…§å®¹åœ¨ tr çš„èƒŒæ™¯ä¹‹ä¸Š */
            position: relative; 
            z-index: 2; 
        }
        
        /* è™Ÿç¢¼æ¬„ä½ */
        table th:nth-child(1),
        table td:nth-child(1) { width: 40px; text-align: center; } 
        
        /* å¾—ç¥¨æ•¸æ¬„ä½ */
        table th:nth-last-child(2),
        table td:nth-last-child(2) { text-align: right; white-space: nowrap; } 
        
        /* å¾—ç¥¨ç‡æ¬„ä½ */
        table th:last-child,
        table td:last-child { width: 50px; text-align: right; white-space: nowrap; } 
        
        td.number-cell { text-align: center; }
        
        .sort-icon {
            display: inline-block; width: 0; height: 0; margin-left: 5px; vertical-align: middle; border-left: 4px solid transparent; border-right: 4px solid transparent; opacity: 0.3; 
        }
        .sort-icon.asc { border-bottom: 4px solid #333; opacity: 1; }
        .sort-icon.desc { border-top: 4px solid #333; opacity: 1; }
        
        /* è™Ÿæ¬¡åœ“åœˆæ¨£å¼ - é‚Šæ¡†åŠ ç²—è‡³ 2pxï¼Œä¸¦ä½¿ç”¨ Flexbox ç¢ºä¿å®Œç¾ç½®ä¸­ */
        .number-badge {
            display: flex; /* <--- é—œéµï¼šä½¿ç”¨ Flexbox */
            align-items: center; /* <--- å‚ç›´ç½®ä¸­ */
            justify-content: center; /* <--- æ°´å¹³ç½®ä¸­ */
            width: 24px; 
            height: 24px; 
            /* line-height ç§»é™¤æˆ–è¨­ç‚ºæ­£å¸¸ï¼Œè®“ Flexbox æ¥ç®¡å‚ç›´ç½®ä¸­ */
            line-height: normal; 
            background: #eee; 
            border-radius: 50%; 
            font-weight: 700; 
            font-size: 13px; 
            color: #555; 
            vertical-align: middle;
            border: 2px solid #ffffff; 
            box-shadow: 0 0 0 1px rgba(0,0,0,0.05); 
        }

        .party-badge { font-size: 11px; padding: 2px 6px; border-radius: 8px; color: white; background: #999; white-space: nowrap; }
        
        /* é è¨­ (æ¡Œé¢ç‰ˆ > 768px)ï¼šé¡¯ç¤ºé•·åç¨±ï¼Œéš±è—çŸ­åç¨± */
        .party-cell .party-long { display: inline-block; }
        .party-cell .party-short { display: none; }
        
        /* æ¡Œé¢ç‰ˆï¼šé¡¯ç¤ºã€Œæ¨è–¦æ”¿é»¨ã€ */
        .col-party .party-title-desktop { display: inline; }
        .col-party .party-title-mobile { display: none; }


        table.large-table { font-size: 17px; table-layout: auto; }
        table.large-table th { padding: 10px 10px; font-size: 14px; }
        table.large-table td { padding: 10px 10px; }
        table.large-table .number-badge { width: 26px; height: 26px; font-size: 14px; }
        table.large-table .party-badge { font-size: 12px; }

        .loading-state { text-align: center; padding: 60px; color: var(--text-sub); font-size: 18px; }
        
        /* æ–°å¢ï¼šé ‚éƒ¨å…©æ¬„ä½ˆå±€å®¹å™¨ */
        .top-summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* æ¡Œé¢ç‰ˆï¼šå…©æ¬„å¹³å‡åˆ†ä½ˆ */
            gap: 25px;
            margin-bottom: 40px;
            align-items: start; /* ç¢ºä¿å…§å®¹é ‚éƒ¨å°é½Š */
        }

        /* æ–°å¢ï¼šå³å´æ‘˜è¦è³‡è¨Šé¢æ¿æ¨£å¼ */
        .summary-panel {
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 20px;
            border: 1px solid var(--border);
        }
        /* h3 for "æŠ•ç¥¨æ¦‚æ³" */
        .summary-panel h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--secondary);
            border-left: 4px solid var(--primary); 
            padding-left: 10px;
            line-height: 1.2;
            margin-bottom: 15px;
        }
        .summary-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 15px;
        }
        .summary-list li {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed var(--border);
        }
        .summary-list li:last-child {
            border-bottom: none;
        }
        /* ç•¶é¸è€…å–®è¡Œè³‡è¨Šçš„æ¨£å¼è¦†è“‹ */
        .summary-list li.winner-row {
            display: block !important; 
            border-bottom: none !important;
            line-height: 1.5;
        }
        .summary-list .stat-value {
            font-weight: 700;
            color: var(--text-main);
        }
        .summary-list .winner-name {
            color: var(--primary);
            font-size: 16px;
        }

        @media (max-width: 768px) {
             /* æ‰‹æ©Ÿç‰ˆï¼šå¼·åˆ¶ä¸»é¸å–®æŒ‰éˆ•é›™æ¬„é¡¯ç¤º (å…ˆå‰è¦æ±‚) */
             .main-menu-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* æ‰‹æ©Ÿç‰ˆæŒ‰éˆ•æ¨£å¼èª¿æ•´ */
            .menu-button {
                padding: 15px 5px; 
            }
             /* ä¿æŒæ‰‹æ©Ÿç‰ˆæ–‡å­—å¤§å° */
             .menu-text {
                font-size: 14px;
            }

             /* æ‰‹æ©Ÿç‰ˆï¼šæ‘˜è¦å¡ç‰‡åˆ—è¡¨é–å®šç‚ºå–®æ¬„ */
             .election-list-grid { grid-template-columns: 1fr; }
             
             /* ç°¡æ½”å¡ç‰‡åœ¨æ‰‹æ©Ÿä¸Šèª¿æ•´ */
             .layout-compact { flex-direction: column; align-items: center; }
             .layout-compact .table-area { width: 100%; }

             /* å…¶ä»–ä¿æŒä¸€è‡´ */
            .layout-full { grid-template-columns: 1fr; }
            .sub-area-grid { grid-template-columns: 1fr; }
            
            /* æ‰‹æ©Ÿç‰ˆæ¨£å¼ä¿®æ­£ï¼šéš±è—é•·åç¨±ï¼Œé¡¯ç¤ºçŸ­åç¨± */
            .party-cell .party-long { display: none; }
            .party-cell .party-short { display: inline-block; }
            
            .party-badge { font-size: 11px; }

            table.large-table { font-size: 14px; }
            table.large-table th { padding: 6px 8px; font-size: 13px; }
            table.large-table td { padding: 8px 8px; }
            table.large-table .party-badge { font-size: 11px; }
            
            td.number-cell { text-align: center; line-height: 22px; }
            
            /* æ‰‹æ©Ÿç‰ˆè™Ÿæ¬¡åœ“åœˆæ¨£å¼ - ä½¿ç”¨ Flexbox ç¢ºä¿å®Œç¾ç½®ä¸­ */
            .number-badge { 
                width: 22px; 
                height: 22px; 
                /* line-height ç§»é™¤æˆ–è¨­ç‚ºæ­£å¸¸ï¼Œè®“ Flexbox æ¥ç®¡å‚ç›´ç½®ä¸­ */
                line-height: normal; 
                font-size: 12px; 
                vertical-align: middle; 
                border: 2px solid #ffffff; 
            }

            /* æ‰‹æ©Ÿç‰ˆï¼šéš±è—ã€Œæ¨è–¦æ”¿é»¨ã€ï¼Œé¡¯ç¤ºã€Œæ”¿é»¨ã€ */
            .col-party .party-title-desktop { display: none; }
            .col-party .party-title-mobile { display: inline; }
            
            /* æ‰‹æ©Ÿç‰ˆï¼šé ‚éƒ¨å…©æ¬„æ”¹ç‚ºå–®æ¬„å †ç–Š */
            .top-summary-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* --- é å°¾ç¸½é«”æ¨£å¼ (Footer) --- */
        footer {
            padding: 15px 15px;
            margin-top: 40px; 
            border-top: 1px solid var(--border); 
            background: #fafafa; 
            text-align: center; 
            font-size: 12px; 
            color: #999; 
            line-height: 1.6;
        }

        /* æ¡Œé¢ç‰ˆï¼ˆ> 768pxï¼‰é å°¾æ¨£å¼èª¿æ•´ */
        @media (min-width: 769px) {
            #footer-source {
                display: inline;
            }
        }
    </style>
</head>
<body>

<header>
    <h1><span onclick="renderMainMenu()">Vote for Kinmenï¸±é‡‘é–€é¸èˆ‰å„€è¡¨æ¿</span></h1>
</header>

<div class="container">
    <div id="breadcrumb" class="breadcrumb" style="display:none;"></div>
    
    <div id="content">
        <div class="loading-state">è³‡æ–™è¼‰å…¥ä¸­...</div>
    </div>

    <div id="breadcrumb-bottom" class="breadcrumb" style="display:none;"></div>
</div>

<footer>
    <span id="footer-source">è³‡æ–™ä¾†æºï¸±ä¸­é¸æœƒé¸èˆ‰è³‡æ–™åº«</span>
</footer>

<script>
    
    // ================= æ•¸æ“šèˆ‡è¨­å®šå€ =================
    
    const availableElections = [
        { 
            file: "2024_ç¸½çµ±å‰¯ç¸½çµ±.csv", 
            year: "2024", 
            type: "ç¸½çµ±å‰¯ç¸½çµ±", 
            uiName: "2024å¹´ ç¸½çµ±å‰¯ç¸½çµ±é¸èˆ‰",
            summaryData: null 
        },
        { 
            file: "2024_ç«‹æ³•å§”å“¡.csv", 
            year: "2024", 
            type: "ç«‹æ³•å§”å“¡", 
            uiName: "2024å¹´ ç«‹æ³•å§”å“¡é¸èˆ‰",
            summaryData: null
        },
        // ä¿®æ­£ 2: æª”æ¡ˆåç¨±èˆ‡ UI é¡¯ç¤ºåç¨±æ›´æ–°
        { 
            file: "2019_ç«‹æ³•å§”å“¡è£œé¸.csv", 
            year: "2019", 
            type: "ç«‹æ³•å§”å“¡", 
            uiName: "2019å¹´ ç«‹æ³•å§”å“¡è£œé¸",
            summaryData: null
        }
    ];
    
    const electionCategories = [
        { type: "ç¸½çµ±å‰¯ç¸½çµ±", icon: "ğŸ›ï¸" },
        { type: "ç«‹æ³•å§”å“¡", icon: "âš–ï¸" },
        { type: "åœ‹å¤§ä»£è¡¨", icon: "ğŸ“œ" },
        { type: "ç¸£é•·", icon: "ğŸ‘¨â€ğŸ’¼" },
        { type: "ç¸£è­°å“¡", icon: "ğŸ˜ï¸" },
        { type: "é„‰é®é•·", icon: "ğŸ¢" },
        { type: "é„‰é®æ°‘ä»£è¡¨", icon: "ğŸ‘¥" },
        { type: "æ‘é‡Œé•·", icon: "ğŸ¡" }
    ];

    // æ”¿é»¨åŸºç¤é¡è‰²
    const partyColors = {
        "ä¸­åœ‹åœ‹æ°‘é»¨": "#3887B0",
        "æ°‘ä¸»é€²æ­¥é»¨": "#67C167", 
        "å°ç£æ°‘çœ¾é»¨": "#28C8C8",
        "è¦ªæ°‘é»¨": "#F27C00",
        "æ–°é»¨": "#F0C800",
        "é‡‘é–€é«˜ç²±é»¨": "#990033", 
        "ç„¡é»¨ç±": "#AAAAAA",      
        "default": "#7f8c8d"
    };

    let appState = {
        data: {},
        countyMetadata: {}, 
        currentLevel: 'mainMenu', 
        currentTown: null,
        sortConfig: { key: 'number', direction: 'asc' }, 
        globalTotalVotes: 0,
        electionName: "é¸èˆ‰è³‡æ–™",
        chartInstances: [] // å¢åŠ  Chart å¯¦ä¾‹è¿½è¹¤
    };
    
    // å°‡ Hex é¡è‰²è½‰æ›ç‚º RGB ç‰©ä»¶ {r, g, b}
    function hexToRgb(hex) {
        const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
        hex = hex.replace(shorthandRegex, function(m, r, g, b) {
            return r + r + g + g + b + b;
        });
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : { r: 0, b: 0, g: 0 };
    }

    function getPartyColor(party) {
        const isIndependent = party.startsWith('ç„¡é»¨ç±');
        if (isIndependent) {
            return partyColors[party] || partyColors['ç„¡é»¨ç±']; 
        }
        return partyColors[party] || partyColors['default'];
    }

    function getShortPartyName(party) {
        const shortNamesMap = {
            "ä¸­åœ‹åœ‹æ°‘é»¨": "åœ‹æ°‘é»¨",
            "æ°‘ä¸»é€²æ­¥é»¨": "æ°‘é€²é»¨",
            "å°ç£æ°‘çœ¾é»¨": "æ°‘çœ¾é»¨",
            "è¦ªæ°‘é»¨": "è¦ªæ°‘é»¨", 
            "æ–°é»¨": "æ–°é»¨", 
            "é‡‘é–€é«˜ç²±é»¨": "é«˜ç²±é»¨", 
            "ç„¡é»¨ç±-1": "ç„¡é»¨ç±", 
            "ç„¡é»¨ç±-2": "ç„¡é»¨ç±",
            "ç„¡é»¨ç±-3": "ç„¡é»¨ç±",
            "ç„¡é»¨ç±-4": "ç„¡é»¨ç±",
            "ç„¡é»¨ç±": "ç„¡é»¨ç±",
            "default": "ç„¡"
        };
        // å˜—è©¦æŸ¥æ‰¾ç²¾ç¢ºåç¨±ï¼Œæ‰¾ä¸åˆ°å‰‡ä½¿ç”¨åŸºç¤ 'ç„¡é»¨ç±' æˆ–å›å‚³åŸåç¨±
        const key = party.split('-')[0];
        return shortNamesMap[party] || shortNamesMap[key] || party; 
    }
    
    // å–å¾—é•·åç¨± (ç”¨æ–¼æ¡Œé¢ç‰ˆ)
    function getLongPartyName(party) {
        const longNamesMap = {
            "ä¸­åœ‹åœ‹æ°‘é»¨": "ä¸­åœ‹åœ‹æ°‘é»¨",
            "æ°‘ä¸»é€²æ­¥é»¨": "æ°‘ä¸»é€²æ­¥é»¨",
            "å°ç£æ°‘çœ¾é»¨": "å°ç£æ°‘çœ¾é»¨",
            "è¦ªæ°‘é»¨": "è¦ªæ°‘é»¨", 
            "æ–°é»¨": "æ–°é»¨", 
            "é‡‘é–€é«˜ç²±é»¨": "é‡‘é–€é«˜ç²±é»¨", 
            "ç„¡é»¨ç±-1": "ç„¡é»¨ç±", 
            "ç„¡é»¨ç±-2": "ç„¡é»¨ç±",
            "ç„¡é»¨ç±-3": "ç„¡é»¨ç±",
            "ç„¡é»¨ç±-4": "ç„¡é»¨ç±",
            "ç„¡é»¨ç±": "ç„¡é»¨ç±",
            "default": "ç„¡"
        };
        const key = party.split('-')[0];
        return longNamesMap[party] || longNamesMap[key] || party; 
    }


    const dom = {
        content: document.getElementById("content"),
        breadcrumb: document.getElementById("breadcrumb"),
        breadcrumbBottom: document.getElementById("breadcrumb-bottom"),
        header: document.querySelector('header')
    };


    // ================= è³‡æ–™è¼‰å…¥èˆ‡è§£æ (ä¿æŒä¸è®Š) =================
    
    function parseCSV(text) {
        const rows = text.split('\n').map(r => r.trim()).filter(r => r).map(r => r.split(','));

        if (rows.length < 4) return;

        const headerRowIndices = []; 
        let currentIdx = 2;
        while(rows[0][currentIdx] && rows[1][currentIdx]) {
            headerRowIndices.push(currentIdx);
            currentIdx++;
        }
        
        const VOTES_COL = currentIdx; 
        const INVALID_COL = currentIdx + 1;
        const ELIGIBLE_COL = currentIdx + 2;

        const candInfo = [];
        let independentCounter = 1;
        
        headerRowIndices.forEach(colIndex => {
            const number = rows[0][colIndex] ? rows[0][colIndex].trim() : '';
            let name = rows[1][colIndex] ? rows[1][colIndex].trim() : '';
            let party = rows[2][colIndex] ? rows[2][colIndex].trim() : '';
            
            const isWinner = name.includes('*'); 
            name = name.replace('*', '').trim(); 
            
            party = party === 'ç„¡' ? 'ç„¡é»¨ç±' : party;

            if (name && number) {
                if (party === 'ç„¡é»¨ç±') {
                    if (!partyColors[`ç„¡é»¨ç±-${independentCounter}`] && independentCounter <= 4) {
                       partyColors[`ç„¡é»¨ç±-${independentCounter}`] = partyColors['ç„¡é»¨ç±']; 
                    }
                    party = `ç„¡é»¨ç±-${independentCounter}`;
                    independentCounter++;
                }

                candInfo.push({ number: String(number), name, party, colIndex, isWinner }); 
            }
        });

        const candidates = {}; 
        const towns = {};
        const townOrder = [];
        let globalValidVotes = 0; 
        let globalInvalidVotes = 0; 
        let globalEligibleVoters = 0; 
        
        for (let i = 3; i < rows.length; i++) {
            const row = rows[i];
            
            if (row.length < (ELIGIBLE_COL + 1) || !row[0] || row[0].includes("é„‰é®")) continue; 

            const town = row[0].trim();
            const village = row[1].trim();
            
            const parseNum = (val) => parseInt(String(val).replace(/[^0-9]/g, '')) || 0;

            const validVotes = parseNum(row[VOTES_COL]); 
            const invalidVotes = parseNum(row[INVALID_COL]); 
            const eligibleVoters = parseNum(row[ELIGIBLE_COL]); 
            
            globalValidVotes += validVotes;
            globalInvalidVotes += invalidVotes;
            globalEligibleVoters += eligibleVoters;

            if (!towns[town]) {
                towns[town] = { 
                    villages: {}, 
                    validVotes: 0, 
                    invalidVotes: 0,
                    eligibleVoters: 0,
                    candidates: {} 
                };
                townOrder.push(town);
            }
            
            towns[town].validVotes += validVotes;
            towns[town].invalidVotes += invalidVotes;
            towns[town].eligibleVoters += eligibleVoters;
            
            if (!towns[town].villages[village]) {
                 towns[town].villages[village] = { 
                     validVotes: 0, 
                     invalidVotes: 0,
                     eligibleVoters: 0,
                     candidates: {} 
                 };
            }
            towns[town].villages[village].validVotes += validVotes;
            towns[town].villages[village].invalidVotes += invalidVotes;
            towns[town].villages[village].eligibleVoters += eligibleVoters;
            
            
            candInfo.forEach(c => {
                const votes = parseNum(row[c.colIndex]);
                
                if (!candidates[c.name]) candidates[c.name] = { number: c.number, party: c.party, votes: 0, isWinner: c.isWinner };
                candidates[c.name].votes += votes;
                
                if (!towns[town].candidates[c.name]) towns[town].candidates[c.name] = { number: c.number, party: c.party, votes: 0, isWinner: c.isWinner };
                towns[town].candidates[c.name].votes += votes;
                
                if (!towns[town].villages[village].candidates[c.name]) towns[town].villages[village].candidates[c.name] = { number: c.number, party: c.party, votes: 0, isWinner: c.isWinner };
                towns[town].villages[village].candidates[c.name].votes += votes;
            });
        }

        appState.data = { county: candidates, towns: towns, townOrder: [...new Set(townOrder)] };
        appState.countyMetadata = {
            validVotes: globalValidVotes,
            invalidVotes: globalInvalidVotes,
            eligibleVoters: globalEligibleVoters
        };
        appState.globalTotalVotes = globalValidVotes; 
    }

    function loadData(file, uiName) {
        dom.content.innerHTML = `<div class="loading-state">æ­£åœ¨è¼‰å…¥ ${uiName} å®Œæ•´æ•¸æ“š...</div>`;
        
        appState.electionName = uiName;
        
        fetch(file) 
            .then(r => { 
                if(!r.ok) throw new Error("æª”æ¡ˆè®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆåç¨±èˆ‡è·¯å¾‘ã€‚"); 
                return r.text(); 
            })
            .then(csvText => {
                parseCSV(csvText);
                appState.sortConfig = { key: 'number', direction: 'asc' }; 
                // æ¸…ç†æ‰€æœ‰ Chart å¯¦ä¾‹ 
                appState.chartInstances.forEach(chart => chart.destroy()); 
                appState.chartInstances = [];
                renderCounty(true); 
            })
            .catch(error => {
                console.error("è¼‰å…¥éŒ¯èª¤:", error);
                dom.content.innerHTML = `<div class="loading-state" style="color:red">è®€å– ${file} å¤±æ•—: ${error.message}<br>è«‹æª¢æŸ¥æª”æ¡ˆæ˜¯å¦ä¸Šå‚³æˆåŠŸã€‚</div>`;
            });
    }
    
    function extractCountySummary(text) {
        const rows = text.split('\n').map(r => r.trim()).filter(r => r).map(r => r.split(','));

        if (rows.length < 4) return null;

        const headerRowIndices = []; 
        let currentIdx = 2;
        while(rows[0][currentIdx] && rows[1][currentIdx]) {
            headerRowIndices.push(currentIdx);
            currentIdx++;
        }
        
        const VOTES_COL = currentIdx; 
        const INVALID_COL = currentIdx + 1;
        const ELIGIBLE_COL = currentIdx + 2;

        const candInfo = [];
        let independentCounter = 1;
        
        headerRowIndices.forEach(colIndex => {
            const number = rows[0][colIndex] ? rows[0][colIndex].trim() : '';
            let name = rows[1][colIndex] ? rows[1][colIndex].trim() : '';
            let party = rows[2][colIndex] ? rows[2][colIndex].trim() : '';
            
            name = name.replace('*', '').trim(); 
            party = party === 'ç„¡' ? 'ç„¡é»¨ç±' : party;

            if (name && number) {
                 if (party === 'ç„¡é»¨ç±') {
                    if (!partyColors[`ç„¡é»¨ç±-${independentCounter}`] && independentCounter <= 4) {
                       partyColors[`ç„¡é»¨ç±-${independentCounter}`] = partyColors['ç„¡é»¨ç±']; 
                    }
                    party = `ç„¡é»¨ç±-${independentCounter}`;
                    independentCounter++;
                }

                candInfo.push({ number: String(number), name, party, colIndex }); 
            }
        });
        
        const candidates = {}; 
        let globalValidVotes = 0; 
        let globalInvalidVotes = 0; 
        let globalEligibleVoters = 0; 
        
        for (let i = 3; i < rows.length; i++) {
            const row = rows[i];
            
            if (row.length < (ELIGIBLE_COL + 1) || !row[0] || row[0].includes("é„‰é®")) continue;

            const parseNum = (val) => parseInt(String(val).replace(/[^0-9]/g, '')) || 0;

            const validVotes = parseNum(row[VOTES_COL]); 
            const invalidVotes = parseNum(row[INVALID_COL]); 
            const eligibleVoters = parseNum(row[ELIGIBLE_COL]); 
            
            globalValidVotes += validVotes;
            globalInvalidVotes += invalidVotes;
            globalEligibleVoters += eligibleVoters;
            
            candInfo.forEach(c => {
                const votes = parseNum(row[c.colIndex]);
                
                if (!candidates[c.name]) candidates[c.name] = { number: c.number, party: c.party, votes: 0 };
                candidates[c.name].votes += votes;
            });
        }
        
        let allCandidatesList = Object.keys(candidates).map(key => ({ name: key, ...candidates[key] }));
        
        return {
            allCandidates: allCandidatesList,
            metadata: {
                validVotes: globalValidVotes,
                invalidVotes: globalInvalidVotes,
                eligibleVoters: globalEligibleVoters
            }
        };
    }
    
    async function loadAllElectionSummaries(elections) {
        const summaryPromises = elections.map(async e => {
            try {
                const response = await fetch(e.file);
                if (!response.ok) throw new Error("æª”æ¡ˆè®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆåç¨±èˆ‡è·¯å¾‘ã€‚");
                const csvText = await response.text();
                
                const summary = extractCountySummary(csvText);
                
                if (summary) {
                    const sortedAllCands = getSortedCandidatesFromList(summary.allCandidates, { key: 'votes', direction: 'desc' });
                    
                    e.summaryData = {
                        allCandidates: sortedAllCands,
                        metadata: summary.metadata,
                        topCandidates: sortedAllCands.slice(0, 3),
                        // *** æ–°å¢ï¼šç‚ºæ‘˜è¦å¡ç‰‡åˆå§‹åŒ–æœ¬åœ°æ’åºé…ç½® ***
                        sortConfig: { key: 'votes', direction: 'desc' } 
                    };
                    
                } else {
                    e.summaryData = null;
                }
            } catch (error) {
                console.error(`è¼‰å…¥ ${e.file} æ‘˜è¦å¤±æ•—:`, error.message);
                e.summaryData = null; 
            }
            return e;
        });

        await Promise.all(summaryPromises);
    }

    // ================= æ’åºèˆ‡æ›´æ–°é‚è¼¯ (å·²ä¿®æ­£) =================
    
    window.sortTable = function(key) {
        
        const currentKey = appState.sortConfig.key;
        const currentDirection = appState.sortConfig.direction;
        
        let newDirection = 'desc'; 
        
        if (key === 'number' || key === 'name' || key === 'party') {
             newDirection = 'asc'; 
        }

        if (currentKey === key) {
            newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
        }

        appState.sortConfig = { key: key, direction: newDirection };

        if (appState.currentLevel === 'county') {
            renderCounty(false); 
        } else if (appState.currentLevel === 'town') {
            renderTown(appState.currentTown, false); 
        }
        // updateSortIcons() æœƒåœ¨ renderCounty(false)/renderTown(false) å…§éƒ¨è¢«å‘¼å«
    };
    
    /**
     * å°ˆé–€ç”¨æ–¼æ‘˜è¦å¡ç‰‡ (isSummary=true) çš„æœ¬åœ°æ’åºåŠŸèƒ½
     * @param {string} cardId - å¡ç‰‡çš„ ID
     * @param {string} key - æ’åºéµ
     */
    window.sortTableInCard = function(cardId, key) {
        
        // 1. æ‰¾åˆ°å°æ‡‰çš„ Election ç‰©ä»¶ (é€éå¡ç‰‡ ID åæŸ¥)
        const election = availableElections.find(e => `summary-${e.file.replace(/[^a-zA-Z0-9]/g, '-')}` === cardId);

        if (!election || !election.summaryData) return;
        
        let { sortConfig, allCandidates, metadata } = election.summaryData;
        
        // 2. ç¢ºå®šæ–°çš„æ’åºæ–¹å‘
        const currentKey = sortConfig.key;
        const currentDirection = sortConfig.direction;
        
        let newDirection = 'desc'; 
        
        if (key === 'number' || key === 'name' || key === 'party') {
             newDirection = 'asc'; 
        }

        if (currentKey === key) {
            newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
        }

        sortConfig = { key: key, direction: newDirection }; // Update local sort config
        election.summaryData.sortConfig = sortConfig; // Save back to object

        // 3. æ’åºè³‡æ–™
        const sortedList = getSortedCandidatesFromList(allCandidates, sortConfig);
        
        // 4. æ›´æ–°è¡¨æ ¼å…§å®¹
        updateTableContent(cardId, sortedList, metadata.validVotes); 
        
        // 5. æ›´æ–°å¡ç‰‡çš„æ’åºåœ–æ¨™
        updateSortIconsInCard(cardId, sortConfig);
    };

    function getSortedCandidates(candObj) {
        let list = Object.keys(candObj).map(key => ({ name: key, ...candObj[key] }));
        const { key, direction } = appState.sortConfig;
        
        list.sort((a, b) => {
            let valA = a[key], valB = b[key];

            if (key === 'number' || key === 'votes') { 
                valA = parseInt(valA) || 0; 
                valB = parseInt(valB) || 0;
            } else if (typeof valA === 'string') {
                 valA = valA.toLowerCase();
                 valB = valB.toLowerCase();
            }

            let comparison = 0;
            if (valA < valB) {
                comparison = -1;
            } else if (valA > valB) {
                comparison = 1;
            }

            return direction === 'asc' ? comparison : comparison * -1;
        });
        
        return list;
    }
    
    function getSortedCandidatesFromList(list, sortConfig = { key: 'votes', direction: 'desc' }) {
        let { key, direction } = sortConfig;
        
        list.sort((a, b) => {
            let valA = a[key], valB = b[key];

            if (key === 'number' || key === 'votes') { 
                valA = parseInt(valA) || 0; 
                valB = parseInt(valB) || 0;
            } else if (typeof valA === 'string') {
                 valA = valA.toLowerCase();
                 valB = valB.toLowerCase();
            }

            let comparison = 0;
            if (valA < valB) {
                comparison = -1;
            } else if (valA > valB) {
                comparison = 1;
            }

            return direction === 'asc' ? comparison : comparison * -1;
        });
        
        return list;
    }
    
    /**
     * ç”Ÿæˆè¡¨æ ¼å…§å®¹ HTML (ä½¿ç”¨å…¨åˆ—èƒŒæ™¯é•·æ¢åœ–)
     */
    function generateTableBodyHTML(candidates, validVotes) {
        return candidates.map(c => {
            const rate = validVotes > 0 ? (c.votes / validVotes * 100).toFixed(2) : 0;
            const partyColorHex = getPartyColor(c.party); 
            
            // è½‰æ›ç‚º RGBï¼Œä¸¦ä½¿ç”¨ 10% é€æ˜åº¦
            const rgb = hexToRgb(partyColorHex);
            const lightColorRGBA = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.10)`; 
            
            // ä½¿ç”¨ CSS linear-gradient å¯¦ç¾å…¨åˆ—èƒŒæ™¯é•·æ¢åœ–
            const rowStyle = `
                background-image: linear-gradient(
                    to right, 
                    ${lightColorRGBA} 0%, 
                    ${lightColorRGBA} ${rate}%,
                    transparent ${rate}%,
                    transparent 100%
                );
            `;
            
            const badgeClass = 'number-badge'; 
            
            // å–å¾—é•·/çŸ­åç¨±
            const partyLongName = getLongPartyName(c.party); 
            const partyShortName = getShortPartyName(c.party);
            
            return `
                <tr style="${rowStyle}">
                    <td class="number-cell col-number">
                        <span class="${badgeClass}">${c.number}</span>
                    </td>
                    <td style="font-weight:700">${c.name}</td>
                    <td class="party-cell col-party">
                        <span class="party-badge party-long" style="background:${partyColorHex}">${partyLongName}</span>
                        <span class="party-badge party-short" style="background:${partyColorHex}">${partyShortName}</span>
                    </td>
                    <td style="text-align:right">${c.votes.toLocaleString()}</td>
                    <td style="text-align:right; font-weight:bold; color:${partyColorHex}">${rate}%</td>
                </tr>
            `;
        }).join('');
    }
    
    function updateTableContent(cardId, candidates, validVotes) {
        const mainTableBody = document.querySelector(`#card-${cardId} table tbody`); 
        if (mainTableBody) {
             mainTableBody.innerHTML = generateTableBodyHTML(candidates, validVotes);
        }
        // æ’åºåœ–æ¨™æ›´æ–°åœ¨ sortTableInCard æˆ– renderCounty/renderTown ä¸­å–®ç¨è™•ç†
    }
    
    /**
     * å…¨åŸŸæ’åºåœ–æ¨™æ›´æ–° (ç”¨æ–¼è©³ç´°é é¢)
     */
    function updateSortIcons() {
        const { key, direction } = appState.sortConfig;
        document.querySelectorAll('th .sort-icon').forEach(icon => {
            const iconKey = icon.getAttribute('data-key');
            icon.className = 'sort-icon'; 
            if (iconKey === key) {
                icon.classList.add(direction); 
            }
        });
    }

    /**
     * å–®ä¸€å¡ç‰‡æ’åºåœ–æ¨™æ›´æ–° (ç”¨æ–¼æ‘˜è¦å¡ç‰‡)
     */
    function updateSortIconsInCard(cardId, sortConfig) {
        const { key, direction } = sortConfig;
        const cardElement = document.getElementById(`card-${cardId}`);
        if (!cardElement) return;

        // åƒ…æŸ¥æ‰¾è©²å¡ç‰‡å…§çš„æ’åºåœ–æ¨™
        cardElement.querySelectorAll('th .sort-icon').forEach(icon => {
            const iconKey = icon.getAttribute('data-key');
            icon.className = 'sort-icon'; 
            if (iconKey === key) {
                icon.classList.add(direction); 
            }
        });
    }

    // ================= é é¢æ¸²æŸ“å‡½å¼ (å·²ä¿®æ­£) =================
    
    function generateSummaryCardHTML(election) {
        if (!election.summaryData) {
            return `<div class="card failed">
                <div class="card-title">${election.uiName}</div>
                <div class="card-stats" style="color:red; margin-left:0;">è³‡æ–™è¼‰å…¥å¤±æ•—æˆ–æª”æ¡ˆéºå¤±ã€‚</div>
            </div>`;
        }
        // *** å–å¾—æœ¬åœ°æ’åºé…ç½® ***
        const { allCandidates, metadata, sortConfig } = election.summaryData;
        const cardId = `summary-${election.file.replace(/[^a-zA-Z0-9]/g, '-')}`;

        return generateCardHTML(
            cardId, 
            election.uiName, 
            allCandidates, 
            metadata, 
            true, 
            `loadData('${election.file}', '${election.uiName}')`, 
            true, // isCompact
            true,  // isSummary
            sortConfig // *** å‚³éæœ¬åœ°æ’åºé…ç½® ***
        );
    }

    window.renderMainMenu = function() {
        appState.currentLevel = 'mainMenu';
        window.scrollTo(0, 0); 
        updateBreadcrumb(); 
        
        // æ¸…ç†æ‰€æœ‰ Chart å¯¦ä¾‹
        appState.chartInstances.forEach(chart => chart.destroy()); 
        appState.chartInstances = [];
        

        let html = '';

        // 1. ä¸»è¦æŒ‰éˆ•é¸å–®
        html += `<div class="main-section">
            <div class="menu-section-title">ä¾é¸èˆ‰é¡åˆ¥ç€è¦½</div>
            <div class="main-menu-grid">`;
        
        // ç§»é™¤å†—é¤˜çš„ iconMappingï¼Œç›´æ¥ä½¿ç”¨ cat.icon
        electionCategories.forEach(cat => {
            html += `<div class="menu-button" onclick="renderElectionList('${cat.type}')">
                <span class="menu-icon">${cat.icon}</span>
                <span class="menu-text">${cat.type}</span>
            </div>`;
        });
        html += `</div></div>`;

        // 2. è¿‘æœŸé¸èˆ‰ (ä½¿ç”¨æ‘˜è¦å¡ç‰‡)
        const recentElections = [...availableElections].sort((a, b) => {
            return parseInt(b.year) - parseInt(a.year); 
        }).slice(0, 8); 

        if (recentElections.length > 0) {
            // *** ä¿®æ­£ 1.1: ç§»é™¤ã€Œè¿‘æœŸé¸èˆ‰ã€æ¨™é¡Œå‰çš„åœ–ç¤º ***
            html += `<div class="main-section">
                <div class="menu-section-title">è¿‘æœŸé¸èˆ‰</div>
                <div class="election-list-grid">`;
            
            recentElections.forEach(e => {
                html += generateSummaryCardHTML(e);
            });
            html += `</div></div>`;
        }

        dom.content.innerHTML = html;
        // æ‘˜è¦å¡ç‰‡æ’åºåœ–æ¨™æœƒåœ¨ generateSummaryCardHTML -> generateCardHTML æ™‚æ¸²æŸ“
    };
    
    window.renderElectionList = function(type) {
        appState.currentLevel = 'electionList';
        appState.currentTown = type; 
        window.scrollTo(0, 0); 
        updateBreadcrumb(); 
        
        // æ¸…ç†æ‰€æœ‰ Chart å¯¦ä¾‹
        appState.chartInstances.forEach(chart => chart.destroy()); 
        appState.chartInstances = [];

        const matchingElections = availableElections.filter(e => e.type === type);
        matchingElections.sort((a, b) => b.year - a.year); 

        // *** ä¿®æ­£ 1.2: ç§»é™¤ã€Œé¸èˆ‰åˆ—è¡¨ã€æ¨™é¡Œå‰çš„åœ–ç¤º ***
        let html = `<div class="main-section">
            <div class="menu-section-title">${type} é¸èˆ‰åˆ—è¡¨</div>
        </div>`;
        
        if (matchingElections.length > 0) {
            html += `<div class="election-list-grid">`;
            matchingElections.forEach(e => {
                html += generateSummaryCardHTML(e); 
            });
            html += `</div>`;
        } else {
             html += `<div class="loading-state" style="padding:40px;">è©²é¡åˆ¥ç›®å‰ç„¡è³‡æ–™å¯ä¾›æŸ¥è©¢ã€‚</div>`;
        }

        dom.content.innerHTML = html;
        // æ‘˜è¦å¡ç‰‡æ’åºåœ–æ¨™æœƒåœ¨ generateSummaryCardHTML -> generateCardHTML æ™‚æ¸²æŸ“
    };

    /**
     * æ¸²æŸ“åœ“é¤…åœ–çš„å‡½å¼ (ä¿ç•™ï¼Œä½†ç›®å‰ä¸æœƒè¢«å‘¼å«)
     */
    function renderPieChart(canvasId, candidates, totalVotes) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        
        // å…ˆéŠ·æ¯€èˆŠçš„ Chart å¯¦ä¾‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const existingChart = appState.chartInstances.find(chart => chart.canvas.id === canvasId);
        if (existingChart) existingChart.destroy();
        
        // éæ¿¾æ‰å¾—ç¥¨æ•¸ç‚º 0 çš„å€™é¸äººï¼Œç¢ºä¿åœ–è¡¨ä¹¾æ·¨
        const displayCandidates = candidates.filter(c => c.votes > 0);

        const labels = displayCandidates.map(c => c.name);
        const data = displayCandidates.map(c => c.votes);
        const colors = displayCandidates.map(c => getPartyColor(c.party));
        
        // è¨ˆç®—åœ–ä¾‹æ˜¯å¦éœ€è¦éš±è— (å€™é¸äººè¶…é 6 å€‹æ™‚éš±è—)
        const hideLegend = labels.length > 6;

        const chart = new Chart(canvas, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    hoverBackgroundColor: colors,
                    borderColor: 'white',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: !hideLegend, 
                        position: 'bottom',
                        labels: { boxWidth: 12, padding: 10, font: { size: 11 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const percentage = totalVotes > 0 ? (value / totalVotes * 100).toFixed(2) : 0;
                                return [
                                    `${context.label}: ${value.toLocaleString()} ç¥¨`,
                                    `å¾—ç¥¨ç‡: ${percentage}%`
                                ];
                            },
                            title: function(context) {
                                return context[0].label; 
                            }
                        }
                    }
                },
                layout: { padding: 0 }
            }
        });
        appState.chartInstances.push(chart);
    }
    
    // ================= å„€è¡¨æ¿æ ¸å¿ƒæ¸²æŸ“é‚è¼¯ (å·²ä¿®æ­£) =================
    
    window.renderCounty = function(shouldScroll = true) {
        // æ³¨æ„ï¼šé€™è£¡å–å¾—çš„ candidates å·²ç¶“æ˜¯æ’åºéçš„
        const candidates = getSortedCandidates(appState.data.county); 
        const metadata = appState.countyMetadata;
        
        if (!shouldScroll) {
            updateTableContent('county-main', candidates, metadata.validVotes);
            
            appState.data.townOrder.forEach(town => {
                const townData = appState.data.towns[town];
                const townCands = getSortedCandidates(townData.candidates);
                updateTableContent(`town-${town}`, townCands, townData.validVotes);
            });
            updateSortIcons(); // *** ä¿®æ­£: åœ¨æ›´æ–°æ¨¡å¼ä¸‹å‘¼å«å…¨åŸŸåœ–æ¨™æ›´æ–° ***
            return; 
        }

        appState.currentLevel = 'county';
        appState.currentTown = null;
        window.scrollTo(0,0); 
        updateBreadcrumb();

        // *** ä¿®æ­£ 3.1: å°‡ Election Summary Panel ç§»åˆ° Table å¡ç‰‡ä¹‹å‰ ***
        let html = `<div class="main-section">
            <div class="section-header"><span class="section-title">${appState.electionName}</span></div>
            <div class="top-summary-grid">
                ${generateSummaryPanelHTML(candidates, metadata, "å…¨ç¸£")}
                ${generateCardHTML('county-main', 'å…¨ç¸£é–‹ç¥¨çµæœ', candidates, metadata, false, false, true, false)}
            </div>
        </div>`;

        html += `<div class="main-section">
            <div class="section-header"><span class="section-title">å„é„‰é®é–‹ç¥¨çµæœ</span><span class="section-badge">é»æ“Šå¡ç‰‡çœ‹ç´°ç¯€</span></div>
            <div class="sub-area-grid">`;
        
        appState.data.townOrder.forEach(town => {
            const townData = appState.data.towns[town];
            const townCands = getSortedCandidates(townData.candidates);
            
            const townMetadata = {
                validVotes: townData.validVotes,
                invalidVotes: townData.invalidVotes,
                eligibleVoters: townData.eligibleVoters
            };

            html += generateCardHTML(`town-${town}`, town, townCands, townMetadata, true, `renderTown('${town}')`, true, false);
        });
        html += `</div></div>`;

        dom.content.innerHTML = html;
        updateSortIcons();
    };

    window.renderTown = function(townName, shouldScroll = true) {
        const townData = appState.data.towns[townName];
        const candidates = getSortedCandidates(townData.candidates);
        const townMetadata = {
            validVotes: townData.validVotes,
            invalidVotes: townData.invalidVotes,
            eligibleVoters: townData.eligibleVoters
        };
        
        if (!shouldScroll) {
            updateTableContent('town-main', candidates, townMetadata.validVotes);
            
            const villageList = Object.keys(townData.villages);
            villageList.forEach(village => {
                const vData = townData.villages[village];
                const vCands = getSortedCandidates(vData.candidates);
                updateTableContent(`village-${village}`, vCands, vData.validVotes);
            });
            updateSortIcons(); // *** ä¿®æ­£: åœ¨æ›´æ–°æ¨¡å¼ä¸‹å‘¼å«å…¨åŸŸåœ–æ¨™æ›´æ–° ***
            return; 
        }
        
        appState.currentLevel = 'town';
        appState.currentTown = townName;
        window.scrollTo(0,0); 
        updateBreadcrumb();
        
        // æ¸…ç†æ‰€æœ‰ Chart å¯¦ä¾‹
        appState.chartInstances.forEach(chart => chart.destroy()); 
        appState.chartInstances = [];
        
        const villageList = Object.keys(townData.villages);

        // *** ä¿®æ­£ 3.2: å°‡ Election Summary Panel ç§»åˆ° Table å¡ç‰‡ä¹‹å‰ ***
        let html = `<div class="main-section">
            <div class="section-header"><span class="section-title">${townName} ç¸½è¨ˆ</span></div>
            <div class="top-summary-grid">
                ${generateSummaryPanelHTML(candidates, townMetadata, townName)}
                ${generateCardHTML('town-main', `${townName}é–‹ç¥¨çµæœ`, candidates, townMetadata, false, false, true, false)}
            </div>
        </div>`;

        html += `<div class="main-section">
            <div class="section-header"><span class="section-title">å„æ‘é‡Œé–‹ç¥¨çµæœ</span></div>
            <div class="sub-area-grid">`;
        
        villageList.forEach(village => {
            const vData = townData.villages[village];
            const vCands = getSortedCandidates(vData.candidates);
            
            const villageMetadata = {
                validVotes: vData.validVotes,
                invalidVotes: vData.invalidVotes,
                eligibleVoters: vData.eligibleVoters
            };

            html += generateCardHTML(`village-${village}`, village, vCands, villageMetadata, false, null, true, false);
        });
        html += `</div></div>`;

        dom.content.innerHTML = html;
        updateSortIcons();
    };

    // ================= é€šç”¨è¼”åŠ©å‡½å¼ (å·²ä¿®æ­£) =================

    function updateBreadcrumb() {
        const level = appState.currentLevel;
        let html = '';

        if (level === 'mainMenu') {
            dom.breadcrumb.style.display = 'none';
            dom.breadcrumbBottom.style.display = 'none';
            return;
        }

        html += `<span onclick="renderMainMenu()">é¦–é </span> / `;

        if (level === 'electionList') {
            html += `<span class="active">${appState.currentTown}</span>`;
        } else if (level === 'county') {
            const electionType = availableElections.find(e => e.uiName === appState.electionName).type;
            html += `<span onclick="renderElectionList('${electionType}')">${electionType}</span> / `;
            html += `<span class="active">${appState.electionName}</span>`;
        } else if (level === 'town') {
             const electionType = availableElections.find(e => e.uiName === appState.electionName).type;
             html += `<span onclick="renderElectionList('${electionType}')">${electionType}</span> / `;
             html += `<span onclick="renderCounty(true)">${appState.electionName}</span> / `;
             html += `<span class="active">${appState.currentTown}</span>`;
        }

        dom.breadcrumb.innerHTML = html;
        dom.breadcrumb.style.display = 'block';
        dom.breadcrumbBottom.innerHTML = html;
        dom.breadcrumbBottom.style.display = 'block';
    }
    
    /**
     * ç”Ÿæˆå³å´æ‘˜è¦é¢æ¿çš„ HTML (å·²å°‡ã€Œé¸èˆ‰æ¦‚æ³ã€æ”¹ç‚ºã€ŒæŠ•ç¥¨æ¦‚æ³ã€)
     */
    function generateSummaryPanelHTML(candidates, metadata, title) {
        const { validVotes, invalidVotes, eligibleVoters } = metadata;
        const totalBallots = validVotes + invalidVotes;
        const turnoutRate = eligibleVoters > 0 ? (totalBallots / eligibleVoters * 100).toFixed(2) : "0.00";
        
        // *** ä¿®æ­£ 1: å°‡ã€Œé¸èˆ‰æ¦‚æ³ã€æ”¹ç‚ºã€ŒæŠ•ç¥¨æ¦‚æ³ã€ ***
        let html = `
        <div class="summary-panel">
            <h3>æŠ•ç¥¨æ¦‚æ³ (${title})</h3>
            <ul class="summary-list">
                <li><span>æŠ•ç¥¨ç‡</span><span class="stat-value" style="color:#d9534f;">${turnoutRate}%</span></li>
                <li><span>æœ‰æ•ˆç¥¨æ•¸</span><span class="stat-value">${validVotes.toLocaleString()} ç¥¨</span></li>
                <li><span>ç„¡æ•ˆç¥¨æ•¸</span><span class="stat-value">${invalidVotes.toLocaleString()} ç¥¨</span></li>
                <li><span>é¸èˆ‰äººæ•¸</span><span class="stat-value">${eligibleVoters.toLocaleString()} äºº</span></li>
            </ul>
        `;
        
        // åŸæœ¬å·²ç§»é™¤ç•¶é¸è€…å€å¡Šï¼Œæ­¤è™•ä¿æŒä¸è®Š

        html += `</div>`; // çµæŸ summary-panel div
        return html;
    }


    /**
     * ç”Ÿæˆå¡ç‰‡ HTML (é€šç”¨æ¨¡æ¿)
     */
    function generateCardHTML(id, title, candidates, metadata, isClickable, onClickAction, isCompact = false, isSummary = false, localSortConfig = null) {
        
        const clickClass = isClickable ? 'clickable' : '';
        const clickAttr = isClickable ? `onclick="${onClickAction}"` : '';
        
        const actionText = isClickable ? `<span class="card-action">æŸ¥çœ‹è©³æƒ… âœ</span>` : '';
        
        const summaryClass = isSummary ? 'is-summary' : '';
        
        // åªæœ‰éç·Šæ¹Šæ¨¡å¼ä¸”éæ‘˜è¦æ¨¡å¼æ‰ä½¿ç”¨ large-table (ç¾å·²åœç”¨ï¼Œæ”¹ç”¨ç·Šæ¹Šæ¨¡å¼)
        const tableSizeClass = isCompact ? '' : ' large-table';
        
        const { validVotes, invalidVotes, eligibleVoters } = metadata;
        
        const totalBallots = validVotes + invalidVotes;
        const turnoutRate = eligibleVoters > 0 ? (totalBallots / eligibleVoters * 100).toFixed(2) : "0.00";

        // çµ±è¨ˆæ•¸æ“š HTML 
        let cardStatsHTML;
        if (isSummary || isCompact) {
             cardStatsHTML = `
                <div class="card-stats" style="margin-left: 0;">
                    <span style="white-space: nowrap;">
                        æœ‰æ•ˆç¥¨: ${validVotes.toLocaleString()} ç¥¨ 
                        <span style="color:var(--text-sub); margin: 0 5px;">|</span>
                        æŠ•ç¥¨ç‡: <span class="rate">${turnoutRate}%</span>
                    </span>
                </div>
            `;
        } else {
             cardStatsHTML = `
                <div class="card-stats">
                    <span style="font-size:14px;">æœ‰æ•ˆç¥¨: ${validVotes.toLocaleString()} ç¥¨</span> 
                    | ç„¡æ•ˆç¥¨: ${invalidVotes.toLocaleString()} ç¥¨ 
                    <br>
                    <span style="white-space: nowrap;">
                        é¸èˆ‰äººæ•¸: ${eligibleVoters.toLocaleString()} äºº 
                        | æŠ•ç¥¨ç‡: <span class="rate">${turnoutRate}%</span>
                    </span>
                </div>
            `;
        }


        // *** æ ¹æ“šå¡ç‰‡é¡å‹é¸æ“‡æ’åºé…ç½® ***
        const currentConfig = isSummary ? localSortConfig : appState.sortConfig;
        const { key: currentSortKey, direction: currentSortDirection } = currentConfig;

        function renderTableHeader(title, sortKey, style = '', className = '') {
            
            const isCurrentKey = currentSortKey === sortKey;
            const iconClass = isCurrentKey ? currentSortDirection : '';
            const iconHtml = `<span data-key="${sortKey}" class="sort-icon ${iconClass}"></span>`;
            
            let headerTextHtml = title;
            let finalClassName = className;

            // è™•ç† 'party' (æ¨è–¦æ”¿é»¨) æ¬„ä½çš„æ¨™é¡Œé¡¯ç¤º
            if (sortKey === 'party') {
                headerTextHtml = `<span class="party-title-desktop">æ¨è–¦æ”¿é»¨</span><span class="party-title-mobile">æ”¿é»¨</span>`;
                finalClassName = `${className} col-party`;
            }

            // *** ä¿®æ­£: æ‘˜è¦å¡ç‰‡å‘¼å«æœ¬åœ°æ’åºå‡½å¼ï¼Œè©³ç´°é é¢å‘¼å«å…¨åŸŸæ’åºå‡½å¼ ***
            const sortAction = isSummary 
                ? `sortTableInCard('${id}', '${sortKey}')` 
                : `sortTable('${sortKey}')`;
            
            // çµ±ä¸€å•Ÿç”¨æ’åºï¼Œä¸¦ç¢ºä¿é˜»æ­¢äº‹ä»¶å†’æ³¡
            return `<th style="${style}" class="${finalClassName}" onclick="event.stopPropagation(); ${sortAction}">${headerTextHtml} ${iconHtml}</th>`;
        }
        
        const tableBodyHTML = generateTableBodyHTML(candidates, validVotes);
        
        return `
        <div class="card ${clickClass} ${summaryClass}" ${clickAttr} id="card-${id}">
            <div class="card-header">
                <div class="card-header-left">
                    <div class="card-title">${title}</div>
                    ${cardStatsHTML}
                </div>
                ${actionText}
            </div>
            <div class="table-area table-responsive">
                <table class="${tableSizeClass}">
                    <thead>
                        <tr>
                            ${renderTableHeader('#', 'number', 'width:40px; text-align:center;', 'col-number')} 
                            ${renderTableHeader('å€™é¸äºº', 'name', '', '')}
                            ${renderTableHeader('æ¨è–¦æ”¿é»¨', 'party', '', 'col-party')}
                            ${renderTableHeader('å¾—ç¥¨', 'votes', 'text-align:right')}
                            ${renderTableHeader('%', 'votes', 'text-align:right; width:50px')}
                        </tr>
                    </thead>
                    <tbody>
                        ${tableBodyHTML}
                    </tbody>
                </table>
            </div>
        </div>`;
    }


    // ================= åˆå§‹åŒ– =================

    (function init() {
        dom.content.innerHTML = `<div class="loading-state">æ­£åœ¨è¼‰å…¥æ‰€æœ‰é¸èˆ‰æ‘˜è¦æ•¸æ“š...è«‹ç¨å€™ã€‚</div>`;
        loadAllElectionSummaries(availableElections).then(() => {
            renderMainMenu(); 
        });
    })();
</script>
</body>
</html>
