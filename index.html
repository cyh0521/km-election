<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈáëÈñÄÈÅ∏ËàâË≥áÊñôÂ∫´</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #3887B0;
            --secondary: #2c3e50; 
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --border: #e1e4e8;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        
        body { 
            font-family:'Noto Sans TC', sans-serif; 
            background:var(--bg); 
            color:var(--text-main); 
            line-height:1.6; 
            padding-bottom: 20px; 
            padding-top: 50px; 
        }
        
        /* ÁΩÆÈ†ÇÊ®ôÈ°åÂàóÊ®£Âºè */
        header { 
            background: var(--secondary); 
            color: white; 
            padding: 10px 20px; 
            text-align: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            position: fixed; 
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000; 
        }
        
        h1 { font-size: 20px; font-weight: 700; margin: 0; }
        h1 span { cursor: pointer; } 
        
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        
        /* --- ‰∏ªÈÅ∏ÂñÆÊ®£Âºè --- */
        .main-menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 15px; 
            margin-bottom: 50px;
        }

        .menu-button {
            background: var(--card-bg);
            border: 1px solid var(--border); 
            border-radius: 8px; 
            padding: 15px 20px; 
            text-align: center;
            font-size: 16px; 
            font-weight: 500; 
            color: var(--secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            line-height: 1.4;
        }
        
        .menu-button:hover {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
            transform: translateY(-2px); 
            box-shadow: 0 4px 10px rgba(56, 135, 176, 0.2);
        }
        
        .menu-icon { 
            display: block; 
            font-size: 32px; 
            margin-bottom: 8px; 
            line-height: 1;
        } 
        
        .menu-text { display: block; }

        .menu-section-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        /* --- ÈÅ∏ËàâÂàóË°® / ÊëòË¶ÅÂç°ÁâáÊ®£Âºè --- */
        .election-list-grid {
             column-count: 2; 
             column-gap: 20px; 
             margin-top: 20px;
        }
        
        .election-list-grid .card {
            display: inline-block; 
            width: 100%; 
            margin-bottom: 20px; 
            page-break-inside: avoid; 
            break-inside: avoid-column; 
        }
        
        /* --- È∫µÂåÖÂ±ë --- */
        .breadcrumb { margin-bottom: 20px; font-size: 16px; color: var(--text-sub); padding: 10px 0; }
        #breadcrumb-bottom { margin-top: 40px; border-top: 1px solid var(--border); padding-top: 20px; }
        .breadcrumb span { cursor: pointer; color: var(--primary); font-weight: 500; }
        .breadcrumb span:hover { text-decoration: underline; }
        .breadcrumb span.active { color: var(--text-main); cursor: default; text-decoration: none; }
        
        .main-section { margin-bottom: 40px; }
        .section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--border); }
        .section-title { font-size: 22px; font-weight: 700; color: var(--text-main); }
        .section-badge { background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 13px; }

        /* Âç°Áâá‰∏ªÈ´î */
        .card { background: var(--card-bg); border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 20px; overflow: hidden; border: 1px solid transparent; transition: all 0.2s; margin-bottom: 0; }
        .card.clickable { cursor: pointer; }
        .card.clickable:hover { transform: translateY(-3px); border-color: var(--primary); box-shadow: 0 8px 15px rgba(56, 135, 176, 0.15); }
        
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 15px; 
            overflow: hidden; 
        }
        .card-header-left { 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 1; 
            min-width: 0;
        }
        
        .card-title { font-size: 18px; font-weight: 700; color: var(--text-main); border-left: 4px solid var(--primary); padding-left: 10px; line-height: 1.2; }
        
        .card-stats { 
            font-size: 13px; 
            color: var(--text-main); 
            margin-top: 5px; 
            margin-left: 14px; 
            font-weight: 500; 
            line-height: 1.8; 
        }
        
        .card-stats strong { font-weight: 500; color: var(--text-main); }
        .card-stats .rate { color: #d9534f; font-weight: 700; }
        
        .card.is-summary .card-stats {
            margin-top: 5px; margin-left: 14px; font-size: 14px; line-height: 1.5; color: var(--text-main);
        }
        .card.is-summary .card-stats strong { color: var(--text-main); font-weight: 500; }
        .card.is-summary .card-stats .rate { color: #d9534f; font-weight: 500; }

        .card-action { 
            font-size: 14px; color: var(--primary); font-weight: 500; white-space: nowrap; margin-left: 10px; flex-shrink: 0; align-self: flex-start; padding-top: 2px; 
        }
        
        .card-footer-info {
            margin-top: 5px; padding-top: 0px; font-size: 12px; color: var(--text-sub); text-align: left; font-weight: 500;
        }

        .sub-area-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(480px, 1fr)); gap: 15px; }
        
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; table-layout: auto; } 
        
        tr { position: relative; z-index: 1; transition: background-color 0.3s ease, border-color 0.3s ease; }
        tr:hover { background-color: rgba(0, 0, 0, 0.03); }

        @keyframes bar-grow {
            from { background-size: 0% 100%; }
            to { background-size: var(--bar-width) 100%; } 
        }

        tr.animate-bar-grow {
            background-repeat: no-repeat; 
            background-size: var(--bar-width) 100%; 
            animation: bar-grow 1s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            background-color: transparent !important; 
        }
        
        tr:not(.animate-bar-grow) {
             transition: background-size: 0.5s ease-in-out, background-color 0.3s ease;
             background-repeat: no-repeat;
             background-size: var(--bar-width) 100%; 
        }

        th { 
            background: #f8f9fa; color: #666; font-weight: 600; text-align: left; padding: 6px 8px; border-bottom: 2px solid var(--border); white-space: nowrap; font-size: 13px; cursor: pointer; position: relative; 
        }
        th:hover { background: #e9ecef; }
        td { 
            padding: 8px 8px; border-bottom: 1px solid var(--border); vertical-align: middle; position: relative; z-index: 2; 
        }
        
        table th:nth-child(1), table td:nth-child(1) { width: 40px; text-align: center; } 
        table td:nth-child(2) { padding-top: 6px; padding-bottom: 6px; line-height: 1.2; }
        table th:nth-last-child(2), table td:nth-last-child(2) { text-align: right; white-space: nowrap; } 
        table th:last-child, table td:last-child { width: 50px; text-align: right; white-space: nowrap; } 
        
        td.number-cell { text-align: center; }
        
        .sort-icon {
            display: inline-block; width: 0; height: 0; margin-left: 5px; vertical-align: middle; border-left: 4px solid transparent; border-right: 4px solid transparent; opacity: 0.3; 
        }
        .sort-icon.asc { border-bottom: 4px solid #333; opacity: 1; }
        .sort-icon.desc { border-top: 4px solid #333; opacity: 1; }
        
        .number-badge {
            display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; line-height: normal; background: #eee; border-radius: 50%; font-weight: 700; font-size: 13px; color: #555; vertical-align: middle; border: 2px solid #ffffff; box-shadow: 0 0 0 1px rgba(0,0,0,0.05); 
        }
        
        .number-badge.is-winner {
            border: 2px solid #d9534f; background: #ffffff; color: #d9534f; box-shadow: 0 0 0 1px rgba(217, 83, 79, 0.2);
        }

        .party-badge { font-size: 11px; padding: 2px 6px; border-radius: 8px; color: white; background: #999; white-space: nowrap; }
        
        .women-quota-badge {
            display: inline-block; font-size: 9px; font-weight: 500; color: #FFFFFF; background-color: #E90080; padding: 1px 4px; border-radius: 3px; margin-top: 2px; line-height: 1; white-space: nowrap; 
        }
        
        .incumbent-badge {
            display: inline-block; font-size: 9px; font-weight: 500; color: #FFFFFF; background-color: #d9534f; padding: 2px 2px; border-radius: 3px; margin-left: 2px; line-height: 1; white-space: nowrap; vertical-align: middle;
        }
        
        /* *** ‰øÆÊîπÔºöÂÄôÈÅ∏‰∫∫ÈÄ£ÁµêÊ®£Âºè *** */
        .candidate-name {
            display: block;
            font-weight: 700;
            color: inherit; /* ‰øùÊåÅÂéüËâ≤ */
        }
        .candidate-link {
            cursor: pointer;
        }
        .candidate-link:hover {
            text-decoration: underline; /* Èº†Ê®ôÊá∏ÂÅúÊôÇÂä†Â∫ïÁ∑öÊèêÁ§∫ÂèØÈªûÊìä */
        }

        .party-cell .party-long { display: inline-block; }
        .party-cell .party-short { display: none; }
        
        .col-party .party-title-desktop { display: inline; }
        .col-party .party-title-mobile { display: none; }
        
        /* *** Êñ∞Â¢ûÔºöÈö±ËóèÊîøÈª®Ê¨Ñ‰Ωç CSS *** */
        .col-party.hidden-party, 
        table th.col-party.hidden-party, 
        table td.col-party.hidden-party {
            display: none !important;
        }

        table.large-table { font-size: 17px; table-layout: auto; }
        table.large-table th { padding: 10px 10px; font-size: 14px; }
        table.large-table td { padding: 10px 10px; }
        table.large-table .number-badge { width: 26px; height: 26px; font-size: 14px; }
        table.large-table .party-badge { font-size: 12px; }
        table.large-table td:nth-child(2) { padding-top: 8px; padding-bottom: 8px; }


        .loading-state { text-align: center; padding: 60px; color: var(--text-sub); font-size: 18px; }
        
        .top-summary-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; margin-bottom: 40px; align-items: start;
        }

        .summary-panel {
            background: var(--card-bg); border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 20px; border: 1px solid var(--border);
        }
        .summary-panel h3 {
            font-size: 18px; font-weight: 700; color: var(--secondary); border-left: 4px solid var(--primary); padding-left: 10px; line-height: 1.2; margin-bottom: 15px;
        }
        .summary-list { list-style: none; padding: 0; margin: 0; font-size: 15px; }
        .summary-list li { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed var(--border); }
        .summary-list li:last-child { border-bottom: none; }
        .summary-list li.winner-row { display: block !important; border-bottom: none !important; line-height: 1.5; }
        .summary-list .stat-value { font-weight: 700; color: var(--text-main); }
        .summary-list .winner-name { color: var(--primary); font-size: 16px; }

        /* --- ÂÄôÈÅ∏‰∫∫ Modal Ê®£Âºè (Êñ∞Â¢û) --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none; /* È†êË®≠Èö±Ëóè */
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-card {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
            animation: modalFadeIn 0.3s ease;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            z-index: 10;
            width: 32px;
            height: 32px;
            text-align: center;
            line-height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.8);
        }
        .modal-close-btn:hover {
            color: #333;
            background: #eee;
        }
        .modal-body {
            padding: 25px;
        }
        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 20px;
        }
        .profile-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            background: #eee;
            border: 2px solid var(--border);
            flex-shrink: 0;
        }
        .profile-info h2 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--secondary);
        }
        .profile-detail {
            font-size: 14px;
            color: var(--text-sub);
        }
        .history-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--secondary);
            border-left: 4px solid var(--primary);
            padding-left: 10px;
        }
        .history-list {
            list-style: none;
        }
        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed var(--border);
            font-size: 14px;
        }
        .history-item:last-child { border-bottom: none; }
        .history-year-tag {
            background: #eee;
            color: #555;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 8px;
            font-weight: 500;
        }
        .history-name { font-weight: 500; color: var(--text-main); }
        .history-party { font-size: 12px; color: #888; margin-left: 5px; }
        .history-result { 
            font-weight: 700; 
            font-size: 13px;
        }
        .result-won { color: #d9534f; }
        .result-lost { color: #999; font-weight: 400; }

        @media (max-width: 768px) {
             .main-menu-grid { grid-template-columns: repeat(2, 1fr); }
             .menu-button { padding: 15px 5px; }
             .menu-text { font-size: 14px; }
             .election-list-grid { column-count: 1; }
             .layout-compact { flex-direction: column; align-items: center; }
             .layout-compact .table-area { width: 100%; }
            .layout-full { grid-template-columns: 1fr; }
            .sub-area-grid { grid-template-columns: 1fr; }
            .party-cell .party-long { display: none; }
            .party-cell .party-short { display: inline-block; }
            .party-badge { font-size: 11px; }
            table.large-table { font-size: 14px; }
            table.large-table th { padding: 6px 8px; font-size: 13px; }
            table.large-table td { padding: 8px 8px; }
            table.large-table .party-badge { font-size: 11px; }
            td.number-cell { text-align: center; line-height: 22px; }
            .number-badge { width: 22px; height: 22px; line-height: normal; font-size: 12px; vertical-align: middle; border: 2px solid #ffffff; }
            .number-badge.is-winner { border: 2px solid #d9534f; color: #d9534f; }
            .col-party .party-title-desktop { display: none; }
            .col-party .party-title-mobile { display: inline; }
            .top-summary-grid { grid-template-columns: 1fr; }
            table td:nth-child(2) { padding-top: 5px; padding-bottom: 5px; }
            
            /* Modal Mobile tweak */
            .profile-header { flex-direction: column; align-items: center; text-align: center; gap: 10px; }
        }
        
        footer {
            padding: 15px 15px;
            margin-top: 40px; 
            border-top: 1px solid var(--border); 
            background: #fafafa; 
            text-align: center; 
            font-size: 12px; 
            color: #999; 
            line-height: 1.6;
        }

        @media (min-width: 769px) {
            #footer-source { display: inline; }
        }
    </style>
</head>
<body>

<header>
    <h1><span onclick="renderMainMenu()">ÈáëÈñÄÈÅ∏ËàâË≥áÊñôÂ∫´</span></h1>
</header>

<div class="container">
    <div id="breadcrumb" class="breadcrumb" style="display:none;"></div>
    
    <div id="content">
        <div class="loading-state">Ë≥áÊñôËºâÂÖ•‰∏≠...</div>
    </div>

    <div id="breadcrumb-bottom" class="breadcrumb" style="display:none;"></div>
</div>

<footer>
    <span id="footer-source">Ë≥áÊñô‰æÜÊ∫êÔ∏±‰∏≠ÈÅ∏ÊúÉÈÅ∏ËàâÂèäÂÖ¨ÊäïË≥áÊñôÂ∫´ÔºéÊîøÂ§ßÈÅ∏Á†î‰∏≠ÂøÉË≥áÊñôÂ∫´</span><br>
    <span id="footer-source">v1128.1.1</span>
</footer>

<div id="candidate-modal" class="modal-overlay" onclick="closeModal()">
    <div class="modal-card" onclick="event.stopPropagation()">
        <span class="modal-close-btn" onclick="closeModal()">&times;</span>
        <div id="modal-body" class="modal-body">
            </div>
    </div>
</div>

<script>
    
    // ================= Êï∏ÊìöËàáË®≠ÂÆöÂçÄ =================
    
    const availableElections = [

        { 
            file: "2025_ÂÖ®ÂúãÊÄßÂÖ¨ÊäïÁ¨¨21Ê°à.csv", 
            year: "2025", 
            type: "ÂÖ®ÂúãÊÄßÂÖ¨Ê∞ëÊäïÁ•®", 
            uiName: "2025Âπ¥ ÂÖ®ÂúãÊÄßÂÖ¨ÊäïÁ¨¨21Ê°àÔºàÊ†∏‰∏âÂª∂ÂΩπÔºâ",
            summaryData: null
        },
        { 
            file: "2024_‰∏çÂàÜÂçÄÁ´ãÂßîÈÅ∏Ëàâ.csv", 
            year: "2024", 
            type: "Á´ãÊ≥ïÂßîÂì°", 
            uiName: "2024Âπ¥ ‰∏çÂàÜÂçÄÁ´ãÂßîÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "2024_ÈáëÈñÄÁ∏£Á´ãÂßîÈÅ∏Ëàâ.csv", 
            year: "2024", 
            type: "Á´ãÊ≥ïÂßîÂì°", 
            uiName: "2024Âπ¥ ÈáëÈñÄÁ∏£Á´ãÂßîÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "2024_Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±ÈÅ∏Ëàâ.csv", 
            year: "2024", 
            type: "Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±", 
            uiName: "2024Âπ¥ Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±ÈÅ∏Ëàâ",
            summaryData: null 
        },
        { 
            file: "2022_Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨3ÈÅ∏ÂçÄ.csv", 
            year: "2022", 
            type: "Á∏£Ë≠∞Âì°", 
            uiName: "2022Âπ¥ Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨3ÈÅ∏ÂçÄ",
            summaryData: null
        },
        { 
            file: "2022_Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨2ÈÅ∏ÂçÄ.csv", 
            year: "2022", 
            type: "Á∏£Ë≠∞Âì°", 
            uiName: "2022Âπ¥ Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨2ÈÅ∏ÂçÄ",
            summaryData: null
        },
        { 
            file: "2022_Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨1ÈÅ∏ÂçÄ.csv", 
            year: "2022", 
            type: "Á∏£Ë≠∞Âì°", 
            uiName: "2022Âπ¥ Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨1ÈÅ∏ÂçÄ",
            summaryData: null
        },
        { 
            file: "2022_ÈáëÈñÄÁ∏£Èï∑ÈÅ∏Ëàâ.csv", 
            year: "2022", 
            type: "Á∏£Èï∑", 
            uiName: "2022Âπ¥ ÈáëÈñÄÁ∏£Èï∑ÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "2020_Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±ÈÅ∏Ëàâ.csv", 
            year: "2020", 
            type: "Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±", 
            uiName: "2020Âπ¥ Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±ÈÅ∏Ëàâ",
            summaryData: null 
        },
        { 
            file: "2020_‰∏çÂàÜÂçÄÁ´ãÂßîÈÅ∏Ëàâ.csv", 
            year: "2020", 
            type: "Á´ãÊ≥ïÂßîÂì°", 
            uiName: "2020Âπ¥ ‰∏çÂàÜÂçÄÁ´ãÂßîÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "2020_ÈáëÈñÄÁ∏£Á´ãÂßîÈÅ∏Ëàâ.csv", 
            year: "2020", 
            type: "Á´ãÊ≥ïÂßîÂì°", 
            uiName: "2020Âπ¥ ÈáëÈñÄÁ∏£Á´ãÂßîÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "2019_ÈáëÈñÄÁ∏£Á´ãÂßîË£úÈÅ∏.csv", 
            year: "2019", 
            type: "Á´ãÊ≥ïÂßîÂì°", 
            uiName: "2019Âπ¥ ÈáëÈñÄÁ∏£Á´ãÂßîË£úÈÅ∏",
            summaryData: null
        },
        { 
            file: "2018_ÈáëÈñÄÁ∏£Èï∑ÈÅ∏Ëàâ.csv", 
            year: "2018", 
            type: "Á∏£Èï∑", 
            uiName: "2018Âπ¥ ÈáëÈñÄÁ∏£Èï∑ÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "2018_Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨3ÈÅ∏ÂçÄ.csv", 
            year: "2018", 
            type: "Á∏£Ë≠∞Âì°", 
            uiName: "2018Âπ¥ Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨3ÈÅ∏ÂçÄ",
            summaryData: null
        },
        { 
            file: "2018_Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨2ÈÅ∏ÂçÄ.csv", 
            year: "2018", 
            type: "Á∏£Ë≠∞Âì°", 
            uiName: "2018Âπ¥ Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨2ÈÅ∏ÂçÄ",
            summaryData: null
        },
        { 
            file: "2018_Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨1ÈÅ∏ÂçÄ.csv", 
            year: "2018", 
            type: "Á∏£Ë≠∞Âì°", 
            uiName: "2018Âπ¥ Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨1ÈÅ∏ÂçÄ",
            summaryData: null
        },
        { 
            file: "2016_Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±ÈÅ∏Ëàâ.csv", 
            year: "2016", 
            type: "Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±", 
            uiName: "2016Âπ¥ Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±ÈÅ∏Ëàâ",
            summaryData: null 
        },
        { 
            file: "2016_‰∏çÂàÜÂçÄÁ´ãÂßîÈÅ∏Ëàâ.csv", 
            year: "2016", 
            type: "Á´ãÊ≥ïÂßîÂì°", 
            uiName: "2016Âπ¥ ‰∏çÂàÜÂçÄÁ´ãÂßîÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "2016_ÈáëÈñÄÁ∏£Á´ãÂßîÈÅ∏Ëàâ.csv", 
            year: "2016", 
            type: "Á´ãÊ≥ïÂßîÂì°", 
            uiName: "2016Âπ¥ ÈáëÈñÄÁ∏£Á´ãÂßîÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "2014_ÈáëÈñÄÁ∏£Èï∑ÈÅ∏Ëàâ.csv", 
            year: "2014", 
            type: "Á∏£Èï∑", 
            uiName: "2014Âπ¥ ÈáëÈñÄÁ∏£Èï∑ÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "2014_Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨3ÈÅ∏ÂçÄ.csv", 
            year: "2014", 
            type: "Á∏£Ë≠∞Âì°", 
            uiName: "2014Âπ¥ Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨3ÈÅ∏ÂçÄ",
            summaryData: null
        },
        { 
            file: "2014_Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨2ÈÅ∏ÂçÄ.csv", 
            year: "2014", 
            type: "Á∏£Ë≠∞Âì°", 
            uiName: "2014Âπ¥ Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨2ÈÅ∏ÂçÄ",
            summaryData: null
        },
        { 
            file: "2014_Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨1ÈÅ∏ÂçÄ.csv", 
            year: "2014", 
            type: "Á∏£Ë≠∞Âì°", 
            uiName: "2014Âπ¥ Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨1ÈÅ∏ÂçÄ",
            summaryData: null
        },
        { 
            file: "2012_Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±ÈÅ∏Ëàâ.csv", 
            year: "2012", 
            type: "Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±", 
            uiName: "2012Âπ¥ Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±ÈÅ∏Ëàâ",
            summaryData: null 
        },
        { 
            file: "2012_‰∏çÂàÜÂçÄÁ´ãÂßîÈÅ∏Ëàâ.csv", 
            year: "2012", 
            type: "Á´ãÊ≥ïÂßîÂì°", 
            uiName: "2012Âπ¥ ‰∏çÂàÜÂçÄÁ´ãÂßîÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "2012_ÈáëÈñÄÁ∏£Á´ãÂßîÈÅ∏Ëàâ.csv", 
            year: "2012", 
            type: "Á´ãÊ≥ïÂßîÂì°", 
            uiName: "2012Âπ¥ ÈáëÈñÄÁ∏£Á´ãÂßîÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "2009_ÈáëÈñÄÁ∏£Èï∑ÈÅ∏Ëàâ.csv", 
            year: "2009", 
            type: "Á∏£Èï∑", 
            uiName: "2009Âπ¥ ÈáëÈñÄÁ∏£Èï∑ÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "2009_Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨2ÈÅ∏ÂçÄ.csv", 
            year: "2009", 
            type: "Á∏£Ë≠∞Âì°", 
            uiName: "2009Âπ¥ Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨2ÈÅ∏ÂçÄ",
            summaryData: null
        },
        { 
            file: "2009_Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨1ÈÅ∏ÂçÄ.csv", 
            year: "2009", 
            type: "Á∏£Ë≠∞Âì°", 
            uiName: "2009Âπ¥ Á∏£Ë≠∞Âì°ÈÅ∏ËàâÁ¨¨1ÈÅ∏ÂçÄ",
            summaryData: null
        },
        { 
            file: "2008_Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±ÈÅ∏Ëàâ.csv", 
            year: "2008", 
            type: "Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±", 
            uiName: "2008Âπ¥ Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±ÈÅ∏Ëàâ",
            summaryData: null 
        },
        { 
            file: "2008_‰∏çÂàÜÂçÄÁ´ãÂßîÈÅ∏Ëàâ.csv", 
            year: "2008", 
            type: "Á´ãÊ≥ïÂßîÂì°", 
            uiName: "2008Âπ¥ ‰∏çÂàÜÂçÄÁ´ãÂßîÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "2008_ÈáëÈñÄÁ∏£Á´ãÂßîÈÅ∏Ëàâ.csv", 
            year: "2008", 
            type: "Á´ãÊ≥ïÂßîÂì°", 
            uiName: "2008Âπ¥ ÈáëÈñÄÁ∏£Á´ãÂßîÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "2006_Âú∞ÊñπÊÄßÂÖ¨ÊäïÁ¨¨01Ê°à.csv", 
            year: "2006", 
            type: "Âú∞ÊñπÊÄßÂÖ¨Ê∞ëÊäïÁ•®", 
            uiName: "2006Âπ¥ Âú∞ÊñπÊÄßÂÖ¨ÊäïÁ¨¨1Ê°àÔºàÂçöÂºàÂÖ¨ÊäïÔºâ",
            summaryData: null
        },
        { 
            file: "2005_‰ªªÂãôÂûãÂúã‰ª£ÈÅ∏Ëàâ.csv", 
            year: "2005", 
            type: "ÂúãÂ§ß‰ª£Ë°®", 
            uiName: "2005Âπ¥ ‰ªªÂãôÂûãÂúã‰ª£ÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "2005_ÈáëÈñÄÁ∏£Èï∑ÈÅ∏Ëàâ.csv", 
            year: "2005", 
            type: "Á∏£Èï∑", 
            uiName: "2005Âπ¥ ÈáëÈñÄÁ∏£Èï∑ÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "2005_Á∏£Ë≠∞Âì°ÈÅ∏Ëàâ.csv", 
            year: "2005", 
            type: "Á∏£Ë≠∞Âì°", 
            uiName: "2005Âπ¥ Á∏£Ë≠∞Âì°ÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "2004_Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±ÈÅ∏Ëàâ.csv", 
            year: "2004", 
            type: "Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±", 
            uiName: "2004Âπ¥ Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±ÈÅ∏Ëàâ",
            summaryData: null 
        },
        { 
            file: "2004_ÈáëÈñÄÁ∏£Á´ãÂßîÈÅ∏Ëàâ.csv", 
            year: "2004", 
            type: "Á´ãÊ≥ïÂßîÂì°", 
            uiName: "2004Âπ¥ ÈáëÈñÄÁ∏£Á´ãÂßîÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "2002_Á∏£Ë≠∞Âì°ÈÅ∏Ëàâ.csv", 
            year: "2002", 
            type: "Á∏£Ë≠∞Âì°", 
            uiName: "2002Âπ¥ Á∏£Ë≠∞Âì°ÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "2001_ÈáëÈñÄÁ∏£Á´ãÂßîÈÅ∏Ëàâ.csv", 
            year: "2001", 
            type: "Á´ãÊ≥ïÂßîÂì°", 
            uiName: "2001Âπ¥ ÈáëÈñÄÁ∏£Á´ãÂßîÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "2001_ÈáëÈñÄÁ∏£Èï∑ÈÅ∏Ëàâ.csv", 
            year: "2001", 
            type: "Á∏£Èï∑", 
            uiName: "2001Âπ¥ ÈáëÈñÄÁ∏£Èï∑ÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "2000_Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±ÈÅ∏Ëàâ.csv", 
            year: "2000", 
            type: "Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±", 
            uiName: "2000Âπ¥ Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±ÈÅ∏Ëàâ",
            summaryData: null 
        },
        { 
            file: "1998_ÈáëÈñÄÁ∏£Á´ãÂßîÈÅ∏Ëàâ.csv", 
            year: "1998", 
            type: "Á´ãÊ≥ïÂßîÂì°", 
            uiName: "1998Âπ¥ ÈáëÈñÄÁ∏£Á´ãÂßîÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "1998_Á∏£Ë≠∞Âì°ÈÅ∏Ëàâ.csv", 
            year: "1998", 
            type: "Á∏£Ë≠∞Âì°", 
            uiName: "1998Âπ¥ Á∏£Ë≠∞Âì°ÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "1997_ÈáëÈñÄÁ∏£Èï∑ÈÅ∏Ëàâ.csv", 
            year: "1997", 
            type: "Á∏£Èï∑", 
            uiName: "1997Âπ¥ ÈáëÈñÄÁ∏£Èï∑ÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "1996_Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±ÈÅ∏Ëàâ.csv", 
            year: "1996", 
            type: "Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±", 
            uiName: "1996Âπ¥ Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±ÈÅ∏Ëàâ",
            summaryData: null 
        },
        { 
            file: "1996_ÈáëÈñÄÁ∏£Âúã‰ª£ÈÅ∏Ëàâ.csv", 
            year: "1996", 
            type: "ÂúãÂ§ß‰ª£Ë°®", 
            uiName: "1996Âπ¥ ÈáëÈñÄÁ∏£Âúã‰ª£ÈÅ∏Ëàâ",
            summaryData: null 
        },
        { 
            file: "1995_ÈáëÈñÄÁ∏£Á´ãÂßîÈÅ∏Ëàâ.csv", 
            year: "1995", 
            type: "Á´ãÊ≥ïÂßîÂì°", 
            uiName: "1995Âπ¥ ÈáëÈñÄÁ∏£Á´ãÂßîÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "1993_ÈáëÈñÄÁ∏£Èï∑ÈÅ∏Ëàâ.csv", 
            year: "1993", 
            type: "Á∏£Èï∑", 
            uiName: "1993Âπ¥ ÈáëÈñÄÁ∏£Èï∑ÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "1992_ÈáëÈñÄÁ∏£Á´ãÂßîÈÅ∏Ëàâ.csv", 
            year: "1992", 
            type: "Á´ãÊ≥ïÂßîÂì°", 
            uiName: "1992Âπ¥ ÈáëÈñÄÁ∏£Á´ãÂßîÈÅ∏Ëàâ",
            summaryData: null
        },
        { 
            file: "1991_ÈáëÈñÄÁ∏£Âúã‰ª£ÈÅ∏Ëàâ.csv", 
            year: "1991", 
            type: "ÂúãÂ§ß‰ª£Ë°®", 
            uiName: "1991Âπ¥ ÈáëÈñÄÁ∏£Âúã‰ª£ÈÅ∏Ëàâ",
            summaryData: null 
        },
        { 
            file: "1989_ÈáëÈñÄÁ∏£Â¢ûÈ°çÁ´ãÂßîÈÅ∏Ëàâ.csv", 
            year: "1989", 
            type: "Á´ãÊ≥ïÂßîÂì°", 
            uiName: "1989Âπ¥ ÈáëÈñÄÁ∏£Â¢ûÈ°çÁ´ãÂßîÈÅ∏Ëàâ",
            summaryData: null
        }
    ];
    
    function isElectionWithoutTowns(electionName) {
        const noTownsElections = [
            "1992Âπ¥ ÈáëÈñÄÁ∏£Á´ãÂßîÈÅ∏Ëàâ", 
            "1991Âπ¥ ÈáëÈñÄÁ∏£Âúã‰ª£ÈÅ∏Ëàâ", 
            "1989Âπ¥ ÈáëÈñÄÁ∏£Â¢ûÈ°çÁ´ãÂßîÈÅ∏Ëàâ"
        ];
        return noTownsElections.includes(electionName);
    }

    function isElectionWithoutVillages(electionName) {
        const noVillageElections = [
            "1993Âπ¥ ÈáëÈñÄÁ∏£Èï∑ÈÅ∏Ëàâ" 
        ];
        return noVillageElections.includes(electionName);
    }

    // *** Êñ∞Â¢ûÔºöÂà§Êñ∑ÊòØÂê¶ÁÇ∫„ÄåÊîøÈª®Á•®„ÄçÈÅ∏Ëàâ (‰∏çÂàÜÂçÄ„ÄÅ‰ªªÂãôÂûãÂúã‰ª£Á≠â) ***
    function isPartyListElection(electionName) {
        const partyListElections = [
            "2024Âπ¥ ‰∏çÂàÜÂçÄÁ´ãÂßîÈÅ∏Ëàâ",
            "2020Âπ¥ ‰∏çÂàÜÂçÄÁ´ãÂßîÈÅ∏Ëàâ",
            "2016Âπ¥ ‰∏çÂàÜÂçÄÁ´ãÂßîÈÅ∏Ëàâ",
            "2012Âπ¥ ‰∏çÂàÜÂçÄÁ´ãÂßîÈÅ∏Ëàâ",
            "2008Âπ¥ ‰∏çÂàÜÂçÄÁ´ãÂßîÈÅ∏Ëàâ",
            "2005Âπ¥ ‰ªªÂãôÂûãÂúã‰ª£ÈÅ∏Ëàâ",
        ];
            // Á∞°ÊòìÂà§Êñ∑ÔºöËã•ÂêçÁ®±ÂåÖÂê´„Äå‰∏çÂàÜÂçÄ„Äç„ÄÅ„Äå‰ªªÂãôÂûã„ÄçÊàñ„ÄåÊîøÈª®Á•®„ÄçÔºå‰πüË¶ñÁÇ∫ÊîøÈª®Á•®
            if (electionName && (electionName.includes("‰∏çÂàÜÂçÄ") || electionName.includes("‰ªªÂãôÂûã") || electionName.includes("ÂÖ¨Êäï") || electionName.includes("ÊîøÈª®Á•®"))) {
            return true;
            }
        return partyListElections.includes(electionName);
    }
    
    const electionCategories = [
        { type: "Á∏ΩÁµ±ÂâØÁ∏ΩÁµ±", icon: "üèõÔ∏è" },
        { type: "Á´ãÊ≥ïÂßîÂì°", icon: "‚öñÔ∏è" },
        { type: "ÂúãÂ§ß‰ª£Ë°®", icon: "üìú" },
        { type: "Á∏£Èï∑", icon: "üë®‚Äçüíº" },
        { type: "Á∏£Ë≠∞Âì°", icon: "üó£Ô∏è" },
        { type: "ÈÑâÈéÆÈï∑", icon: "üè¢" },
        { type: "ÈÑâÈéÆÊ∞ë‰ª£Ë°®", icon: "üë•" },
        { type: "ÊùëÈáåÈï∑", icon: "üè°" },
        { type: "ÂÖ¨Ê∞ëÊäïÁ•®", icon: "üó≥Ô∏è" }
    ];

    const partyColors = {
        "‰∏≠ÂúãÂúãÊ∞ëÈª®": "#3887B0",
        "Ê∞ë‰∏ªÈÄ≤Ê≠•Èª®": "#008800", 
        "Âè∞ÁÅ£Ê∞ëÁúæÈª®": "#28C8C8",
        "Ë¶™Ê∞ëÈª®": "#F27C00",
        "Êñ∞Èª®": "#ECBE00",
        "ÈáëÈñÄÈ´òÁ≤±Èª®": "#990033",
        "Âè∞ÁÅ£Âü∫ÈÄ≤": "#A23D23",
        "ÁÑ°Èª®ÂúòÁµêËÅØÁõü": "#C30750",
	"Âè∞ÁÅ£ÂúòÁµêËÅØÁõü": "#A66000",
        "ÈÄ£ÁΩ≤ÂèÉÈÅ∏": "#8D7A96",
        "ÁÑ°Èª®Á±ç": "#7F8C8D",
        "ÂêåÊÑè": "#5F4BB6",
        "‰∏çÂêåÊÑè": "#ECBE00",
        "default": "#537073"
    };

    let appState = {
        data: {},
        countyMetadata: {}, 
        currentLevel: 'mainMenu', 
        currentTown: null,
        sortConfig: { key: 'number', direction: 'asc' }, 
        globalTotalVotes: 0,
        electionName: "ÈÅ∏ËàâË≥áÊñô",
        chartInstances: [] 
    };

    // *** Êñ∞Â¢ûÔºöÂÖ®ÂüüÂÄôÈÅ∏‰∫∫Ë©≥Á¥∞Ë≥áÊñôÊö´Â≠ò ***
    let globalCandidateData = {}; 
    
    function hexToRgb(hex) {
        const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
        hex = hex.replace(shorthandRegex, function(m, r, g, b) {
            return r + r + g + g + b + b;
        });
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : { r: 0, b: 0, g: 0 };
    }

    function getPartyColor(party) {
        const isIndependent = party.startsWith('ÁÑ°Èª®Á±ç');
        if (isIndependent) {
            return partyColors[party] || partyColors['ÁÑ°Èª®Á±ç']; 
        }
        return partyColors[party] || partyColors['default'];
    }

    function getShortPartyName(party) {
        const shortNamesMap = {
            "‰∏≠ÂúãÂúãÊ∞ëÈª®": "ÂúãÊ∞ëÈª®",
            "Ê∞ë‰∏ªÈÄ≤Ê≠•Èª®": "Ê∞ëÈÄ≤Èª®",
            "Âè∞ÁÅ£Ê∞ëÁúæÈª®": "Ê∞ëÁúæÈª®",
            "Ë¶™Ê∞ëÈª®": "Ë¶™Ê∞ëÈª®", 
            "Êñ∞Èª®": "Êñ∞Èª®",
            "Âè∞ÁÅ£ÂúòËÅØËÅØÁõü": "Âè∞ËÅØÈª®",
            "ÈáëÈñÄÈ´òÁ≤±Èª®": "È´òÁ≤±Èª®", 
            "ÈæçÈª®": "ÈæçÈª®", 
            "ÊïôÁßëÊñáÈ†êÁÆó‰øùÈöúeËÅØÁõü": "ÊïôÁßëÊñá",
            "Âè∞ÁÅ£Âü∫ÈÄ≤": "Âè∞ÁÅ£Âü∫ÈÄ≤",
            "‰∏≠ËèØÊñ∞‰ΩèÊ∞ëÈª®": "Êñ∞‰ΩèÊ∞ëÈª®",
            "‰∏≠ÂúãÁîüÁî¢Èª®": "ÁîüÁî¢Èª®",
            "‰∏≠ËèØÁµ±‰∏Ä‰øÉÈÄ≤Èª®": "Áµ±‰øÉÈª®",
            "ËªçÂÖ¨ÊïôËÅØÁõüÈª®": "ËªçÂÖ¨Êïô",
            "Âè∞ÁÅ£Â∑•Èª®": "Âè∞ÁÅ£Â∑•Èª®",
            "ÂÅ•‰øùÂÖçË≤ªÈÄ£Á∑ö": "ÂÅ•‰øùÂÖçË≤ª",
            "ÁÑ°Èª®ÂúòÁµêËÅØÁõü": "ÁÑ°Èª®ËÅØÁõü",
            "ÂÖ¨Ê∞ëÈª®": "ÂÖ¨Ê∞ëÈª®",
            "‰∏≠ËèØÊ∞ëÊóèËá¥ÂÖ¨Èª®": "Ëá¥ÂÖ¨Èª®",
            "ÈÄ£ÁΩ≤ÂèÉÈÅ∏": "ÈÄ£ÁΩ≤ÂèÉÈÅ∏",
            "ÁÑ°Èª®Á±ç-1": "ÁÑ°Èª®Á±ç", 
            "ÁÑ°Èª®Á±ç-2": "ÁÑ°Èª®Á±ç",
            "ÁÑ°Èª®Á±ç-3": "ÁÑ°Èª®Á±ç",
            "ÁÑ°Èª®Á±ç-4": "ÁÑ°Èª®Á±ç",
            "ÁÑ°Èª®Á±ç": "ÁÑ°Èª®Á±ç",
            "default": "ÁÑ°"
        };
        const key = party.split('-')[0];
        return shortNamesMap[party] || shortNamesMap[key] || party; 
    }
    
    function getLongPartyName(party) {
        const longNamesMap = {
            "‰∏≠ÂúãÂúãÊ∞ëÈª®": "‰∏≠ÂúãÂúãÊ∞ëÈª®",
            "Ê∞ë‰∏ªÈÄ≤Ê≠•Èª®": "Ê∞ë‰∏ªÈÄ≤Ê≠•Èª®",
            "Âè∞ÁÅ£Ê∞ëÁúæÈª®": "Âè∞ÁÅ£Ê∞ëÁúæÈª®",
            "Ë¶™Ê∞ëÈª®": "Ë¶™Ê∞ëÈª®", 
            "Êñ∞Èª®": "Êñ∞Èª®",
            "Âè∞ÁÅ£ÂúòÁµêËÅØÁõü": "Âè∞ÁÅ£ÂúòÁµêËÅØÁõü",
            "ÈáëÈñÄÈ´òÁ≤±Èª®": "ÈáëÈñÄÈ´òÁ≤±Èª®", 
            "ÈæçÈª®": "ÈæçÈª®", 
            "ÊïôÁßëÊñáÈ†êÁÆó‰øùÈöúeËÅØÁõü": "ÊïôÁßëÊñáÈ†êÁÆó‰øùÈöúeËÅØÁõü",
            "Âè∞ÁÅ£Âü∫ÈÄ≤": "Âè∞ÁÅ£Âü∫ÈÄ≤",
            "‰∏≠ËèØÊñ∞‰ΩèÊ∞ëÈª®": "‰∏≠ËèØÊñ∞‰ΩèÊ∞ëÈª®",
            "‰∏≠ÂúãÁîüÁî¢Èª®": "‰∏≠ÂúãÁîüÁî¢Èª®",
            "‰∏≠ËèØÁµ±‰∏Ä‰øÉÈÄ≤Èª®": "‰∏≠ËèØÁµ±‰∏Ä‰øÉÈÄ≤Èª®",
            "ËªçÂÖ¨ÊïôËÅØÁõüÈª®": "ËªçÂÖ¨ÊïôËÅØÁõüÈª®",
            "Âè∞ÁÅ£Â∑•Èª®": "Âè∞ÁÅ£Â∑•Èª®",
            "ÂÅ•‰øùÂÖçË≤ªÈÄ£Á∑ö": "ÂÅ•‰øùÂÖçË≤ªÈÄ£Á∑ö",
            "ÁÑ°Èª®ÂúòÁµêËÅØÁõü": "ÁÑ°Èª®ÂúòÁµêËÅØÁõü",
            "ÂÖ¨Ê∞ëÈª®": "ÂÖ¨Ê∞ëÈª®",
            "‰∏≠ËèØÊ∞ëÊóèËá¥ÂÖ¨Èª®": "‰∏≠ËèØÊ∞ëÊóèËá¥ÂÖ¨Èª®",
            "ÁÑ°Èª®Á±ç-1": "ÁÑ°Èª®Á±ç", 
            "ÁÑ°Èª®Á±ç-2": "ÁÑ°Èª®Á±ç",
            "ÁÑ°Èª®Á±ç-3": "ÁÑ°Èª®Á±ç",
            "ÁÑ°Èª®Á±ç-4": "ÁÑ°Èª®Á±ç",
            "ÁÑ°Èª®Á±ç": "ÁÑ°Èª®Á±ç",
            "default": "ÁÑ°"
        };
        const key = party.split('-')[0];
        return longNamesMap[party] || longNamesMap[key] || party; 
    }


    const dom = {
        content: document.getElementById("content"),
        breadcrumb: document.getElementById("breadcrumb"),
        breadcrumbBottom: document.getElementById("breadcrumb-bottom"),
        header: document.querySelector('header')
    };
    
    // ================= Ê≠∑Âè≤Ë®òÈåÑ API ËºîÂä©ÂáΩÂºè =================
    
    function getCurrentUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
            view: params.get('view') || 'main',
            type: params.get('type'),
            election: params.get('election'),
            town: params.get('town')
        };
    }
    
	function updateUrl(state, title, url, push = true) {
        if (push) {
            // [Êñ∞Â¢û] Âú®Êé®ÂÖ•Êñ∞Ê≠∑Âè≤Á¥ÄÈåÑÂâçÔºåÂÖàÊää"Áï∂Ââç"È†ÅÈù¢ÁöÑÊç≤Âãï‰ΩçÁΩÆÂ≠òÂÖ•Áï∂ÂâçÁöÑ state
            const currentState = history.state || {};
            currentState.scrollY = window.scrollY;
            history.replaceState(currentState, document.title, window.location.href);

            // Êé®ÂÖ•Êñ∞ÁöÑÊ≠∑Âè≤Á¥ÄÈåÑ
            history.pushState(state, title, url);
        } else {
            history.replaceState(state, title, url); 
        }
    }

    // ================= ÂÄôÈÅ∏‰∫∫Ë©≥Á¥∞Ë≥áÊñôËºâÂÖ•ËàáËôïÁêÜ (Êñ∞Â¢û) =================
    
	async function loadCandidateData() {
        try {
            const response = await fetch('candidates.csv');
            if (!response.ok) throw new Error('ÁÑ°Ê≥ïËÆÄÂèñ candidates.csv');
            const text = await response.text();
            
            // Ëß£Êûê CSV: ÂßìÂêç,ÊÄßÂà•,Âá∫ÁîüÂπ¥,Âá∫ÁîüÂú∞,ÁÖßÁâáÊ™îÂêç
            const rows = text.split('\n').map(r => r.trim()).filter(r => r);
            // Ë∑≥ÈÅéÊ®ôÈ°åÂàó (index 0)
            for(let i=1; i<rows.length; i++) {
                const cols = rows[i].split(',');
                if(cols.length >= 1) {
                    const name = cols[0].trim();
                    const sex = cols[1] ? cols[1].trim() : '';
                    const birthYear = cols[2] ? cols[2].trim() : '';
                    // [‰øÆÊîπ] Êñ∞Â¢ûËÆÄÂèñÂá∫ÁîüÂú∞ (Á¨¨4Ê¨ÑÔºåindex 3)
                    const birthPlace = cols[3] ? cols[3].trim() : ''; 
                    // [‰øÆÊîπ] ÁÖßÁâáÊ™îÂêçÂæÄÂæåÁßª‰∏ÄÊ¨Ñ (Á¨¨5Ê¨ÑÔºåindex 4)
                    const photo = cols[4] ? cols[4].trim() : '';
                    
                    // [‰øÆÊîπ] Â∞á birthPlace Â≠òÂÖ•ÂÖ®ÂüüËÆäÊï∏
                    globalCandidateData[name] = { sex, birthYear, birthPlace, photo };
                }
            }
        } catch (e) {
            console.warn("ËºâÂÖ•ÂÄôÈÅ∏‰∫∫Ë≥áÊñôÂ§±ÊïóÊàñÊ™îÊ°à‰∏çÂ≠òÂú®", e);
        }
    }
    
    // ÈñãÂïüÂÄôÈÅ∏‰∫∫ Modal
    window.showCandidateModal = function(name, currentElectionYear) {
        // Â¶ÇÊûúÊòØÊîøÈª®Á•®ÈÅ∏ËàâÔºåÂâá‰∏çÈ°ØÁ§∫ Modal
        if (isPartyListElection(appState.electionName)) return;

        const modal = document.getElementById('candidate-modal');
        const modalBody = document.getElementById('modal-body');
        
        // 1. ÂèñÂæóÂü∫Êú¨Ë≥áÊñô
        const info = globalCandidateData[name] || { sex: 'Êú™Áü•', birthYear: '', birthPlace: '', photo: '' };
        
        // 2. Ê∫ñÂÇôÈ°ØÁ§∫ÊñáÂ≠óÔºöÁ¨¨‰∏ÄË°å (ÊÄßÂà•ÔºéÂèÉÈÅ∏Âπ¥Á¥Ä XX Ê≠≤)
        let line1Parts = [];
        
        // Âä†ÂÖ•ÊÄßÂà•
        if (info.sex) line1Parts.push(info.sex);
        
        // Ë®àÁÆó‰∏¶Âä†ÂÖ•Âπ¥Á¥Ä (ÂèÉÈÅ∏Âπ¥Á¥Ä XX Ê≠≤)
        let ageHtml = '';
        if (info.birthYear && currentElectionYear) {
            const age = parseInt(currentElectionYear) - parseInt(info.birthYear);
            ageHtml = `ÂèÉÈÅ∏Âπ¥Á¥Ä ${age} Ê≠≤`;
            line1Parts.push(ageHtml);
        }
        
        const line1Html = line1Parts.join('Ôºé'); // Áî®ÂÖ®ÂΩ¢ÈªûÈÄ£Êé•

        // 3. Ê∫ñÂÇôÈ°ØÁ§∫ÊñáÂ≠óÔºöÁ¨¨‰∫åË°å (Âπ¥‰ªΩÔºèÂá∫ÁîüÂú∞ Âá∫Áîü)
        let line2Html = "";
        if (info.birthYear || info.birthPlace) {
            const yearPart = info.birthYear ? `${info.birthYear}Âπ¥` : '';
            const placePart = info.birthPlace || '';
            
            // ‰ΩøÁî®„ÄåÔºè„Äç‰æÜÂàÜÈöîÂπ¥‰ªΩËàáÂá∫ÁîüÂú∞ÔºåÊúÄÂæåÂä†‰∏ä„ÄåÂá∫Áîü„Äç
            let combinedPart = [yearPart, placePart].filter(p => p).join('Ôºè');
            
            if (combinedPart) {
                 line2Html = `${combinedPart} Âá∫Áîü`;
            }
        }

        const photoSrc = info.photo ? `Candidates/${info.photo}` : '';
        
        // 4. ÊêúÂ∞ãÂèÉÈÅ∏Á∂ìÊ≠∑
        const historyList = [];
        availableElections.forEach(e => {
            if (e.summaryData && e.summaryData.allCandidates) {
                const match = e.summaryData.allCandidates.find(c => c.name === name);
                if (match) {
                    historyList.push({
                        year: e.year,
                        electionName: e.uiName,
                        party: match.party,
                        isWinner: match.isWinner,
                        isIncumbent: match.isIncumbent
                    });
                }
            }
        });
        historyList.sort((a, b) => parseInt(b.year) - parseInt(a.year));
        
        let historyHtml = ''; 
        if (historyList.length > 0) {
            historyHtml += `<div class="history-title">ÂèÉÈÅ∏Á∂ìÊ≠∑</div><ul class="history-list">`;
            historyList.forEach(h => {
                const electionNameWithoutYear = h.electionName.replace(/^\d+Âπ¥\s*/, ''); 
                const resultClass = h.isWinner ? 'result-won' : 'result-lost';
                const resultText = h.isWinner ? 'Áï∂ÈÅ∏' : 'Êú™Áï∂ÈÅ∏';
                const partyName = getLongPartyName(h.party);
                historyHtml += `
                    <li class="history-item">
                        <div>
                            <span class="history-year-tag">${h.year}</span>
                            <span class="history-name">${electionNameWithoutYear}</span> <span class="history-party">${partyName}</span>
                        </div>
                        <div class="history-result ${resultClass}">
                            ${resultText}
                        </div>
                    </li>
                `;
            });
            historyHtml += `</ul>`;
        } else {
            historyHtml = `<div style="color:#999; margin-top:20px;">ÁÑ°ÂÖ∂‰ªñÂèÉÈÅ∏Á¥ÄÈåÑ</div>`;
        }
        
	// 5. ÁµÑÂêà HTML 
        const imgDisplay = photoSrc ? `<img src="${photoSrc}" class="profile-photo" alt="${name}">` : `<div class="profile-photo" style="display:flex;align-items:center;justify-content:center;font-size:40px;color:#ccc;">üë§</div>`;
        
        modalBody.innerHTML = `
            <div class="profile-header">
                ${imgDisplay}
                <div class="profile-info">
                    <h2>${name}</h2>
                    <div class="profile-detail">
                        <div style="margin-bottom: 2px;">
                            ${line1Html}
                        </div>
                        <div style="color: var(--text-sub);">
                            ${line2Html}
                        </div>
                    </div>
                </div>
            </div>
            ${historyHtml}
        `;
        
        modal.classList.add('active');
        document.body.style.overflow = 'hidden'; 
    };
    
    window.closeModal = function() {
        document.getElementById('candidate-modal').classList.remove('active');
        document.body.style.overflow = '';
    };

    // ================= Ë≥áÊñôËºâÂÖ•ËàáËß£Êûê =================
    
    function parseCSV(text) {
        const rows = text.split('\n').map(r => r.trim()).filter(r => r).map(r => r.split(','));

        if (rows.length < 4) return;
        
        // ËÆÄÂèñ A1 (ÈÅ∏ËàâÂêçÁ®±) Âíå B1 (ÊäïÁ•®Êó•Êúü)
        const electionNameFromCSV = rows[0][0] ? rows[0][0].trim() : '';
        const electionDateFromCSV = rows[0][1] ? rows[0][1].trim() : '';

        const headerRowIndices = []; 
        let currentIdx = 2;
        while(rows[0][currentIdx] && rows[1][currentIdx]) {
            headerRowIndices.push(currentIdx);
            currentIdx++;
        }
        
        const seatsCount = rows[1] && rows[1][0] ? rows[1][0].trim() : "";
        
        const VOTES_COL = currentIdx; 
        const INVALID_COL = currentIdx + 1;
        const ELIGIBLE_COL = currentIdx + 2;

        const candInfo = [];
        let independentCounter = 1;
        
        headerRowIndices.forEach(colIndex => {
            const number = rows[0][colIndex] ? rows[0][colIndex].trim() : '';
            let name = rows[1][colIndex] ? rows[1][colIndex].trim() : '';
            let party = rows[2][colIndex] ? rows[2][colIndex].trim() : '';
            
            const isWomenQuota = name.includes('*!');
            const isIncumbent = name.includes('#');

            const isWinner = name.includes('*') || isWomenQuota; 
            
            name = name.replace('*!', '').replace('*', '').replace('#', '').trim(); 
            
            party = party === 'ÁÑ°' ? 'ÁÑ°Èª®Á±ç' : party;

            if (name && number) {
                if (party === 'ÁÑ°Èª®Á±ç') {
                    if (!partyColors[`ÁÑ°Èª®Á±ç-${independentCounter}`] && independentCounter <= 4) {
                       partyColors[`ÁÑ°Èª®Á±ç-${independentCounter}`] = partyColors['ÁÑ°Èª®Á±ç']; 
                    }
                    party = `ÁÑ°Èª®Á±ç-${independentCounter}`;
                    independentCounter++;
                }

                candInfo.push({ number: String(number), name, party, colIndex, isWinner, isWomenQuota, isIncumbent }); 
            }
        });

        const candidates = {}; 
        const towns = {};
        const townOrder = [];
        let globalValidVotes = 0; 
        let globalInvalidVotes = 0; 
        let globalEligibleVoters = 0; 
        
        for (let i = 3; i < rows.length; i++) {
            const row = rows[i];
            
            if (row.length < (ELIGIBLE_COL + 1) || !row[0] || row[0].includes("ÈÑâÈéÆ")) continue; 

            const town = row[0].trim();
            const village = row[1].trim();
            
            const parseNum = (val) => parseInt(String(val).replace(/[^0-9]/g, '')) || 0;

            const validVotes = parseNum(row[VOTES_COL]); 
            const invalidVotes = parseNum(row[INVALID_COL]); 
            const eligibleVoters = parseNum(row[ELIGIBLE_COL]); 
            
            globalValidVotes += validVotes;
            globalInvalidVotes += invalidVotes;
            globalEligibleVoters += eligibleVoters;

            if (!towns[town]) {
                towns[town] = { 
                    villages: {}, 
                    validVotes: 0, 
                    invalidVotes: 0,
                    eligibleVoters: 0,
                    candidates: {} 
                };
                townOrder.push(town);
            }
            
            towns[town].validVotes += validVotes;
            towns[town].invalidVotes += invalidVotes;
            towns[town].eligibleVoters += eligibleVoters;
            
            if (!towns[town].villages[village]) {
                 towns[town].villages[village] = { 
                     validVotes: 0, 
                     invalidVotes: 0,
                     eligibleVoters: 0,
                     candidates: {} 
                 };
            }
            towns[town].villages[village].validVotes += validVotes;
            towns[town].villages[village].invalidVotes += invalidVotes;
            towns[town].villages[village].eligibleVoters += eligibleVoters;
            
            
            candInfo.forEach(c => {
                const votes = parseNum(row[c.colIndex]);
                
                if (!candidates[c.name]) candidates[c.name] = { number: c.number, party: c.party, votes: 0, isWinner: c.isWinner, isWomenQuota: c.isWomenQuota, isIncumbent: c.isIncumbent };
                candidates[c.name].votes += votes;
                
                if (!towns[town].candidates[c.name]) towns[town].candidates[c.name] = { number: c.number, party: c.party, votes: 0, isWinner: c.isWinner, isWomenQuota: c.isWomenQuota, isIncumbent: c.isIncumbent };
                towns[town].candidates[c.name].votes += votes;
                
                if (!towns[town].villages[village].candidates[c.name]) towns[town].villages[village].candidates[c.name] = { number: c.number, party: c.party, votes: 0, isWinner: c.isWinner, isWomenQuota: c.isWomenQuota, isIncumbent: c.isIncumbent };
                towns[town].villages[village].candidates[c.name].votes += votes;
            });
        }

        appState.data = { county: candidates, towns: towns, townOrder: [...new Set(townOrder)] };
        appState.countyMetadata = {
            validVotes: globalValidVotes,
            invalidVotes: globalInvalidVotes,
            eligibleVoters: globalEligibleVoters,
            seatsCount: seatsCount,
            electionNameFromCSV: electionNameFromCSV, // Â≠òÂÖ• metadata
            electionDateFromCSV: electionDateFromCSV  // Â≠òÂÖ• metadata
        };
        appState.globalTotalVotes = globalValidVotes; 
    }

    function loadData(file, uiName, pushState = true) {
        dom.content.innerHTML = `<div class="loading-state">Ê≠£Âú®ËºâÂÖ• ${uiName} ÂÆåÊï¥Êï∏Êìö...</div>`;
        
        appState.electionName = uiName;
        
        fetch(file) 
            .then(r => { 
                if(!r.ok) throw new Error("Ê™îÊ°àËÆÄÂèñÂ§±ÊïóÔºåË´ãÊ™¢Êü•Ê™îÊ°àÂêçÁ®±ËàáË∑ØÂæë„ÄÇ"); 
                return r.text(); 
            })
            .then(csvText => {
                parseCSV(csvText);
                appState.sortConfig = { key: 'number', direction: 'asc' }; 
                appState.chartInstances.forEach(chart => chart.destroy()); 
                appState.chartInstances = [];
                renderCounty(true, pushState); 
            })
            .catch(error => {
                console.error("ËºâÂÖ•ÈåØË™§:", error);
                dom.content.innerHTML = `<div class="loading-state" style="color:red">ËÆÄÂèñ ${file} Â§±Êïó: ${error.message}<br>Ë´ãÊ™¢Êü•Ê™îÊ°àÊòØÂê¶‰∏äÂÇ≥ÊàêÂäü„ÄÇ</div>`;
            });
    }
    
    function extractCountySummary(text) {
        const rows = text.split('\n').map(r => r.trim()).filter(r => r).map(r => r.split(','));

        if (rows.length < 4) return null;

        const headerRowIndices = []; 
        let currentIdx = 2;
        while(rows[0][currentIdx] && rows[1][currentIdx]) {
            headerRowIndices.push(currentIdx);
            currentIdx++;
        }
        
        const seatsCount = rows[1] && rows[1][0] ? rows[1][0].trim() : "";
        
        const VOTES_COL = currentIdx; 
        const INVALID_COL = currentIdx + 1;
        const ELIGIBLE_COL = currentIdx + 2;

        const candInfo = [];
        let independentCounter = 1;
        
        headerRowIndices.forEach(colIndex => {
            const number = rows[0][colIndex] ? rows[0][colIndex].trim() : '';
            let name = rows[1][colIndex] ? rows[1][colIndex].trim() : '';
            let party = rows[2][colIndex] ? rows[2][colIndex].trim() : '';
            
            const isWomenQuota = name.includes('*!');
            const isIncumbent = name.includes('#');
            const isWinner = name.includes('*') || isWomenQuota; 
            
            name = name.replace('*!', '').replace('*', '').replace('#', '').trim(); 
            party = party === 'ÁÑ°' ? 'ÁÑ°Èª®Á±ç' : party;

            if (name && number) {
                 if (party === 'ÁÑ°Èª®Á±ç') {
                    if (!partyColors[`ÁÑ°Èª®Á±ç-${independentCounter}`] && independentCounter <= 4) {
                       partyColors[`ÁÑ°Èª®Á±ç-${independentCounter}`] = partyColors['ÁÑ°Èª®Á±ç']; 
                    }
                    party = `ÁÑ°Èª®Á±ç-${independentCounter}`;
                    independentCounter++;
                }
                candInfo.push({ number: String(number), name, party, colIndex, isWinner, isWomenQuota, isIncumbent }); 
            }
        });
        
        const candidates = {}; 
        let globalValidVotes = 0; 
        let globalInvalidVotes = 0; 
        let globalEligibleVoters = 0; 
        
        for (let i = 3; i < rows.length; i++) {
            const row = rows[i];
            
            if (row.length < (ELIGIBLE_COL + 1) || !row[0] || row[0].includes("ÈÑâÈéÆ")) continue;

            const parseNum = (val) => parseInt(String(val).replace(/[^0-9]/g, '')) || 0;

            const validVotes = parseNum(row[VOTES_COL]); 
            const invalidVotes = parseNum(row[INVALID_COL]); 
            const eligibleVoters = parseNum(row[ELIGIBLE_COL]); 
            
            globalValidVotes += validVotes;
            globalInvalidVotes += invalidVotes;
            globalEligibleVoters += eligibleVoters;
            
            candInfo.forEach(c => {
                const votes = parseNum(row[c.colIndex]);
                if (!candidates[c.name]) candidates[c.name] = { number: c.number, party: c.party, votes: 0, isWinner: c.isWinner, isWomenQuota: c.isWomenQuota, isIncumbent: c.isIncumbent }; 
                candidates[c.name].votes += votes;
            });
        }
        
        let allCandidatesList = Object.keys(candidates).map(key => ({ name: key, ...candidates[key] }));
        
        return {
            allCandidates: allCandidatesList,
            metadata: {
                validVotes: globalValidVotes,
                invalidVotes: globalInvalidVotes,
                eligibleVoters: globalEligibleVoters,
                seatsCount: seatsCount 
            }
        };
    }
    
    async function loadAllElectionSummaries(elections) {
        const summaryPromises = elections.map(async e => {
            try {
                const response = await fetch(e.file);
                if (!response.ok) throw new Error("Ê™îÊ°àËÆÄÂèñÂ§±ÊïóÔºåË´ãÊ™¢Êü•Ê™îÊ°àÂêçÁ®±ËàáË∑ØÂæë„ÄÇ");
                const csvText = await response.text();
                
                const summary = extractCountySummary(csvText);
                
                if (summary) {
                    const initialSortConfig = { key: 'number', direction: 'asc' };
                    const sortedAllCands = getSortedCandidatesFromList(summary.allCandidates, initialSortConfig);
                    
                    e.summaryData = {
                        allCandidates: sortedAllCands,
                        metadata: summary.metadata,
                        topCandidates: sortedAllCands.slice(0, 3),
                        sortConfig: initialSortConfig 
                    };
                    
                } else {
                    e.summaryData = null;
                }
            } catch (error) {
                console.error(`ËºâÂÖ• ${e.file} ÊëòË¶ÅÂ§±Êïó:`, error.message);
                e.summaryData = null; 
            }
            return e;
        });

        await Promise.all(summaryPromises);
    }

    // ================= ÊéíÂ∫èËàáÊõ¥Êñ∞ÈÇèËºØ =================
    
    window.sortTable = function(key) {
        
        const currentKey = appState.sortConfig.key;
        const currentDirection = appState.sortConfig.direction;
        
        let newDirection = 'desc'; 
        
        if (key === 'number' || key === 'name' || key === 'party') {
             newDirection = 'asc'; 
        }

        if (currentKey === key) {
            newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
        }

        appState.sortConfig = { key: key, direction: newDirection };

        if (appState.currentLevel === 'county') {
            renderCounty(false, false); 
        } else if (appState.currentLevel === 'town') {
            renderTown(appState.currentTown, false, false); 
        }
    };
    
    window.sortTableInCard = function(cardId, key) {
        
        const election = availableElections.find(e => `summary-${e.file.replace(/[^a-zA-Z0-9]/g, '-')}` === cardId);

        if (!election || !election.summaryData) return;
        
        let { sortConfig, allCandidates, metadata } = election.summaryData;
        
        const currentKey = sortConfig.key;
        const currentDirection = sortConfig.direction;
        
        let newDirection = 'desc'; 
        
        if (key === 'number' || key === 'name' || key === 'party') {
             newDirection = 'asc'; 
        }

        if (currentKey === key) {
            newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
        }

        sortConfig = { key: key, direction: newDirection }; 
        election.summaryData.sortConfig = sortConfig; 

        const sortedList = getSortedCandidatesFromList(allCandidates, sortConfig);
        
        const isPartyList = isPartyListElection(election.uiName);
        
        // Pass election year to updateTableContent
        updateTableContent(cardId, sortedList, metadata.validVotes, true, election.year, isPartyList); 
        
        updateSortIconsInCard(cardId, sortConfig);
    };

    function getSortedCandidates(candObj) {
        let list = Object.keys(candObj).map(key => ({ name: key, ...candObj[key] }));
        const { key, direction } = appState.sortConfig;
        
        list.sort((a, b) => {
            let valA = a[key], valB = b[key];

            if (key === 'number' || key === 'votes') { 
                valA = parseInt(valA) || 0; 
                valB = parseInt(valB) || 0;
            } else if (typeof valA === 'string') {
                 valA = valA.toLowerCase();
                 valB = valB.toLowerCase();
            }

            let comparison = 0;
            if (valA < valB) {
                comparison = -1;
            } else if (valA > valB) {
                comparison = 1;
            }

            return direction === 'asc' ? comparison : comparison * -1;
        });
        
        return list;
    }
    
    function getSortedCandidatesFromList(list, sortConfig = { key: 'votes', direction: 'desc' }) {
        let { key, direction } = sortConfig;
        
        list.sort((a, b) => {
            let valA = a[key], valB = b[key];

            if (key === 'number' || key === 'votes') { 
                valA = parseInt(valA) || 0; 
                valB = parseInt(valB) || 0;
            } else if (typeof valA === 'string') {
                 valA = valA.toLowerCase();
                 valB = valB.toLowerCase();
            }

            let comparison = 0;
            if (valA < valB) {
                comparison = -1;
            } else if (valA > valB) {
                comparison = 1;
            }

            return direction === 'asc' ? comparison : comparison * -1;
        });
        
        return list;
    }
    
    /**
     * ÁîüÊàêË°®Ê†ºÂÖßÂÆπ HTML (Â∏∂ÊúâÂãïÁï´Â±¨ÊÄß)
     * *** ‰øÆÊîπÔºöÁßªÈô§È°èËâ≤Âà§Êñ∑ÔºåÁõ¥Êé•‰ΩøÁî® c.party (ÂÅáË®≠ CSV Ë≥áÊñôÂ∑≤Áµ±‰∏Ä) ***
     */
    function generateTableBodyHTML(candidates, validVotes, animate, currentElectionYear, isPartyList) {
        return candidates.map(c => {
            const rate = validVotes > 0 ? (c.votes / validVotes * 100).toFixed(2) : 0;
            
            // Áî±Êñº CSV Ë≥áÊñôÂ∑≤Áµ±‰∏ÄÔºåÁõ¥Êé•Âæû c.party ÂèñÂæóÈ°èËâ≤
            const partyColorHex = getPartyColor(c.party); 
            
            const rgb = hexToRgb(partyColorHex);
            const lightColorRGBA = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.30)`; 
            
            const rowStyle = `
                background-image: linear-gradient(
                    to right, 
                    ${lightColorRGBA} 0%, 
                    ${lightColorRGBA} 100%
                );
                --bar-width: ${rate}%;
            `;
            
            const animateClass = animate ? 'animate-bar-grow' : '';
            const badgeClass = c.isWinner ? 'number-badge is-winner' : 'number-badge'; 
            const partyLongName = getLongPartyName(c.party); 
            const partyShortName = getShortPartyName(c.party);
            
            const womenQuotaBadge = c.isWomenQuota 
                ? '<div class="women-quota-badge">Â©¶Â•≥‰øùÈöúÂêçÈ°ç</div>' 
                : '';
                
            const incumbentBadge = c.isIncumbent 
                ? '<span class="incumbent-badge">Áèæ</span>' 
                : '';
            
            // Ëã•ÁÇ∫ÊîøÈª®Á•®ÔºåÂèñÊ∂àÈªûÊìä‰∫ã‰ª∂Ôºå‰∏¶ÂèñÊ∂àÈÄ£ÁµêÊ®£Âºè (ÊîøÈª®‰∏çÊáâË©≤Êúâ modal)
            const nameClickAction = isPartyList ? 'event.stopPropagation()' : `event.stopPropagation(); showCandidateModal('${c.name}', '${currentElectionYear || ''}')`;
            const nameLinkClass = isPartyList ? 'candidate-name' : 'candidate-name candidate-link';
            
            // Ëã•ÁÇ∫ÊîøÈª®Á•®ÔºåÈö±ËóèÊîøÈª® Cell (col-party)
            const partyCellClass = isPartyList ? 'col-party hidden-party' : 'party-cell col-party';
            const partyCellHtml = `
                <td class="${partyCellClass}">
                    <span class="party-badge party-long" style="background:${partyColorHex}">${partyLongName}</span>
                    <span class="party-badge party-short" style="background:${partyColorHex}">${partyShortName}</span>
                </td>
            `;

            return `
                <tr style="${rowStyle}" class="${animateClass}">
                    <td class="number-cell col-number">
                        <span class="${badgeClass}">${c.number}</span>
                    </td>
                    <td>
                        <span class="${nameLinkClass}" onclick="${nameClickAction}">
                            ${c.name}${incumbentBadge}
                        </span>
                        ${womenQuotaBadge}
                    </td>
                    ${partyCellHtml}
                    <td style="text-align:right">${c.votes.toLocaleString()}</td>
                    <td style="text-align:right;">${rate}%</td> </tr>
            `;
        }).join('');
    }
    
    /**
     * Êõ¥Êñ∞Ë°®Ê†ºÂÖßÂÆπ (Áî®ÊñºÊéíÂ∫è/Êõ¥Êñ∞ÊôÇ)
     * *** ‰øÆÊîπÔºöÊé•Êî∂ currentElectionYear Ëàá isPartyList ***
     */
    function updateTableContent(cardId, candidates, validVotes, triggerAnimation = false, currentElectionYear, isPartyList = false) {
        const mainTableBody = document.querySelector(`#card-${cardId} table tbody`); 
        if (mainTableBody) {
            mainTableBody.innerHTML = generateTableBodyHTML(candidates, validVotes, triggerAnimation, currentElectionYear, isPartyList);
        }
    }
    
    function updateSortIcons() {
        const { key, direction } = appState.sortConfig;
        document.querySelectorAll('th .sort-icon').forEach(icon => {
            const iconKey = icon.getAttribute('data-key');
            icon.className = 'sort-icon'; 
            if (iconKey === key) {
                icon.classList.add(direction); 
            }
        });
    }

    function updateSortIconsInCard(cardId, sortConfig) {
        const { key, direction } = sortConfig;
        const cardElement = document.getElementById(`card-${cardId}`);
        if (!cardElement) return;

        cardElement.querySelectorAll('th .sort-icon').forEach(icon => {
            const iconKey = icon.getAttribute('data-key');
            icon.className = 'sort-icon'; 
            if (iconKey === key) {
                icon.classList.add(direction); 
            }
        });
    }

    // ================= È†ÅÈù¢Ê∏≤ÊüìÂáΩÂºè =================
    
    function generateSummaryCardHTML(election) {
        if (!election.summaryData) {
            return `<div class="card failed">
                <div class="card-title">${election.uiName}</div>
                <div class="card-stats" style="color:red; margin-left:0;">Ë≥áÊñôËºâÂÖ•Â§±ÊïóÊàñÊ™îÊ°àÈÅ∫Â§±„ÄÇ</div>
            </div>`;
        }
        const { allCandidates, metadata, sortConfig } = election.summaryData;
        const cardId = `summary-${election.file.replace(/[^a-zA-Z0-9]/g, '-')}`;

        return generateCardHTML(
            cardId, 
            election.uiName, 
            allCandidates, 
            metadata, 
            true, 
            `loadData('${election.file}', '${election.uiName}', true)`, 
            true, 
            true,  
            sortConfig,
            true,
            election.year // *** Pass year ***
        );
    }

	window.renderMainMenu = function(pushState = true) { 
        
        const url = `?view=main`;
        const state = { view: 'main' };
        updateUrl(state, "ÈáëÈñÄÈÅ∏ËàâË≥áÊñôÂ∫´ - È¶ñÈ†Å", url, pushState); 

        appState.currentLevel = 'mainMenu';
        
        // [‰øÆÊîπ] Êç≤ÂãïÈÇèËºØÔºöÂ¶ÇÊûúÊòØ‰∏ä‰∏ÄÈ†Å(pushState=false)ÔºåÂâáÊÅ¢Âæ©Ë®òÊÜ∂ÁöÑ‰ΩçÁΩÆ
        if (pushState) {
            window.scrollTo(0, 0); 
        } else {
            const savedY = (history.state && history.state.scrollY) ? history.state.scrollY : 0;
            setTimeout(() => window.scrollTo(0, savedY), 0);
        }

        updateBreadcrumb(); 
        
        appState.chartInstances.forEach(chart => chart.destroy()); 
        appState.chartInstances = [];
        
        let html = '';

        html += `<div class="main-section">
            <div class="menu-section-title">‰æùÈÅ∏ËàâÈ°ûÂà•ÁÄèË¶Ω</div>
            <div class="main-menu-grid">`;
        
    electionCategories.forEach(cat => {
        // Âà§Êñ∑ÔºöÂ¶ÇÊûúÊòØÂÖ¨Ê∞ëÊäïÁ•®ÔºåÈªûÊìäÊôÇÂü∑Ë°å renderReferendumSubMenuÔºåÂê¶ÂâáÁ∂≠ÊåÅÂéüÊ®£
        const clickAction = cat.type === 'ÂÖ¨Ê∞ëÊäïÁ•®' 
            ? `renderReferendumSubMenu(true)` 
             : `renderElectionList('${cat.type}', true)`;

        html += `<div class="menu-button" onclick="${clickAction}">
            <span class="menu-icon">${cat.icon}</span>
            <span class="menu-text">${cat.type}</span>
        </div>`;
    });

        html += `</div></div>`;

        const recentElections = [...availableElections].sort((a, b) => {
            const yearA = parseInt(a.year);
            const yearB = parseInt(b.year);
            if (yearA !== yearB) {
                return yearB - yearA; 
            }
            return a.uiName.localeCompare(b.uiName, 'zh-TW');

        }).slice(0, 8); 

        if (recentElections.length > 0) {
            html += `<div class="main-section">
                <div class="menu-section-title">ËøëÊúüÈÅ∏Ëàâ</div>
                <div class="election-list-grid">`;
            
            recentElections.forEach(e => {
                html += generateSummaryCardHTML(e);
            });
            html += `</div></div>`;
        }

        dom.content.innerHTML = html;
    };

    // ================= Êñ∞Â¢ûÔºöÂÖ¨ÊäïÂ≠êÈÅ∏ÂñÆÊ∏≤Êüì =================

    window.renderReferendumSubMenu = function(pushState = true) {
        
        const url = `?view=referendumMenu`;
        const state = { view: 'referendumMenu' };
        updateUrl(state, "ÈáëÈñÄÈÅ∏ËàâË≥áÊñôÂ∫´ - ÂÖ¨Ê∞ëÊäïÁ•®È°ûÂà•", url, pushState); 

        appState.currentLevel = 'referendumMenu'; // Ë®≠ÂÆö‰∏ÄÂÄãÊñ∞ÁöÑÂ±§Á¥öÁãÄÊÖã
        
        if (pushState) {
            window.scrollTo(0, 0); 
        } else {
            const savedY = (history.state && history.state.scrollY) ? history.state.scrollY : 0;
            setTimeout(() => window.scrollTo(0, savedY), 0);
        }

        updateBreadcrumb(); 
        
        // Ê∏ÖÁ©∫ËàäÂúñË°®
        appState.chartInstances.forEach(chart => chart.destroy()); 
        appState.chartInstances = [];
        
        let html = '';

        html += `<div class="main-section">
            <div class="menu-section-title">Ë´ãÈÅ∏ÊìáÂÖ¨ÊäïÈ°ûÂà•</div>
            <div class="main-menu-grid">
                
                <div class="menu-button" onclick="renderElectionList('ÂÖ®ÂúãÊÄßÂÖ¨Ê∞ëÊäïÁ•®', true)">
                    <span class="menu-icon">üáπüáº</span>
                    <span class="menu-text">ÂÖ®ÂúãÊÄßÂÖ¨Ê∞ëÊäïÁ•®</span>
                </div>

                <div class="menu-button" onclick="renderElectionList('Âú∞ÊñπÊÄßÂÖ¨Ê∞ëÊäïÁ•®', true)">
                    <span class="menu-icon">üèùÔ∏è</span>
                    <span class="menu-text">Âú∞ÊñπÊÄßÂÖ¨Ê∞ëÊäïÁ•®</span>
                </div>

            </div>
        </div>`;

        dom.content.innerHTML = html;
    };
    
	window.renderElectionList = function(type, pushState = true) { 
        
        const url = `?view=list&type=${encodeURIComponent(type)}`;
        const state = { view: 'list', type: type };
        updateUrl(state, `ÈáëÈñÄÈÅ∏ËàâË≥áÊñôÂ∫´ - ${type} ÂàóË°®`, url, pushState); 

        appState.currentLevel = 'electionList';
        appState.currentTown = type; 

        // [‰øÆÊîπ] Êç≤ÂãïÈÇèËºØ
        if (pushState) {
            window.scrollTo(0, 0); 
        } else {
            const savedY = (history.state && history.state.scrollY) ? history.state.scrollY : 0;
            setTimeout(() => window.scrollTo(0, savedY), 0);
        }

        updateBreadcrumb(); 
        
        appState.chartInstances.forEach(chart => chart.destroy()); 
        appState.chartInstances = [];

        const matchingElections = availableElections.filter(e => e.type === type);
        matchingElections.sort((a, b) => {
             const yearA = parseInt(a.year);
             const yearB = parseInt(b.year);
             if (yearA !== yearB) {
                 return yearB - yearA; 
             }
             return a.uiName.localeCompare(b.uiName, 'zh-TW'); 
        });

        let html = `<div class="main-section">
            <div class="menu-section-title">${type} ÈÅ∏ËàâÂàóË°®</div>
        </div>`;
        
        if (matchingElections.length > 0) {
            html += `<div class="election-list-grid">`;
            matchingElections.forEach(e => {
                html += generateSummaryCardHTML(e); 
            });
            html += `</div>`;
        } else {
             html += `<div class="loading-state" style="padding:40px;">Ë©≤È°ûÂà•ÁõÆÂâçÁÑ°Ë≥áÊñôÂèØ‰æõÊü•Ë©¢„ÄÇ</div>`;
        }

        dom.content.innerHTML = html;
    };

	window.renderCounty = function(shouldScroll = true, pushState = true) {
        const candidates = getSortedCandidates(appState.data.county); 
        const metadata = appState.countyMetadata;
        const currentElectionObj = availableElections.find(e => e.uiName === appState.electionName);
        const currentYear = currentElectionObj ? currentElectionObj.year : "";
        const shouldRenderTowns = !isElectionWithoutTowns(appState.electionName);
        
        // *** Âà§Êñ∑ÊòØÂê¶ÁÇ∫ÊîøÈª®Á•® ***
        const isPartyList = isPartyListElection(appState.electionName);
        
        // Â¶ÇÊûúÂè™ÊòØÂàáÊèõÊéíÂ∫è(shouldScroll=false)Ôºå‰∏çÂü∑Ë°åÊç≤ÂãïÈÇèËºØ
        if (!shouldScroll) {
            updateTableContent('county-main', candidates, metadata.validVotes, true, currentYear, isPartyList);
            
            if (shouldRenderTowns) {
                appState.data.townOrder.forEach(town => {
                    const townData = appState.data.towns[town];
                    const townCands = getSortedCandidates(townData.candidates);
                    updateTableContent(`town-${town}`, townCands, townData.validVotes, true, currentYear, isPartyList);
                });
            }
            updateSortIcons(); 
            return; 
        }

        if (pushState) {
            const url = `?view=county&election=${encodeURIComponent(appState.electionName)}`;
            const state = { view: 'county', election: appState.electionName };
            updateUrl(state, `ÈáëÈñÄÈÅ∏ËàâË≥áÊñôÂ∫´ - ${appState.electionName}`, url, pushState);
        }
        
        appState.currentLevel = 'county';
        appState.currentTown = null;
        
        // [‰øÆÊîπ] Êç≤ÂãïÈÇèËºØ
        if (pushState) {
            window.scrollTo(0, 0); 
        } else {
            const savedY = (history.state && history.state.scrollY) ? history.state.scrollY : 0;
            setTimeout(() => window.scrollTo(0, savedY), 0);
        }

        updateBreadcrumb();

        let html = `<div class="main-section">
            <div class="section-header"><span class="section-title">${appState.electionName}</span></div>
            <div class="top-summary-grid">
                ${generateSummaryPanelHTML(candidates, metadata, "ÂÖ®Á∏£")}
                ${generateCardHTML('county-main', 'ÂÖ®Á∏£ÈñãÁ•®ÁµêÊûú', candidates, metadata, false, false, true, false, null, true, currentYear)} </div>
        </div>`;

        if (shouldRenderTowns) {
            html += `<div class="main-section">
                <div class="section-header"><span class="section-title">ÂêÑÈÑâÈéÆÈñãÁ•®ÁµêÊûú</span><span class="section-badge">ÈªûÊìäÂç°ÁâáÁúãÁ¥∞ÁØÄ</span></div>
                <div class="sub-area-grid">`;
            
            appState.data.townOrder.forEach(town => {
                const townData = appState.data.towns[town];
                const townCands = getSortedCandidates(townData.candidates);
                
                const townMetadata = {
                    validVotes: townData.validVotes,
                    invalidVotes: townData.invalidVotes,
                    eligibleVoters: townData.eligibleVoters
                };

                html += generateCardHTML(`town-${town}`, town, townCands, townMetadata, true, `renderTown('${town}', true, true)`, true, false, null, true, currentYear);
            });
            html += `</div></div>`;
        }

        dom.content.innerHTML = html;
        updateSortIcons();
    };

	window.renderTown = function(townName, shouldScroll = true, pushState = true) {
        const townData = appState.data.towns[townName];
        const candidates = getSortedCandidates(townData.candidates);
        const townMetadata = {
            validVotes: townData.validVotes,
            invalidVotes: townData.invalidVotes,
            eligibleVoters: townData.eligibleVoters,
            // *** Êñ∞Â¢ûÔºöÂ∞áÈÅ∏ËàâÂêçÁ®±ËàáÊó•ÊúüÂÇ≥ÈÅûÁµ¶ÈÑâÈéÆ Metadata ***
            electionNameFromCSV: appState.countyMetadata.electionNameFromCSV,
            electionDateFromCSV: appState.countyMetadata.electionDateFromCSV
        };
        const currentElectionObj = availableElections.find(e => e.uiName === appState.electionName);
        const currentYear = currentElectionObj ? currentElectionObj.year : "";
        
        // *** Âà§Êñ∑ÊòØÂê¶ÁÇ∫ÊîøÈª®Á•® ***
        const isPartyList = isPartyListElection(appState.electionName);
        
        // Â¶ÇÊûúÂè™ÊòØÂàáÊèõÊéíÂ∫è(shouldScroll=false)Ôºå‰∏çÂü∑Ë°åÊç≤ÂãïÈÇèËºØ
        if (!shouldScroll) {
            updateTableContent('town-main', candidates, townMetadata.validVotes, true, currentYear, isPartyList);
            
            const shouldRenderVillages = !isElectionWithoutVillages(appState.electionName); 
            if (shouldRenderVillages) {
                const villageList = Object.keys(townData.villages);
                villageList.forEach(village => {
                    const vData = townData.villages[village];
                    const vCands = getSortedCandidates(vData.candidates);
                    updateTableContent(`village-${village}`, vCands, vData.validVotes, true, currentYear, isPartyList);
                });
            }
            updateSortIcons(); 
            return; 
        }
        
        if (pushState) {
            const url = `?view=town&election=${encodeURIComponent(appState.electionName)}&town=${encodeURIComponent(townName)}`;
            const state = { view: 'town', election: appState.electionName, town: townName };
            updateUrl(state, `ÈáëÈñÄÈÅ∏ËàâË≥áÊñôÂ∫´ - ${appState.electionName} (${townName})`, url, pushState);
        }
        
        appState.currentLevel = 'town';
        appState.currentTown = townName;
        
        // [‰øÆÊîπ] Êç≤ÂãïÈÇèËºØ
        if (pushState) {
            window.scrollTo(0, 0); 
        } else {
            const savedY = (history.state && history.state.scrollY) ? history.state.scrollY : 0;
            setTimeout(() => window.scrollTo(0, savedY), 0);
        }
        
        updateBreadcrumb();
        
        appState.chartInstances.forEach(chart => chart.destroy()); 
        appState.chartInstances = [];
        
        const villageList = Object.keys(townData.villages);

        let html = `<div class="main-section">
            <div class="section-header"><span class="section-title">${townName} Á∏ΩË®à</span></div>
            <div class="top-summary-grid">
                ${generateSummaryPanelHTML(candidates, townMetadata, townName)}
                ${generateCardHTML('town-main', `${townName}ÈñãÁ•®ÁµêÊûú`, candidates, townMetadata, false, false, true, false, null, true, currentYear)} </div>
        </div>`;
        
        const shouldRenderVillages = !isElectionWithoutVillages(appState.electionName); 

        if (shouldRenderVillages) { 
            html += `<div class="main-section">
                <div class="section-header"><span class="section-title">ÂêÑÊùëÈáåÈñãÁ•®ÁµêÊûú</span></div>
                <div class="sub-area-grid">`;
            
            villageList.forEach(village => {
                const vData = townData.villages[village];
                const vCands = getSortedCandidates(vData.candidates);
                
                const villageMetadata = {
                    validVotes: vData.validVotes,
                    invalidVotes: vData.invalidVotes,
                    eligibleVoters: vData.eligibleVoters
                };

                html += generateCardHTML(`village-${village}`, village, vCands, villageMetadata, false, null, true, false, null, true, currentYear);
            });
            html += `</div></div>`; 
        }

        dom.content.innerHTML = html;
        updateSortIcons();
    };

    function updateBreadcrumb() {
        const level = appState.currentLevel;
        let html = '';

        if (level === 'mainMenu') {
            dom.breadcrumb.style.display = 'none';
            dom.breadcrumbBottom.style.display = 'none';
            return;
        }

        html += `<span onclick="renderMainMenu(true)">È¶ñÈ†Å</span> / `;

    // === Êñ∞Â¢ûÔºöÂÖ¨ÊäïÈÅ∏ÂñÆÂ±§Á¥ö ===
        if (level === 'referendumMenu') {
             html += `<span class="active">ÂÖ¨Ê∞ëÊäïÁ•®</span>`;
        } 
        // === ‰øÆÊîπÔºöÂéüÊú¨ÁöÑ electionList ÈÇèËºØ ===
        else if (level === 'electionList') {
            // Âà§Êñ∑ÊòØÂê¶ÁÇ∫ÂÖ¨ÊäïÁõ∏ÈóúÁöÑÈ°ûÂûã
            if (appState.currentTown === 'ÂÖ®ÂúãÊÄßÂÖ¨Ê∞ëÊäïÁ•®' || appState.currentTown === 'Âú∞ÊñπÊÄßÂÖ¨Ê∞ëÊäïÁ•®') {
                html += `<span onclick="renderReferendumSubMenu(true)">ÂÖ¨Ê∞ëÊäïÁ•®</span> / `;
                html += `<span class="active">${appState.currentTown}</span>`;
            } else {
                html += `<span class="active">${appState.currentTown}</span>`;
            }
        } 
        // === ‰øÆÊîπÔºöÂéüÊú¨ÁöÑ county ÈÇèËºØ (Âà§Êñ∑ÂÖ¨ÊäïÂõû‰∏ä‰∏ÄÈ†ÅÁöÑË∑ØÂæë) ===
        else if (level === 'county') {
            const currentEle = availableElections.find(e => e.uiName === appState.electionName);
            const electionType = currentEle ? currentEle.type : '';
            
            if (electionType === 'ÂÖ®ÂúãÊÄßÂÖ¨Ê∞ëÊäïÁ•®' || electionType === 'Âú∞ÊñπÊÄßÂÖ¨Ê∞ëÊäïÁ•®') {
                 html += `<span onclick="renderReferendumSubMenu(true)">ÂÖ¨Ê∞ëÊäïÁ•®</span> / `;
                 html += `<span onclick="renderElectionList('${electionType}', true)">${electionType}</span> / `;
            } else {
                 html += `<span onclick="renderElectionList('${electionType}', true)">${electionType}</span> / `;
            }
            html += `<span class="active">${appState.electionName}</span>`;
        } 
        // === ‰øÆÊîπÔºöÂéüÊú¨ÁöÑ town ÈÇèËºØ ===
        else if (level === 'town') {
             const currentEle = availableElections.find(e => e.uiName === appState.electionName);
             const electionType = currentEle ? currentEle.type : '';

             if (electionType === 'ÂÖ®ÂúãÊÄßÂÖ¨Ê∞ëÊäïÁ•®' || electionType === 'Âú∞ÊñπÊÄßÂÖ¨Ê∞ëÊäïÁ•®') {
                 html += `<span onclick="renderReferendumSubMenu(true)">ÂÖ¨Ê∞ëÊäïÁ•®</span> / `;
                 html += `<span onclick="renderElectionList('${electionType}', true)">${electionType}</span> / `;
             } else {
                 html += `<span onclick="renderElectionList('${electionType}', true)">${electionType}</span> / `;
             }
             html += `<span onclick="renderCounty(true, true)">${appState.electionName}</span> / `;
             html += `<span class="active">${appState.currentTown}</span>`;
        }

        dom.breadcrumb.innerHTML = html;
        dom.breadcrumb.style.display = 'block';
        dom.breadcrumbBottom.innerHTML = html;
        dom.breadcrumbBottom.style.display = 'block';
    }
    
	function generateSummaryPanelHTML(candidates, metadata, title) {
        const { validVotes, invalidVotes, eligibleVoters, electionNameFromCSV, electionDateFromCSV } = metadata;
        const totalBallots = validVotes + invalidVotes;
        const turnoutRate = eligibleVoters > 0 ? (totalBallots / eligibleVoters * 100).toFixed(2) : "0.00";
        
        // --- ‰øÆÊîπÈñãÂßã ---
        
        // 1. ËôïÁêÜÂâØÊ®ôÈ°å (ÈÅ∏ËàâÂêçÁ®±)ÔºöÁßªÂá∫ÂàóË°®ÔºåÁç®Á´ãË£Ω‰ΩúÊàêÊúâÈ°èËâ≤ÁöÑÂâØÊ®ô
        let subtitleHtml = '';
        if (electionNameFromCSV) {
            // style Ë®≠ÂÆöÔºö‰ΩøÁî®‰∏ªËâ≤Ë™ø(var(--primary))„ÄÅÂä†Á≤ó„ÄÅÈù†Â∑¶„ÄÅ‰∏ãÊñπÁïôÁôΩ
            subtitleHtml = `<div style="color: var(--primary); font-weight: 700; font-size: 16px; margin-bottom: 15px; text-align: left; line-height: 1.4;">${electionNameFromCSV}</div>`;
        }

        // 2. ËôïÁêÜÂàóË°®‰∏≠ÁöÑÈ°çÂ§ñÊ¨Ñ‰Ωç (Âè™‰øùÁïôÊäïÁ•®Êó•ÊúüÂú®ÂàóË°®ÂÖßÔºåÂ¶ÇÊûúÊúâÁöÑË©±)
        let extraRows = '';
        if (electionDateFromCSV) {
            extraRows += `<li><span>ÊäïÁ•®Êó•Êúü</span><span class="stat-value">${electionDateFromCSV}</span></li>`;
        }
        
        let html = `
        <div class="summary-panel">
            <h3>ÊäïÁ•®Ê¶ÇÊ≥Å (${title})</h3>
            ${subtitleHtml} <ul class="summary-list">
                ${extraRows}
                <li><span>ÊäïÁ•®Áéá</span><span class="stat-value" style="color:#d9534f;">${turnoutRate}%</span></li>
                <li><span>ÊúâÊïàÁ•®Êï∏</span><span class="stat-value">${validVotes.toLocaleString()} Á•®</span></li>
                <li><span>ÁÑ°ÊïàÁ•®Êï∏</span><span class="stat-value">${invalidVotes.toLocaleString()} Á•®</span></li>
                <li><span>ÈÅ∏Ëàâ‰∫∫Êï∏</span><span class="stat-value">${eligibleVoters.toLocaleString()} ‰∫∫</span></li>
            </ul>
        </div>`; 
        
        // --- ‰øÆÊîπÁµêÊùü ---

        return html;
    }

    /**
     * ÁîüÊàêÂç°Áâá HTML (ÈÄöÁî®Ê®°Êùø)
     * *** ‰øÆÊîπÔºöÊé•Êî∂ currentElectionYear ***
     */
    function generateCardHTML(id, title, candidates, metadata, isClickable, onClickAction, isCompact = false, isSummary = false, localSortConfig = null, triggerAnimation = false, currentElectionYear) {
        
        const clickClass = isClickable ? 'clickable' : '';
        const clickAttr = isClickable ? `onclick="event.stopPropagation(); ${onClickAction}"` : '';
        
        const actionText = isClickable ? `<span class="card-action">Êü•ÁúãË©≥ÊÉÖ ‚ûú</span>` : '';
        
        const summaryClass = isSummary ? 'is-summary' : '';
        
        const tableSizeClass = isCompact ? '' : ' large-table';
        
        const { validVotes, invalidVotes, eligibleVoters, seatsCount } = metadata;
        
        const totalBallots = validVotes + invalidVotes;
        const turnoutRate = eligibleVoters > 0 ? (totalBallots / eligibleVoters * 100).toFixed(2) : "0.00";

        let cardStatsHTML;
        if (isSummary || isCompact) {
             cardStatsHTML = `
                <div class="card-stats" style="margin-left: 0;">
                    <span style="white-space: nowrap;">
                        ÊúâÊïàÁ•®: ${validVotes.toLocaleString()} Á•® 
                        <span style="color:var(--text-sub); margin: 0 5px;">|</span>
                        ÊäïÁ•®Áéá: <span class="rate">${turnoutRate}%</span>
                    </span>
                </div>
            `;
        } else {
             cardStatsHTML = `
                <div class="card-stats">
                    <span style="font-size:14px;">ÊúâÊïàÁ•®: ${validVotes.toLocaleString()} Á•®</span> 
                    | ÁÑ°ÊïàÁ•®: ${invalidVotes.toLocaleString()} Á•® 
                    <br>
                    <span style="white-space: nowrap;">
                        ÈÅ∏Ëàâ‰∫∫Êï∏: ${eligibleVoters.toLocaleString()} ‰∫∫ 
                        | ÊäïÁ•®Áéá: <span class="rate">${turnoutRate}%</span>
                    </span>
                </div>
            `;
        }

        const currentConfig = isSummary ? localSortConfig : appState.sortConfig;
        const { key: currentSortKey, direction: currentSortDirection } = currentConfig;

        // *** Âà§Êñ∑ÊòØÂê¶ÁÇ∫ÊîøÈª®Á•® ***
        // 1. ÂÖàÁúã Card Title (ÈÅ©Áî®ÊñºÈ¶ñÈ†ÅÂàóË°®„ÄÅÂàÜÈ°ûÂàóË°®)
        let isPartyList = isPartyListElection(title);
        
        // 2. Â¶ÇÊûú Card Title ÊòØ "ÂÖ®Á∏£ÈñãÁ•®ÁµêÊûú" Êàñ "ÈáëÂüéÈéÆ" Á≠âÔºåÂâáÊ™¢Êü•ÂÖ®Âüü appState.electionName
        if (!isPartyList && appState.currentLevel !== 'mainMenu' && appState.currentLevel !== 'electionList') {
             isPartyList = isPartyListElection(appState.electionName);
        }

        function renderTableHeader(title, sortKey, style = '', className = '') {
            
            const isCurrentKey = currentSortKey === sortKey;
            const iconClass = isCurrentKey ? currentSortDirection : '';
            const iconHtml = `<span data-key="${sortKey}" class="sort-icon ${iconClass}"></span>`;
            
            let headerTextHtml = title;
            let finalClassName = className;

            if (sortKey === 'party') {
                headerTextHtml = `<span class="party-title-desktop">Êé®Ëñ¶ÊîøÈª®</span><span class="party-title-mobile">ÊîøÈª®</span>`;
                finalClassName = `${className} col-party`;
            } else if (sortKey === 'name' && isPartyList) {
                 headerTextHtml = `ÊîøÈª®`; // Â¶ÇÊûúÊòØÊîøÈª®Á•®ÔºåÂ∞á„ÄåÂÄôÈÅ∏‰∫∫„ÄçÊîπÁÇ∫„ÄåÊîøÈª®„Äç
            }

            // Â¶ÇÊûúÊòØÊîøÈª®Á•®Ôºå‰∏îË¶ÅÊ∏≤Êüì„ÄåÊé®Ëñ¶ÊîøÈª®„ÄçÊ¨Ñ‰ΩçÔºåÂâáÈö±ËóèË©≤Ê¨Ñ‰Ωç
            const headerClass = isPartyList && sortKey === 'party' ? 'col-party hidden-party' : finalClassName;


            const sortAction = isSummary 
                ? `sortTableInCard('${id}', '${sortKey}')` 
                : `sortTable('${sortKey}')`;
            
            return `<th style="${style}" class="${headerClass}" onclick="event.stopPropagation(); ${sortAction}">${headerTextHtml} ${iconHtml}</th>`;
        }
        
        // Pass currentElectionYear and isPartyList
        const tableBodyHTML = generateTableBodyHTML(candidates, validVotes, triggerAnimation, currentElectionYear, isPartyList);
        
        let footerHTML = '';
        if (seatsCount) {
             const displayStat = isNaN(Number(seatsCount)) ? seatsCount : `ÊáâÈÅ∏ ${seatsCount} Â∏≠`;
             footerHTML = `<div class="card-footer-info">${displayStat}</div>`;
        }
        
        // *** Ê†πÊìöÊòØÂê¶ÁÇ∫ÊîøÈª®Á•®ÔºåË™øÊï¥Ë°®È†≠Ê∏≤ÊüìÈ†ÜÂ∫èÂíåÂÖßÂÆπ ***
        
        return `
        <div class="card ${clickClass} ${summaryClass}" ${clickAttr} id="card-${id}">
            <div class="card-header">
                <div class="card-header-left">
                    <div class="card-title">${title}</div>
                    ${cardStatsHTML}
                </div>
                ${actionText}
            </div>
            <div class="table-area table-responsive">
                <table class="${tableSizeClass}">
                    <thead>
                        <tr>
                            ${renderTableHeader('#', 'number', 'width:40px; text-align:center;', 'col-number')} 
                            ${renderTableHeader('ÂÄôÈÅ∏‰∫∫', 'name', '', '')}
                            ${renderTableHeader('Êé®Ëñ¶ÊîøÈª®', 'party', '', 'col-party')}
                            ${renderTableHeader('ÂæóÁ•®', 'votes', 'text-align:right')}
                            ${renderTableHeader('%', 'votes', 'text-align:right; width:50px')}
                        </tr>
                    </thead>
                    <tbody>
                        ${tableBodyHTML}
                    </tbody>
                </table>
            </div>
            ${footerHTML}
        </div>`;
    }

    
    // ================= Ê≠∑Âè≤Ë®òÈåÑËôïÁêÜ =================
    
    function checkUrlAndRender(params, pushState = false) {
        
        let state = window.history.state;
        if (state && state.view) {
             params = state;
        }

        if (params.view === 'main') {
            renderMainMenu(pushState); 
        } 
        // === Êñ∞Â¢ûÔºöËôïÁêÜÂÖ¨ÊäïÈÅ∏ÂñÆÁöÑË∑ØÁî± ===
        else if (params.view === 'referendumMenu') {
            renderReferendumSubMenu(pushState);
        }
        // ==============================
        else if (params.view === 'list' && params.type) {
            renderElectionList(params.type, pushState);
        } else if (params.view === 'county' && params.election) {
            const election = availableElections.find(e => e.uiName === params.election);
            if (election) {
                loadData(election.file, election.uiName, pushState); 
            } else {
                renderMainMenu(pushState); 
            }
        } else if (params.view === 'town' && params.election && params.town) {
            const election = availableElections.find(e => e.uiName === params.election);
            if (election) {
                const file = election.file;
                const uiName = election.uiName;
                const townName = params.town;
                
                dom.content.innerHTML = `<div class="loading-state">Ê≠£Âú®ËºâÂÖ• ${uiName} ÂÆåÊï¥Êï∏Êìö (ÂõûÊ∫ØÂà∞ ${townName})...</div>`;
                
                appState.electionName = uiName;
                
                fetch(file) 
                    .then(r => { 
                        if(!r.ok) throw new Error("Ê™îÊ°àËÆÄÂèñÂ§±ÊïóÔºåË´ãÊ™¢Êü•Ê™îÊ°àÂêçÁ®±ËàáË∑ØÂæë„ÄÇ"); 
                        return r.text(); 
                    })
                    .then(csvText => {
                        parseCSV(csvText);
                        appState.sortConfig = { key: 'number', direction: 'asc' }; 
                        appState.chartInstances.forEach(chart => chart.destroy()); 
                        appState.chartInstances = [];
                        
                        renderTown(townName, true, false); 
                    })
                    .catch(error => {
                        console.error("ËºâÂÖ•ÈåØË™§:", error);
                        dom.content.innerHTML = `<div class="loading-state" style="color:red">ËÆÄÂèñ ${file} Â§±Êïó: ${error.message}<br>Ë´ãÊ™¢Êü•Ê™îÊ°àÊòØÂê¶‰∏äÂÇ≥ÊàêÂäü„ÄÇ</div>`;
                    });

            } else {
                renderMainMenu(pushState); 
            }
        } else {
            renderMainMenu(pushState); 
        }
    }
    
    window.onpopstate = function(event) {
        // popstate ÈóúÈñâ modal 
        document.getElementById('candidate-modal').classList.remove('active');
        document.body.style.overflow = '';

        if (event.state) {
             checkUrlAndRender(event.state, false); 
        } else {
             checkUrlAndRender(getCurrentUrlParams(), false);
        }
    };


    // ================= ÂàùÂßãÂåñ =================

    (function init() {
        dom.content.innerHTML = `<div class="loading-state">Ê≠£Âú®ËºâÂÖ•ÈÅ∏ËàâÊï∏Êìö...Ë´ãÁ®çÂÄô„ÄÇ</div>`;
        
        // *** ‰øÆÊîπÔºöÂàùÂßãÂåñÊôÇ‰πüËºâÂÖ• candidates.csv ***
        Promise.all([
            loadAllElectionSummaries(availableElections),
            loadCandidateData()
        ]).then(() => {
            
            const params = getCurrentUrlParams();
            
            if (params.view && params.view !== 'main') {
                 checkUrlAndRender(params, false); 
            } else {
                 const state = { view: 'main' };
                 updateUrl(state, "ÈáëÈñÄÈÅ∏ËàâË≥áÊñôÂ∫´ - È¶ñÈ†Å", "?view=main", false); 
                 renderMainMenu(false); 
            }
        });
    })();
</script>
</body>
</html>